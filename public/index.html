<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silver Care | Premium Nursing Agency</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Rozha+One&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-main: #fffdf5;
            --bg-panel: #ffffff;
            --primary: #ff9933;
            /* Saffron */
            --primary-hover: #e68a00;
            --accent: #138808;
            /* India Green */
            --text-dark: #1a1a1a;
            --text-muted: #666666;
            --navy: #003366;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-main);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(255, 153, 51, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(19, 136, 8, 0.05) 0%, transparent 20%);
            color: var(--text-dark);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Layout --- */
        .app-container {
            display: grid;
            grid-template-columns: 260px 1fr;
            min-height: 100vh;
        }

        /* --- Sidebar --- */
        .sidebar {
            background: var(--bg-panel);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.02);
            height: 100vh;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .logo {
            font-family: 'Rozha One', serif;
            font-size: 1.8rem;
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .nav-menu {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .nav-item {
            padding: 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #fff5e6;
            color: var(--primary-hover);
            border-left: 4px solid var(--primary);
        }

        /* --- Main Content --- */
        .main-content {
            padding: 2rem 3rem;
            overflow-y: auto;
            position: relative;
        }

        /* Views */
        .view-section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .view-section.active-view {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
        }

        .page-title h1 {
            font-family: 'Rozha One', serif;
            font-size: 2.5rem;
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .namaste-icon {
            color: var(--primary);
            font-size: 2rem;
        }

        .page-title p {
            color: var(--text-muted);
            font-size: 1rem;
            margin-top: 5px;
        }

        /* --- Buttons & Inputs --- */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #ff7700);
            color: white;
            border: none;
            padding: 0.8rem 1.8rem;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 15px rgba(255, 153, 51, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 153, 51, 0.4);
        }

        .btn-mode {
            background: var(--navy);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            border: none;
            cursor: pointer;
            margin-bottom: 1rem;
            width: 100%;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
            transition: 0.2s;
        }

        .btn-icon:hover {
            color: #ff4444;
        }

        /* --- Stats & Cards --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        /* TOAST STYLES */
        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            border-left: 5px solid #4caf50;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
            transform: translateX(0);
            transition: 0.3s;
        }

        .toast.error {
            border-left-color: #d32f2f;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-icon {
            font-size: 1.2rem;
        }

        .toast-msg {
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
        }

        .card {
            background: var(--bg-panel);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0, 0, 0, 0.02);
            transition: transform 0.3s ease;
        }

        .stat-card {
            border-top: 4px solid var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
            color: var(--navy);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* --- UPDATED CALENDAR & CHECKBOX CSS --- */

        /* Payroll Checkbox */
        .paid-checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
            /* Makes the tick orange */
            cursor: pointer;
        }

        /* Calendar Header */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cal-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid #eee;
            background: white;
            cursor: pointer;
            color: var(--navy);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .cal-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .current-date-display {
            text-align: center;
        }

        .cal-month {
            font-weight: 700;
            color: var(--navy);
            font-size: 1.1rem;
        }

        .cal-year {
            font-size: 0.8rem;
            color: #888;
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .cal-day-header {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: #aaa;
            text-transform: uppercase;
            padding-bottom: 5px;
        }

        .cal-day {
            aspect-ratio: 1;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
            color: #444;
            border: 1px solid #f4f4f4;
            font-weight: 500;
            transition: all 0.2s;
        }

        .cal-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: var(--primary);
            z-index: 2;
        }

        .cal-day.present {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
            font-weight: 700;
        }

        .cal-day.absent {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .cal-day.today {
            border: 2px solid var(--primary);
        }

        .cal-day.empty {
            background: transparent;
            border: none;
            pointer-events: none;
        }

        .icon-circle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            background: #fff5e6;
            color: var(--primary);
            font-size: 1.2rem;
        }

        /* Add/Update this in your <style> block */

        .nurse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            padding-bottom: 2rem;
        }

        .nurse-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            /* Soft shadow */
            border: 1px solid rgba(0, 0, 0, 0.04);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .nurse-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        .delete-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            opacity: 0;
            transition: 0.2s;
        }

        .nurse-card:hover .delete-btn {
            opacity: 1;
        }

        .nurse-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.2rem;
            padding-bottom: 1rem;
            border-bottom: 1px dashed #eee;
        }

        .nurse-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: var(--navy);
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .status-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-online {
            background: var(--accent);
        }

        .status-busy {
            background: #ff4444;
        }

        .status-offline {
            background: #ccc;
        }

        .nurse-info h3 {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--navy);
        }

        .metrics-row {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed #eee;
        }

        .metric-val {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
            text-align: center;
        }

        .metric-lbl {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            display: block;
            text-align: center;
        }

        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            color: var(--navy);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 0.8rem;
            border-radius: 8px;
            color: #333;
            outline: none;
        }

        .form-input:focus {
            border-color: var(--primary);
            background: #fff;
        }

        .close-modal {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* --- RATING STARS CSS --- */
        .star-row {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
        }

        .fa-star,
        .fa-star-half-stroke {
            color: #ffc107;
            /* Standard Gold Color */
            font-size: 0.8rem;
        }

        .rating-text {
            font-size: 0.75rem;
            color: #888;
            margin-left: 6px;
            font-weight: 500;
        }

        .new-badge {
            background: #f0f0f0;
            color: #666;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* --- Camera & Nurse App Specifics --- */
        .cam-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            margin-bottom: 1rem;
            border: 4px solid var(--navy);
        }

        video {
            width: 100%;
            height: 350px;
            object-fit: cover;
        }

        /* --- Payroll Table --- */
        .simple-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .simple-table th {
            text-align: left;
            padding: 1rem;
            background: #fff5e6;
            color: var(--navy);
            border-radius: 8px 8px 0 0;
        }

        .simple-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            font-size: 0.95rem;
        }

        /* --- Doc Locker Preview --- */
        .doc-box {
            border: 2px dashed #ccc;
            padding: 1rem;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            color: #777;
        }

        .doc-box:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .om-symbol {
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 10rem;
            opacity: 0.03;
            pointer-events: none;
            color: var(--primary);
            font-family: 'Rozha One', serif;
        }

        /* --- New Login UI Styles --- */
        .login-container {
            background: linear-gradient(135deg, #fffdf5 0%, #fff7e6 100%);
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Animated Background Shapes */
        .shape {
            position: absolute;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 10s infinite ease-in-out;
        }

        .shape-1 {
            top: -10%;
            right: -10%;
            width: 500px;
            height: 500px;
            background: #ff9933;
            animation-delay: 0s;
        }

        .shape-2 {
            bottom: -10%;
            left: -10%;
            width: 400px;
            height: 400px;
            background: #138808;
            animation-delay: 2s;
        }

        .shape-3 {
            top: 40%;
            left: 40%;
            width: 300px;
            height: 300px;
            background: #003366;
            opacity: 0.1;
            animation-delay: 4s;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(30px, 50px);
            }
        }

        /* Glass Card */
        .login-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 32px;
            padding: 4rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 51, 102, 0.15);
            position: relative;
            animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-logo {
            font-size: 4rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #ff9933, #003366);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: pulse 3s infinite;
        }

        /* Google Button */
        .google-btn {
            width: 100%;
            background: white;
            border: 2px solid #f0f0f0;
            padding: 1rem;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            color: #333;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 2rem;
            position: relative;
            overflow: hidden;
        }

        .google-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            border-color: #ff9933;
        }

        .google-btn:active {
            transform: scale(0.98);
        }

        /* Decorative Elements */
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #ddd, transparent);
            margin: 2rem 0;
            width: 100%;
        }

        .secure-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #f0f9ff;
            color: #003366;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 2rem;
        }

        /* Update .login-card width */
        .login-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 1);
            border-radius: 24px;
            padding: 3.5rem;
            /* More breathing room */
            width: 100%;
            max-width: 480px;
            /* Wider for desktop */
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        /* New Input Styles */
        .input-label {
            display: block;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
            color: #444;
            margin-bottom: 8px;
            margin-left: 4px;
        }

        .input-group {
            display: flex;
            gap: 0;
            /* Connected inputs */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            border-radius: 12px;
        }

        .modern-input {
            flex: 1;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-right: none;
            border-radius: 12px 0 0 12px;
            font-size: 1rem;
            outline: none;
            background: #fff;
            transition: 0.2s;
        }

        .modern-input:focus {
            border-color: var(--primary);
            background: #fffdf5;
        }

        .input-btn {
            border-radius: 0 12px 12px 0;
            padding: 0 1.5rem;
            margin: 0;
            box-shadow: none;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        /* Link Text */
        .link-text {
            font-size: 0.8rem;
            color: #666;
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.2s;
        }

        .link-text:hover {
            color: var(--primary);
        }

        /* Fix Divider */
        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 2rem 0;
            color: #aaa;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #eee;
        }

        .divider span {
            padding: 0 15px;
        }

        /* --- FIX: Hide Floating ReCAPTCHA Badge --- */
        .grecaptcha-badge {
            visibility: hidden;
        }

        /* 1. Make the overlay cover the WHOLE screen */
        .login-overlay {
            position: fixed;
            /* ðŸ‘ˆ This is the key */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            /* ðŸ‘ˆ Ensures it's above everything */
        }

        /* 2. Style the White Card inside */
        .login-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideUp 0.3s ease-out;
        }

        /* 3. Small animation to make it pop */
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* --- Profile Modal Styles --- */
        .profile-tabs {
            display: flex;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            flex: 1;
            border: none;
            background: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: 0.3s;
        }

        .tab-btn.active {
            background: white;
            color: var(--navy);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Calendar */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .cal-day-header {
            text-align: center;
            font-size: 0.75rem;
            color: #888;
            padding-bottom: 5px;
        }

        .cal-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.9rem;
            background: #f9f9f9;
            color: #ccc;
        }

        .cal-day.present {
            background: #e8f5e9;
            color: #2e7d32;
            font-weight: bold;
            border: 1px solid #c8e6c9;
        }

        .cal-day.absent {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .cal-day.today {
            border: 2px solid var(--primary);
        }

        /* Document Locker */
        .doc-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #fff;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .doc-icon {
            width: 40px;
            height: 40px;
            background: #e3f2fd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1565c0;
        }

        .btn-profile {
            width: 100%;
            margin-top: 10px;
            background: #e3f2fd;
            color: #1565c0;
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Add this to your CSS */
        .stat-card {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        /* --- WAR ROOM STYLES --- */
        .war-room-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .war-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #ccc;
            position: relative;
            overflow: hidden;
            transition: 0.3s;
        }

        .war-card.status-assigned {
            border-left-color: #ff9933;
        }

        .war-card.status-nurse_arrived {
            border-left-color: #2196F3;
        }

        .war-card.status-in_progress {
            border-left-color: #138808;
            background: #f1f8e9;
        }

        .war-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .war-timer {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.2rem;
            color: #138808;
            background: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #c8e6c9;
        }

        .war-body {
            padding: 1rem;
        }

        .war-step {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #555;
        }

        .war-step.active {
            color: #ff9933;
            font-weight: bold;
            animation: pulseText 1.5s infinite;
        }

        @keyframes pulseText {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .client-pill {
            background: #e3f2fd;
            color: #0d47a1;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            text-decoration: none;
        }

        /* --- VITALS LOG STYLES --- */
        .vitals-container {
            margin-top: 15px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .log-item {
            display: flex;
            gap: 10px;
            font-size: 0.85rem;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            align-items: flex-start;
        }

        .log-time {
            font-family: monospace;
            color: #999;
            font-size: 0.75rem;
            min-width: 50px;
        }

        .log-content {
            flex: 1;
            color: #444;
        }

        .log-critical {
            color: #c62828;
            background: #ffebee;
            padding: 2px 5px;
            border-radius: 4px;
            font-weight: bold;
        }

        .btn-report {
            background: #fff;
            border: 1px solid #138808;
            color: #138808;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-report:hover {
            background: #e8f5e9;
        }

        /* Add these to your existing CSS */

        /* Gray State for Completed Jobs */
        .war-card.status-completed {
            border-left-color: #757575;
            background: #f4f4f4;
            opacity: 0.8;
        }

        .war-card.status-completed .war-header h3 {
            color: #555;
            text-decoration: line-through;
        }

        .war-card.status-completed .war-step {
            color: #999;
        }

        .war-card.status-completed .btn-report {
            background: #333;
            color: #fff;
            border: none;
        }

        /* Improved Log Display */
        .log-item {
            display: flex;
            gap: 10px;
            font-size: 0.85rem;
            padding: 8px 0;
            border-bottom: 1px dashed #e0e0e0;
            align-items: flex-start;
        }

        .log-content {
            flex: 1;
            color: #333;
            line-height: 1.4;
        }

        .log-vitals-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #0d47a1;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
        }


        /* Plan Selector Styles */
        .plan-option.active {
            border-color: var(--primary) !important;
            background: #fff5e6 !important;
            color: var(--primary);
        }

        .plan-option:hover {
            background: #f9f9f9;
        }

        /* --- ENHANCED LOG CARD STYLES --- */
        .log-card {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
            border: 1px solid #f0f0f0;
            transition: transform 0.2s;
            align-items: center;
            gap: 1rem;
        }

        .log-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .log-time-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            border-right: 1px solid #eee;
            padding-right: 1rem;
        }

        .log-time-big {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--navy);
            line-height: 1;
        }

        .log-date-small {
            font-size: 0.7rem;
            color: #888;
            margin-top: 4px;
            text-transform: uppercase;
        }

        .log-photo-frame {
            position: relative;
            cursor: pointer;
        }

        .log-photo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .log-details {
            flex: 1;
        }

        .log-details h4 {
            color: #333;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .log-location {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            align-items: flex-start;
            gap: 6px;
            line-height: 1.4;
        }

        /* Image Viewer Modal */
        #img-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 20000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #img-viewer-full {
            max-width: 90%;
            max-height: 80vh;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .img-viewer-close {
            color: white;
            font-size: 2rem;
            position: absolute;
            top: 20px;
            right: 30px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="public-landing"
        style="background: linear-gradient(135deg, #fffdf5 0%, #fff7e6 100%); min-height: 100vh; display: flex; flex-direction: column;">

        <nav
            style="padding: 1rem 3rem; display: flex; justify-content: space-between; align-items: center; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000;">
            <div
                style="font-family: 'Rozha One', serif; font-size: 1.8rem; color: #003366; display: flex; align-items: center; gap: 10px;">
                <i class="fa-solid fa-hands-holding-circle" style="color: #ff9933;"></i> Silver Care
            </div>

            <div style="display: flex; align-items: center; gap: 30px;">
                <div style="display: flex; gap: 25px; font-weight: 500; font-size: 0.95rem;">
                    <a href="#" style="text-decoration: none; color: #003366;">Home</a>
                    <a href="#services" style="text-decoration: none; color: #666; transition: 0.3s;">Services</a>
                    <a href="#about" style="text-decoration: none; color: #666; transition: 0.3s;">About Us</a>
                    <a href="#contact" style="text-decoration: none; color: #666; transition: 0.3s;">Contact</a>
                </div>

                <button onclick="showLogin()" class="btn-primary"
                    style="padding: 0.6rem 1.5rem; font-size: 0.9rem; border-radius: 30px;">
                    Staff Login <i class="fa-solid fa-lock"></i>
                </button>
            </div>
        </nav>

        <div
            style="flex: 1; display: flex; align-items: center; justify-content: center; text-align: center; padding: 2rem;">
            <div style="max-width: 800px;">
                <span
                    style="background: #e3f2fd; color: #1565c0; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                    <i class="fa-solid fa-layer-group"></i> INDIA'S #1 AGENCY SOFTWARE
                </span>

                <h1
                    style="font-family: 'Rozha One', serif; font-size: 3.5rem; color: #003366; margin: 1.5rem 0; line-height: 1.2;">
                    The Operating System for <br><span style="color: #ff9933;">Nursing Agencies</span>
                </h1>

                <p
                    style="font-size: 1.1rem; color: #666; margin-bottom: 2.5rem; line-height: 1.6; max-width: 700px; margin-left: auto; margin-right: auto;">
                    Silver Care empowers nursing bureaus to automate staff attendance, streamline payroll, and manage
                    client bookings in real-time.
                    Stop using paper; start scaling your agency.
                </p>

                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="showLogin()" class="btn-primary"
                        style="padding: 1rem 2.5rem; font-size: 1.1rem; border-radius: 30px;">
                        Agency Login <i class="fa-solid fa-arrow-right-to-bracket"></i>
                    </button>

                    <button onclick="window.location.href='#contact'"
                        style="background:white; border:2px solid #003366; color:#003366; padding:1rem 2rem; border-radius:30px; font-weight:600; cursor:pointer; transition: 0.3s;">
                        Contact Sales
                    </button>
                </div>
            </div>
        </div>
        <div id="services" style="padding: 4rem 2rem; text-align: center; background: white;">
            <h2 style="color: #003366; font-family: 'Rozha One', serif; margin-bottom: 3rem;">Platform Features</h2>
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; max-width: 1100px; margin: 0 auto;">

                <div
                    style="padding: 2.5rem; border: 1px solid #eee; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); text-align: left;">
                    <div
                        style="width: 50px; height: 50px; background: #fff3e0; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem;">
                        <i class="fa-solid fa-users-viewfinder" style="font-size: 1.5rem; color: #ff9933;"></i>
                    </div>
                    <h3 style="color: #003366; margin-bottom: 10px; font-weight: 700;">Staff Verification</h3>
                    <p style="color: #666; font-size: 0.95rem; line-height: 1.6;">Digitize your staff records with
                        Aadhaar verification and document lockers. Keep your agency compliant and organized.</p>
                </div>

                <div
                    style="padding: 2.5rem; border: 1px solid #eee; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); text-align: left;">
                    <div
                        style="width: 50px; height: 50px; background: #e8f5e9; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem;">
                        <i class="fa-solid fa-location-dot" style="font-size: 1.5rem; color: #138808;"></i>
                    </div>
                    <h3 style="color: #003366; margin-bottom: 10px; font-weight: 700;">GPS Attendance</h3>
                    <p style="color: #666; font-size: 0.95rem; line-height: 1.6;">Real-time geolocation tracking for
                        nurse check-ins. Eliminate fake attendance and billing disputes instantly.</p>
                </div>

                <div
                    style="padding: 2.5rem; border: 1px solid #eee; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); text-align: left;">
                    <div
                        style="width: 50px; height: 50px; background: #e3f2fd; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem;">
                        <i class="fa-solid fa-file-invoice-dollar" style="font-size: 1.5rem; color: #1565c0;"></i>
                    </div>
                    <h3 style="color: #003366; margin-bottom: 10px; font-weight: 700;">Automated Payroll</h3>
                    <p style="color: #666; font-size: 0.95rem; line-height: 1.6;">Calculate daily wages, overtime, and
                        agency commissions with one click. Export reports for hassle-free payments.</p>
                </div>

            </div>
        </div>

        <div id="about" style="padding: 5rem 2rem; background: #fffdf5; text-align: center;">
            <div style="max-width: 900px; margin: 0 auto;">
                <span style="color: #ff9933; font-weight: 600; letter-spacing: 1px; font-size: 0.9rem;">OUR
                    MISSION</span>
                <h2 style="color: #003366; font-family: 'Rozha One', serif; margin: 10px 0 2rem 0; font-size: 2.5rem;">
                    Digitizing India's Healthcare Workforce</h2>

                <p style="font-size: 1.1rem; color: #555; line-height: 1.8; margin-bottom: 2rem;">
                    Silver Care is a technology partner for nursing bureaus and hospitals. We recognized that agency
                    owners spend too much time on paperwork
                    and not enough on patient care. Our platform provides the digital infrastructure to manage staff
                    efficiently, transparently, and professionally.
                </p>

                <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 3rem;">
                    <div
                        style="flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                        <h3 style="color: #138808; font-size: 2rem; font-weight: 700; margin-bottom: 5px;">50+</h3>
                        <p style="color: #666; font-size: 0.9rem;">Agencies Onboarded</p>
                    </div>
                    <div
                        style="flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                        <h3 style="color: #ff9933; font-size: 2rem; font-weight: 700; margin-bottom: 5px;">10k+</h3>
                        <p style="color: #666; font-size: 0.9rem;">Shifts Tracked</p>
                    </div>
                    <div
                        style="flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                        <h3 style="color: #003366; font-size: 2rem; font-weight: 700; margin-bottom: 5px;">100%</h3>
                        <p style="color: #666; font-size: 0.9rem;">Cloud Secure</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="contact" style="padding: 5rem 2rem; background: white; text-align: center;">
            <div style="max-width: 1000px; margin: 0 auto;">
                <h2 style="color: #003366; font-family: 'Rozha One', serif; margin-bottom: 3rem; font-size: 2.5rem;">Get
                    In Touch</h2>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem;">

                    <div
                        style="padding: 2rem; border: 1px solid #eee; border-radius: 16px; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.03);">
                        <div
                            style="width: 60px; height: 60px; background: #e3f2fd; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem auto;">
                            <i class="fa-solid fa-phone" style="font-size: 1.5rem; color: #1565c0;"></i>
                        </div>
                        <h3 style="color: #333; margin-bottom: 10px; font-weight: 600;">Call Us Anytime</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">Available 24/7 for emergencies.
                        </p>
                        <a href="tel:+918299341343"
                            style="color: #1565c0; font-weight: 700; text-decoration: none; font-size: 1.1rem;">+91
                            82993 41343</a>
                    </div>

                    <div
                        style="padding: 2rem; border: 1px solid #eee; border-radius: 16px; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.03);">
                        <div
                            style="width: 60px; height: 60px; background: #fff3e0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem auto;">
                            <i class="fa-solid fa-envelope" style="font-size: 1.5rem; color: #e65100;"></i>
                        </div>
                        <h3 style="color: #333; margin-bottom: 10px; font-weight: 600;">Email Us</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">For corporate or bulk bookings.
                        </p>
                        <a href="mailto:silvercare242@gmail.com"
                            style="color: #e65100; font-weight: 700; text-decoration: none; font-size: 1.1rem;">silvercare242@gmail.com</a>
                    </div>

                    <div
                        style="padding: 2rem; border: 1px solid #eee; border-radius: 16px; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.03);">
                        <div
                            style="width: 60px; height: 60px; background: #e8f5e9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem auto;">
                            <i class="fa-solid fa-location-dot" style="font-size: 1.5rem; color: #2e7d32;"></i>
                        </div>
                        <h3 style="color: #333; margin-bottom: 10px; font-weight: 600;">Visit Our Office</h3>
                        <p style="color: #666; font-size: 1rem; line-height: 1.5;">
                            Varanasi, Uttar Pradesh<br>India
                        </p>
                    </div>

                </div>
            </div>
        </div>




        <footer style="background: white; padding: 3rem; border-top: 1px solid #eee; margin-top: auto;">
            <div style="max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">

                <div>
                    <h4 style="color: #003366; margin-bottom: 1rem;">Contact Us</h4>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                        <i class="fa-solid fa-envelope"></i> silvercare242@gmail.com
                    </p>
                    <p style="color: #666; font-size: 0.9rem;">
                        <i class="fa-solid fa-phone"></i> +91 8299341343
                    </p>
                    <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">
                        <i class="fa-solid fa-location-dot"></i> Varanasi, Uttar Pradesh, India
                    </p>
                </div>

                <div style="text-align: right;">
                    <h4 style="color: #003366; margin-bottom: 1rem;">Legal</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                        <a href="terms.html" target="_blank"
                            style="color: #666; text-decoration: none; font-size: 0.9rem;">Terms & Conditions</a>
                        <a href="privacy.html" target="_blank"
                            style="color: #666; text-decoration: none; font-size: 0.9rem;">Privacy Policy</a>
                        <a href="refund.html" target="_blank"
                            style="color: #666; text-decoration: none; font-size: 0.9rem;">Refund & Cancellation
                            Policy</a>
                        <a href="pricing.html" target="_blank"
                            style="color: #666; text-decoration: none; font-size: 0.9rem;">Pricing</a>
                        <a href="contact.html" target="_blank"
                            style="color: #666; text-decoration: none; font-size: 0.9rem;">Contact Us</a>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px dashed #eee;">
                <p style="color: #003366; font-weight: 600; font-size: 0.9rem; margin-bottom: 5px;">
                    Silver Care is a product of Q-SENSE DYNAMICS PRIVATE LIMITED.
                </p>
                <p style="font-size: 0.8rem; color: #aaa;">
                    Â© 2025 Silver Care Technologies. All rights reserved.
                </p>
            </div>
        </footer>
    </div>

    <div id="login-overlay" class="login-container">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>

        <div class="login-card">
            <div class="secure-badge">
                <i class="fa-solid fa-shield-halved"></i> Secure Staff Portal
            </div>

            <h1 class="login-logo" style="font-family: 'Rozha One', serif;">Silver Care</h1>
            <p style="color: #555; font-size: 1rem; margin-bottom: 2.5rem;">
                Log in to manage staff, payroll, and bookings.
            </p>

            <div id="phone-auth-section">
                <div id="recaptcha-container"></div>

                <div id="step-phone">
                    <label class="input-label">Mobile Number</label>
                    <div class="input-group">
                        <input type="tel" id="phone-number" class="modern-input" placeholder="+91 98765 43210">
                        <button onclick="sendOTP()" id="send-otp-btn" class="btn-primary input-btn">
                            Send OTP
                        </button>
                    </div>
                </div>

                <div id="step-otp" style="display: none;">
                    <label class="input-label">One Time Password</label>
                    <div class="input-group">
                        <input type="text" id="otp-code" class="modern-input" placeholder="Enter 6-digit code"
                            maxlength="6" style="letter-spacing: 3px; font-weight: 700;">
                        <button onclick="verifyOTP()" id="verify-otp-btn" class="btn-primary input-btn"
                            style="background: var(--accent);">
                            Verify
                        </button>
                    </div>
                    <div style="text-align: right; margin-top: 8px;">
                        <span class="link-text" onclick="resetPhoneAuth()">Change Number</span>
                    </div>
                </div>
            </div>

            <div class="divider"><span>OR</span></div>

            <button onclick="loginWithGoogle()" class="google-btn" id="g-login-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" alt="Google">
                <span>Continue with Google Account</span>
            </button>

            <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.05);">
                <p style="font-size: 0.7rem; color: #aaa; line-height: 1.4;">
                    By logging in, you agree to the Terms of Service & Privacy Policy.<br>
                    This site is protected by reCAPTCHA and the Google
                    <a href="https://policies.google.com/privacy" target="_blank" style="color:#aaa;">Privacy Policy</a>
                    and
                    <a href="https://policies.google.com/terms" target="_blank" style="color:#aaa;">Terms of Service</a>
                    apply.
                </p>
            </div>
        </div>
    </div>

    <div class="app-container" style="display: none;">
        <nav class="sidebar">
            <div class="logo" onclick="switchTab('dashboard')">
                <i class="fa-solid fa-hands-holding-circle" style="color: var(--primary);"></i> Silver Care
            </div>



            <ul class="nav-menu" id="admin-menu">
                <li class="nav-item active" id="nav-dashboard" onclick="switchTab('dashboard')">
                    <i class="fa-solid fa-house-chimney-medical"></i> Seva Kendra (Home)
                </li>
                <li class="nav-item" id="nav-staff" onclick="switchTab('staff')">
                    <i class="fa-solid fa-user-nurse"></i> Karmachari (Staff)
                </li>
                <li class="nav-item" id="nav-war-room" onclick="switchTab('war-room')">
                    <i class="fa-solid fa-tower-broadcast" style="color: #d32f2f;"></i> War Room
                </li>
                <li class="nav-item" id="nav-logs" onclick="switchTab('logs')">
                    <i class="fa-solid fa-clipboard-list"></i> Daily Logs
                </li>
                <li class="nav-item" id="nav-payroll" onclick="switchTab('payroll')">
                    <i class="fa-solid fa-money-check-dollar"></i> Payroll
                </li>
                <li class="nav-item" id="nav-bookings" onclick="switchTab('bookings')">
                    <i class="fa-brands fa-whatsapp" style="color: #25D366;"></i> AI Bookings
                </li>

                <li class="nav-item" onclick="logoutApp()" style="margin-top: 1rem; color: #ff4444;">
                    <i class="fa-solid fa-right-from-bracket"></i> Logout
                </li>

                <li class="nav-item" id="nav-super-admin" onclick="switchTab('super-admin')"
                    style="display: none; margin-top: 20px; background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; font-weight: bold;">
                    <i class="fa-solid fa-user-secret"></i> Super Admin
                </li>
            </ul>

            <div
                style="margin-top: auto; padding: 1rem; background: #f0f7ff; border-radius: 12px; border: 1px solid #dbeafe;">
                <p style="font-size: 0.8rem; color: var(--navy); font-weight: 600;">System Status</p>
                <div
                    style="display: flex; align-items: center; gap: 8px; color: var(--accent); font-size: 0.85rem; margin-top: 5px;">
                    <div class="status-dot status-online" style="position: relative;"></div> Firebase Connected
                </div>
            </div>
        </nav>

        <main class="main-content">
            <div class="om-symbol">à¥</div>

            <div id="view-dashboard" class="view-section active-view">
                <header>
                    <div class="page-title">
                        <h1><span class="namaste-icon"><i class="fa-solid fa-hands-praying"></i></span> Namaste, <span
                                id="admin-name">Admin</span></h1>
                        <p>Welcome to your Digital Seva Portal</p>
                    </div>
                    <button class="btn-primary" onclick="openModal()">
                        <i class="fa-solid fa-plus"></i> Add Sahayak
                    </button>
                </header>

                <div class="stats-grid">
                    <div class="card stat-card" onclick="switchTab('staff')">
                        <div class="icon-circle"><i class="fa-solid fa-users"></i></div>
                        <div class="stat-label">Total Staff</div>
                        <div class="stat-value" id="stat-total">0</div>
                    </div>

                    <div class="card stat-card" onclick="showPresentToday()">
                        <div class="icon-circle" style="color: var(--accent);"><i class="fa-solid fa-check-to-slot"></i>
                        </div>
                        <div class="stat-label">Present Today</div>
                        <div class="stat-value" id="stat-present">0</div>
                    </div>

                    <div class="card stat-card" onclick="switchTab('payroll')">
                        <div class="icon-circle" style="color: var(--navy);"><i
                                class="fa-solid fa-indian-rupee-sign"></i></div>
                        <div class="stat-label">Payroll Est.</div>
                        <div class="stat-value" id="stat-payroll-total">â‚¹0</div>
                    </div>
                </div>

                <h2 style="font-family: 'Rozha One'; color: var(--navy); margin-bottom: 1.5rem;">Recent Activity</h2>
                <div class="nurse-grid" id="dashboard-grid">
                </div>
            </div>

            <div id="view-war-room" class="view-section">
                <header>
                    <div class="page-title">
                        <h1><span class="namaste-icon" style="color:#d32f2f;">ðŸ”´</span> Live War Room</h1>
                        <p>Real-time deployment tracking & timer</p>
                    </div>
                    <div style="font-size:0.9rem; color:#666;">
                        <i class="fa-solid fa-circle" style="color:#ff9933;"></i> En Route &nbsp;
                        <i class="fa-solid fa-circle" style="color:#138808;"></i> On Duty
                    </div>
                </header>

                <div id="war-room-grid" class="war-room-container">
                    <div class="empty-state">
                        <i class="fa-solid fa-satellite-dish" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>No Active Deployments</h3>
                        <p>Waiting for bookings via WhatsApp...</p>
                    </div>
                </div>
            </div>

            <div id="view-bookings" class="view-section">
                <header>
                    <div class="page-title">
                        <h1>WhatsApp Requests</h1>
                        <p>Real-time orders extracted by AI</p>
                    </div>
                </header>

                <div class="nurse-grid" id="bookings-grid">
                    <div style="color: #999; grid-column: 1/-1; text-align: center; padding: 2rem;">
                        Waiting for new messages...
                    </div>
                </div>
            </div>

            <div id="view-nurse" class="view-section">
                <div class="card" style="max-width: 450px; margin: 0 auto; text-align: center;">
                    <h2 style="font-family:'Rozha One'; color: var(--navy); margin-bottom: 1rem;">Daily Check-In</h2>

                    <div class="form-group" style="text-align: left;">
                        <label>Select Your Name</label>
                        <select id="nurse-login-select" class="form-input">
                        </select>
                    </div>

                    <div class="cam-container">
                        <video id="video-feed" autoplay playsinline></video>
                        <canvas id="canvas-capture" style="display:none;"></canvas>
                    </div>

                    <div id="location-status"
                        style="background: #f0f0f0; padding: 10px; border-radius: 8px; font-size: 0.8rem; margin-bottom: 1rem; color: #555;">
                        <i class="fa-solid fa-location-crosshairs"></i> Waiting for GPS...
                    </div>

                    <button class="btn-primary" style="width: 100%; padding: 1rem;" onclick="performCheckIn()">
                        <i class="fa-solid fa-camera"></i> SNAP & CHECK IN
                    </button>
                    <p style="font-size: 0.7rem; color: #999; margin-top: 10px;">Location recorded for verification</p>
                </div>
            </div>

            <div id="view-staff" class="view-section">
                <header
                    style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
                    <div class="page-title">
                        <h1>Staff Directory</h1>
                        <p>Manage all registered employees</p>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button class="btn-primary" onclick="toggleManageMode()"
                            style="background: white; color: var(--navy); border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            <i class="fa-solid fa-list-check"></i> Manage
                        </button>

                        <button class="btn-primary" onclick="window.exportToCSV()"
                            style="box-shadow: 0 4px 15px rgba(255, 153, 51, 0.4);">
                            <i class="fa-solid fa-download"></i> Export
                        </button>
                    </div>
                </header>

                <div id="bulk-action-bar"
                    style="display: none; background: #ffebee; padding: 12px 20px; border-radius: 12px; align-items: center; justify-content: space-between; border: 1px solid #ffcdd2; margin-bottom: 2rem; animation: fadeIn 0.3s ease;">
                    <div style="color: #c62828; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-circle-check"></i>
                        <span id="selected-count">0</span> Staff Selected
                    </div>
                    <button onclick="bulkDelete()"
                        style="background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);">
                        Delete Selected <i class="fa-solid fa-trash" style="margin-left: 5px;"></i>
                    </button>
                </div>

                <div class="nurse-grid" id="staff-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem;">
                </div>
            </div>

            <div class="modal" id="replaceModal">
                <div class="modal-content">
                    <button class="close-modal"
                        onclick="document.getElementById('replaceModal').classList.remove('active')">
                        <i class="fa-solid fa-xmark"></i>
                    </button>

                    <h2 style="margin-bottom: 0.5rem; font-family: 'Rozha One'; color: var(--navy);">Replace Staff</h2>

                    <p id="replace-message"
                        style="color: #666; font-size: 0.95rem; margin-bottom: 1.5rem; line-height: 1.6; background: #f9f9f9; padding: 10px; border-radius: 8px; border-left: 4px solid var(--primary);">
                        Loading details...
                    </p>

                    <form id="replaceNurseForm">
                        <input type="hidden" id="replace-old-id">

                        <div class="form-group">
                            <label>New Staff Name</label>
                            <input type="text" class="form-input" id="repName" required placeholder="Ex. Priya Singh">
                        </div>

                        <div class="form-group">
                            <label>WhatsApp Number</label>
                            <input type="tel" class="form-input" id="repPhone" required placeholder="919876543210">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Role</label>
                                <input type="text" class="form-input" id="repRole" required placeholder="Nurse">
                            </div>
                            <div class="form-group">
                                <label>Rate (â‚¹)</label>
                                <input type="number" class="form-input" id="repRate" required placeholder="800">
                            </div>
                        </div>

                        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">
                            Confirm Swap <i class="fa-solid fa-arrow-right-arrow-left"></i>
                        </button>
                    </form>
                </div>
            </div>

          

            <div id="view-super-admin" class="view-section">
                <header>
                    <div class="page-title">
                        <h1><span class="namaste-icon">ðŸ‘‘</span> Admin Control</h1>
                        <p>Verify payments & track sales</p>
                    </div>
                    <button class="btn-primary" onclick="window.exportToCSV()">
                        <i class="fa-solid fa-download"></i> Export CSV
                    </button>
                </header>




                <h3
                    style="color: var(--navy); margin-bottom: 1rem; border-bottom: 2px solid #138808; display:inline-block;">
                    ðŸ† Intern Leaderboard
                </h3>
                <div class="stats-grid" id="admin-leaderboard">
                </div>

                <h3 style="color: var(--navy); margin-bottom: 1rem;">ðŸ‘¥ All Agencies</h3>
                <div class="card" style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                    <table class="simple-table">
                        <thead>
                            <tr>
                                <th>Agency</th>
                                <th>Email</th>
                                <th>Referral</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="admin-all-users"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-logs" class="view-section">
                <header>
                    <div class="page-title">
                        <h1>Daily Attendance Logs</h1>
                        <p>Real-time check-in data with location</p>
                    </div>
                </header>
                <div id="logs-list-container" style="display: flex; flex-direction: column; gap: 1rem;">
                </div>
            </div>

            <div id="view-payroll" class="view-section">
                <header>
                    <div class="page-title">
                        <h1>Payroll Calculation</h1>
                        <p>Automated salary based on attendance</p>
                    </div>

                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="month" id="payroll-month-picker" class="form-input"
                            style="width: auto; padding: 8px;" onchange="window.calculatePayroll()">

                        <button class="btn-primary" onclick="alert('Exporting PDF...')">
                            <i class="fa-solid fa-download"></i> Export
                        </button>
                    </div>
                </header>
                <div class="card" style="overflow-x: auto;">
                    <table class="simple-table">
                        <thead>
                            <tr>
                                <th>Nurse Name</th>
                                <th>Daily Rate</th>
                                <th>Days Worked</th>
                                <th>Total Salary</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="payroll-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>


    <div class="modal" id="addModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto; scrollbar-width: thin;">
            <button class="close-modal" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
            <h2 style="margin-bottom: 1rem; font-family: 'Rozha One'; color: var(--navy);">New Staff Entry</h2>

            <form id="addNurseForm">
                <div
                    style="background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #eee;">
                    <label
                        style="font-weight: 600; color: var(--navy); margin-bottom: 10px; display: block; font-size: 0.9rem;">Select
                        Validity Plan:</label>

                    <div style="display: flex; gap: 12px;">
                        <label style="flex: 1; cursor: pointer; position: relative;">
                            <input type="radio" name="staffPlan" value="monthly" checked
                                onchange="updateCreditDisplay()"
                                style="position: absolute; opacity: 0; width:0; height:0;">
                            <div id="opt-monthly" class="plan-option active"
                                style="padding: 12px; border: 2px solid var(--primary); border-radius: 8px; text-align: center; background: white; transition: 0.2s; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                                <div style="font-weight: bold; color: var(--navy); font-size: 0.95rem;">Monthly</div>
                                <div style="font-size: 0.75rem; color: #666;">30 Days</div>
                            </div>
                        </label>

                        <label style="flex: 1; cursor: pointer; position: relative;">
                            <input type="radio" name="staffPlan" value="daily" onchange="updateCreditDisplay()"
                                style="position: absolute; opacity: 0; width:0; height:0;">
                            <div id="opt-daily" class="plan-option"
                                style="padding: 12px; border: 2px solid transparent; border-radius: 8px; text-align: center; background: white; transition: 0.2s; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                                <div style="font-weight: bold; color: var(--navy); font-size: 0.95rem;">Daily Pass</div>
                                <div style="font-size: 0.75rem; color: #666;">24 Hours</div>
                            </div>
                        </label>
                    </div>

                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-top: 12px; background: #fff; padding: 8px 12px; border-radius: 6px; border: 1px dashed #ddd;">
                        <span id="credit-status-text" style="font-size: 0.8rem; font-weight: 600; color: #666;">Checking
                            credits...</span>

                        <button type="button" onclick="openPaymentFromForm()"
                            style="background: var(--navy); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 5px;">
                            <i class="fa-solid fa-cart-plus"></i> Buy More
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" class="form-input" id="nurseName" required placeholder="Ex. Anjali Gupta">
                </div>

                <div class="form-group">
                    <label>WhatsApp Number (Active)</label>
                    <input type="tel" class="form-input" id="nursePhone" required
                        placeholder="919876543210 (No spaces or +)">
                    <p style="font-size: 0.7rem; color: #888; margin-top: 4px;">Must match their WhatsApp number
                        exactly.</p>
                </div>

                <div class="form-group">
                    <label>Role</label>
                    <input type="text" class="form-input" id="nurseSpec" required placeholder="Ex. Senior Sister">
                </div>

                <div class="form-group">
                    <label>Daily Rate (â‚¹)</label>
                    <input type="number" class="form-input" id="nurseRate" required placeholder="Ex. 800">
                </div>

                <div class="form-group">
                    <label>Document Locker (Aadhaar/ID)</label>
                    <input type="file" id="nurseDoc" style="display: none;" accept="image/*,.pdf"
                        onchange="handleFileSelect(this)">
                    <div class="doc-box" id="doc-trigger" onclick="document.getElementById('nurseDoc').click()">
                        <i class="fa-solid fa-cloud-arrow-up" id="doc-icon"></i>
                        <span id="doc-text">Upload ID Card</span>
                    </div>
                </div>

                <button type="submit" class="btn-primary" style="width: 100%;">Save Entry</button>
            </form>
        </div>
    </div>
    <div id="modal-onboarding" class="login-overlay" style="display: none; z-index: 9999;">
        <div class="login-card" style="text-align: center;">
            <h2 style="color: var(--navy); margin-bottom: 1rem;">Welcome to Silver Care!</h2>
            <p style="color: #666; margin-bottom: 2rem;">Please setup your agency profile.</p>

            <input type="text" id="inp-agency-name" class="form-input" placeholder="Enter Agency Name (e.g. Happy Care)"
                style="margin-bottom: 1rem;">
            <input type="text" id="inp-referral-code" class="form-input" placeholder="Referral Code (Optional)"
                style="margin-bottom: 2rem; border: 2px dashed #ff9933;">

            <button onclick="submitOnboarding()" class="btn-primary" style="width: 100%;">
                Continue <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>
    <div id="modal-payment-lock" class="login-overlay" style="display: none; z-index: 9999;">
        <div class="login-card"
            style="text-align: center; max-width: 450px; position: relative; max-height: 85vh; overflow-y: auto;">

            <div id="payment-form-section">
                <div
                    style="background: #e3f2fd; color: #1565c0; padding: 5px 15px; border-radius: 20px; display: inline-block; font-size: 0.8rem; font-weight: bold; margin-bottom: 1rem;">
                    <i class="fa-solid fa-bolt"></i> INSTANT ACTIVATION
                </div>

                <h2 style="color: var(--navy); margin-bottom: 0.5rem;">Select Plan</h2>

                <div
                    style="background: #f0f0f0; padding: 5px; border-radius: 12px; display: flex; gap: 5px; margin-bottom: 1.5rem; border: 1px solid #ddd;">
                    <button id="plan-monthly" onclick="switchPlan('monthly')"
                        style="flex: 1; padding: 10px; border-radius: 8px; border: none; background: white; color: var(--navy); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s;">
                        Monthly (30 Days)
                    </button>
                    <button id="plan-daily" onclick="switchPlan('daily')"
                        style="flex: 1; padding: 10px; border-radius: 8px; border: none; background: transparent; color: #666; font-weight: 600; cursor: pointer; transition: 0.2s;">
                        Daily (24 Hours)
                    </button>
                </div>

                <p id="plan-desc"
                    style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem; background: #fff; padding: 10px; border-radius: 8px; border: 1px dashed #ccc;">
                    Best for regular staff. Valid for 30 days.
                </p>

                <div style="margin-bottom: 1.5rem; text-align: left;">
                    <label style="font-weight: bold; color: var(--navy); font-size: 0.9rem;">Quantity:</label>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <input type="number" id="slot-quantity" class="form-input" value="1" min="1" max="100"
                            oninput="window.calculateTotal()"
                            style="font-size: 1.2rem; font-weight: bold; text-align: center;">
                    </div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px; font-weight: 500;">
                        Rate: <span id="plan-rate" style="color: #138808; font-weight: bold;">â‚¹199 per slot</span>
                    </div>
                </div>

                <div
                    style="background: #f9f9f9; padding: 15px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 1.5rem; text-align: left;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; color: var(--navy);">Total to Pay:</span>
                        <span id="bill-total" style="font-size: 1.4rem; color: #138808; font-weight: bold;">â‚¹199</span>
                    </div>
                </div>

                <button id="rzp-button" onclick="window.startRazorpayPayment()" class="btn-primary"
                    style="width: 100%; margin-bottom: 10px;">
                    Pay & Activate <i class="fa-solid fa-credit-card"></i>
                </button>

                <button id="btn-pay-later" onclick="window.activatePayLater()"
                    style="background: none; border: none; color: #666; text-decoration: underline; cursor: pointer; font-size: 0.9rem;">
                    Cancel (Go Back)
                </button>
            </div>

        </div>
    </div>

    <div class="modal" id="profileModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <button class="close-modal" onclick="document.getElementById('profileModal').classList.remove('active')"><i
                    class="fa-solid fa-xmark"></i></button>

            <div style="text-align:center; margin-bottom:1.5rem;">
                <h2 id="p-name" style="color:var(--navy);">Nurse Name</h2>
                <p id="p-role" style="color:#666; font-size:0.9rem;">Role</p>
            </div>

            <div class="profile-tabs">
                <button class="tab-btn active" onclick="switchProfileTab('attendance')">Attendance</button>
                <button class="tab-btn" onclick="switchProfileTab('docs')">Documents</button>
                <button class="tab-btn" onclick="switchProfileTab('edit')">Edit Info</button>
            </div>

            <div id="tab-attendance" class="tab-content active">
                <div class="calendar-controls">
                    <div class="control-group">
                        <button class="cal-btn" onclick="changeMonth(-1)"><i
                                class="fa-solid fa-chevron-left"></i></button>
                        <div class="current-date-display">
                            <div class="cal-month" id="cal-month-text">Month</div>
                            <div style="font-size: 0.65rem; color:#ccc; text-transform:uppercase;">Month</div>
                        </div>
                        <button class="cal-btn" onclick="changeMonth(1)"><i
                                class="fa-solid fa-chevron-right"></i></button>
                    </div>

                    <div class="control-group">
                        <button class="cal-btn" onclick="changeYear(-1)"><i class="fa-solid fa-backward"></i></button>
                        <div class="current-date-display">
                            <div class="cal-month" id="cal-year-text">Year</div>
                            <div style="font-size: 0.65rem; color:#ccc; text-transform:uppercase;">Year</div>
                        </div>
                        <button class="cal-btn" onclick="changeYear(1)"><i class="fa-solid fa-forward"></i></button>
                    </div>
                </div>

                <div class="calendar-grid" id="cal-days-container"></div>

                <div style="display:flex; gap:15px; justify-content:center; margin-top:20px; font-size:0.8rem;">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <div
                            style="width:12px; height:12px; background:#e8f5e9; border:1px solid #c8e6c9; border-radius:4px;">
                        </div> Present
                    </div>
                    <div style="display:flex; align-items:center; gap:6px;">
                        <div
                            style="width:12px; height:12px; background:#ffebee; border:1px solid #ffcdd2; border-radius:4px;">
                        </div> Absent
                    </div>
                </div>
            </div>

            <div id="tab-docs" class="tab-content">
                <div style="border:2px dashed #ddd; padding:1.5rem; text-align:center; border-radius:12px; cursor:pointer; margin-bottom:15px;"
                    onclick="document.getElementById('doc-upload').click()">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size:1.5rem; color:var(--primary);"></i>
                    <p style="font-size:0.8rem; color:#666;">Upload ID/Certificate</p>
                    <input type="file" id="doc-upload" hidden accept="image/*,.pdf">
                </div>
                <div id="doc-list"></div>
            </div>

            <div id="tab-edit" class="tab-content">
                <form id="editNurseForm">
                    <input type="hidden" id="edit-id">
                    <div class="form-group"><label>Full Name</label><input type="text" id="edit-name"
                            class="form-input"></div>
                    <div class="form-group"><label>Phone</label><input type="text" id="edit-phone" class="form-input">
                    </div>
                    <div class="form-group"><label>Rate (â‚¹)</label><input type="number" id="edit-rate"
                            class="form-input"></div>
                    <div class="form-group"><label>Role</label><input type="text" id="edit-role" class="form-input">
                    </div>
                    <button type="submit" class="btn-primary" style="width:100%; margin-top:10px;">Update
                        Profile</button>
                </form>
            </div>
        </div>
    </div>
    <div class="modal" id="confirmModal" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 400px; text-align: center; border-top: 5px solid #d32f2f;">
            <div
                style="width: 60px; height: 60px; background: #ffebee; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem auto;">
                <i class="fa-solid fa-triangle-exclamation" style="font-size: 1.8rem; color: #d32f2f;"></i>
            </div>

            <h2 id="confirm-title" style="color: var(--navy); margin-bottom: 0.5rem;">Are you sure?</h2>
            <p id="confirm-msg" style="color: #666; font-size: 0.95rem; margin-bottom: 2rem; line-height: 1.6;">
                Warning text goes here.
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button onclick="closeConfirmModal()"
                    style="background: white; border: 1px solid #ccc; color: #555; padding: 12px; border-radius: 30px; font-weight: 600; cursor: pointer;">
                    Cancel
                </button>
                <button id="confirm-btn-yes"
                    style="background: #d32f2f; border: none; color: white; padding: 12px; border-radius: 30px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);">
                    Yes, Delete
                </button>
            </div>
        </div>
    </div>

    <div id="toast-container"
        style="position: fixed; bottom: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px;">
    </div>
    <div class="modal" id="adminAgencyModal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <button class="close-modal"
                onclick="document.getElementById('adminAgencyModal').classList.remove('active')">
                <i class="fa-solid fa-xmark"></i>
            </button>

            <h2 style="color: var(--navy); font-family: 'Rozha One'; margin-bottom: 5px;" id="admin-view-title">Agency
                Details</h2>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;" id="admin-view-subtitle">Inspecting Staff
                List</p>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <div
                    style="flex: 1; background: #e8f5e9; padding: 10px; border-radius: 8px; border: 1px solid #c8e6c9;">
                    <div style="font-size: 0.8rem; color: #2e7d32; font-weight: 600;">Active Staff</div>
                    <div id="adm-count-active" style="font-size: 1.4rem; font-weight: 700; color: #1b5e20;">0</div>
                </div>
                <div
                    style="flex: 1; background: #ffebee; padding: 10px; border-radius: 8px; border: 1px solid #ffcdd2;">
                    <div style="font-size: 0.8rem; color: #c62828; font-weight: 600;">Expired / Due</div>
                    <div id="adm-count-expired" style="font-size: 1.4rem; font-weight: 700; color: #b71c1c;">0</div>
                </div>
            </div>

            <h4 style="margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; color: var(--navy);">
                Staff Roster</h4>
            <div id="admin-staff-list" style="display: flex; flex-direction: column; gap: 10px;">
                <p style="text-align: center; color: #999;">Loading...</p>
            </div>
        </div>
    </div>
    <div id="img-viewer-modal" onclick="closeImageViewer()">
        <span class="img-viewer-close">&times;</span>
        <img id="img-viewer-full" src="" alt="Proof of Attendance">
        <p id="img-viewer-caption" style="color:white; margin-top:15px; font-family:'Poppins';"></p>
    </div>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script type="module">
        // 1. IMPORTS (VERIFIED & CLEAN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

        // ðŸ‘‡ This checks all your imports are correct and includes 'where', 'getDocs', 'increment'
        import {
            getFirestore, collection, addDoc, onSnapshot, query, orderBy,
            deleteDoc, doc, updateDoc, getDoc, serverTimestamp, setDoc, increment,
            where, getDocs, limit, writeBatch
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        import {
            getAuth, GoogleAuthProvider, signInWithPopup, signOut,
            onAuthStateChanged, RecaptchaVerifier, signInWithPhoneNumber
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyADbFSo1XZA78Sj-ooJ7Av8tDxbctS-Qws",
            authDomain: "silvercareprototype.firebaseapp.com",
            projectId: "silvercareprototype",
            storageBucket: "silvercareprototype.firebasestorage.app",
            messagingSenderId: "695863800030",
            appId: "1:695863800030:web:751cb3b0d536464957924f"
        };

        const app = initializeApp(firebaseConfig);
        // ... (Your code continues below as normal)
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- STATE VARIABLES ---
        let currentUser = null;
        let currentUserData = null; // Stores user profile (payment status, etc.)
        let allNurses = [];
        let allAgencies = []; // ðŸ‘ˆ Add this new variable
        let allLogs = [];
        let currentStream = null;
        let currentNurseId = null;
        let currentCalDate = new Date(); // Tracks the calendar month
        let allPayouts = []; // Stores list of paid months

        // Unsubscribe functions
        let unsubscribeUserDoc = null;
        let unsubscribeNurses = null;
        let unsubscribeLogs = null;
        let unsubscribeBookings = null;

        // ==========================================
        // ðŸ” AUTH & GATEKEEPER LOGIC
        // ==========================================

        onAuthStateChanged(auth, (user) => {
            const landingPage = document.getElementById('public-landing');
            const dashboard = document.querySelector('.app-container');
            const loginOverlay = document.getElementById('login-overlay');
            const nameSpan = document.getElementById('admin-name');

            if (user) {
                // LOGGED IN
                console.log("User Logged In:", user.uid);
                currentUser = user;

                // UI Updates
                landingPage.style.display = 'none';
                loginOverlay.style.display = 'none';
                dashboard.style.display = 'grid';
                nameSpan.innerText = user.displayName ? user.displayName.split(' ')[0] : 'Admin';

                // 1. Check if Super Admin
                checkAdminAccess(user);

                // 2. Start Gatekeeper (Checks Payment -> Then Loads Data)
                setupGatekeeper(user.uid);

            } else {
                // LOGGED OUT
                console.log("User Logged Out");
                currentUser = null;
                currentUserData = null;

                // UI Updates
                landingPage.style.display = 'flex';
                dashboard.style.display = 'none';
                loginOverlay.style.display = 'none';

                // Hide Modals
                document.getElementById('modal-onboarding').style.display = 'none';
                document.getElementById('modal-payment-lock').style.display = 'none';

                // Detach Listeners
                if (unsubscribeUserDoc) unsubscribeUserDoc();
                if (unsubscribeNurses) unsubscribeNurses();
                if (unsubscribeLogs) unsubscribeLogs();
                if (unsubscribeBookings) unsubscribeBookings();

                // Clear Data
                allNurses = [];
                allLogs = [];
                renderStaffList();
                renderDashboardLogs();
            }
        });

        // --- ðŸ—“ï¸ VALIDITY CHECKER SYSTEM (Step 3: Updated for Plan Types) ---
        let expiredNursesList = []; // Stores IDs of nurses who need payment

        async function checkNurseValidity(uid) {
            const q = collection(db, "users", uid, "nurses");
            const snapshot = await getDocs(q);

            expiredNursesList = [];
            const now = Date.now();
            const msPerDay = 24 * 60 * 60 * 1000;

            snapshot.forEach(docSnap => {
                const n = docSnap.data();
                // Give old data a 7-day grace period
                const expiry = n.validUntil || (now + (7 * msPerDay));

                if (expiry < now) {
                    // ðŸŸ¢ UPDATED: Capture the 'type' so the modal knows what badge to show
                    expiredNursesList.push({
                        id: docSnap.id,
                        name: n.name,
                        type: n.type || 'monthly' // Default to monthly if missing
                    });
                }
            });

            if (expiredNursesList.length > 0) {
                showRenewalModal(expiredNursesList);
            } else {
                const lockModal = document.getElementById('modal-payment-lock');
                if (lockModal) lockModal.style.display = 'none';
            }
        }


        // --- UPDATED: Renewal Modal (Fixes Pricing Loophole) ---
        function showRenewalModal(expiredList) {
            const modal = document.getElementById('modal-payment-lock');
            const title = document.querySelector('#payment-form-section h2');
            const desc = document.querySelector('#payment-form-section p');
            const input = document.getElementById('slot-quantity');
            const payBtn = document.getElementById('rzp-button');
            const backBtn = document.getElementById('btn-pay-later');

            // ðŸŸ¢ NEW: Get Plan Buttons to manipulate them
            const monthlyBtn = document.getElementById('plan-monthly');
            const dailyBtn = document.getElementById('plan-daily');

            if (!modal) return;
            modal.style.display = 'flex';

            // ðŸŸ¢ LOCK PLAN TO MONTHLY (Prevent the â‚¹10 Loophole)
            if (monthlyBtn && dailyBtn) {
                // Force click Monthly to set price to 199
                monthlyBtn.click();
                // Hide Daily button so they can't switch
                dailyBtn.style.display = 'none';
                // Update text to show why
                monthlyBtn.innerText = "Renew as Monthly (30 Days)";
                monthlyBtn.style.width = "100%"; // Make it look full width
            }

            if (title) {
                title.innerText = "âš ï¸ Validity Expired";
                title.style.color = "#d32f2f";
            }

            if (desc) {
                let listHtml = `<div style="text-align:left; margin-top:15px; border-top:1px solid #eee; padding-top:10px; max-height:200px; overflow-y:auto;">`;

                expiredList.forEach(nurse => {
                    const isDaily = nurse.type === 'daily';
                    const badgeStyle = isDaily
                        ? "background:#fff3e0; color:#e65100; border:1px solid #ffe0b2;"
                        : "background:#e3f2fd; color:#1565c0; border:1px solid #bbdefb;";
                    const typeText = isDaily ? "Daily Pass" : "Monthly Slot";

                    listHtml += `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background:#fff5f5; padding:10px; border-radius:10px; border:1px solid #ffebee;">
                <div>
                    <span style="font-size:0.9rem; font-weight:600; color:#333;">${nurse.name}</span>
                    <span style="font-size:0.65rem; margin-left:6px; padding:2px 6px; border-radius:4px; font-weight:bold; ${badgeStyle}">${typeText}</span>
                    <span style="font-size:0.7rem; color:#d32f2f; display:block; margin-top:2px;">Expired</span>
                </div>
                <button onclick="window.removeNurse('${nurse.id}', true)" 
                style="background:#ff4444; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.75rem; font-weight:600; transition:0.2s; display:flex; align-items:center; gap:5px;">
            <i class="fa-solid fa-trash"></i> Delete
        </button>
            </div>`;
                });
                listHtml += `</div>`;

                desc.innerHTML = `
            <div style="background:#fff3cd; color:#856404; padding:12px; border-radius:8px; margin-bottom:15px; font-size:0.85rem; border:1px solid #ffeeba; text-align:left;">
                <i class="fa-solid fa-circle-info"></i> <b>Action Required:</b><br>
                â€¢ <b>Daily Pass:</b> Shift is over. Please <b style="color:#d32f2f;">Delete</b> them.<br>
                â€¢ <b>Monthly:</b> <b style="color:#d32f2f;">Delete</b> or <b>Renew</b> (Upgrade) below.
            </div>
            ${listHtml}
        `;
            }

            if (input) {
                input.value = expiredList.length;
                input.disabled = true;
                if (window.calculateTotal) window.calculateTotal();
            }

            if (payBtn) payBtn.innerText = `Renew ${expiredList.length} Staff (30 Days)`;
            if (backBtn) backBtn.style.display = 'none';
        }

        // --- FINAL LOCK SCREEN DELETE (Handles Daily vs Monthly Logic) ---
        window.removeNurseFromLock = async (id) => {
            if (!confirm("Are you sure you want to delete this staff member?")) return;

            try {
                // 1. GET DATA
                const nurseRef = doc(db, "users", currentUser.uid, "nurses", id);
                const nurseSnap = await getDoc(nurseRef);

                if (!nurseSnap.exists()) {
                    // Already deleted? Clean UI and exit.
                    const btn = document.querySelector(`button[onclick*="${id}"]`);
                    if (btn) btn.closest('div').remove();
                    return;
                }

                const n = nurseSnap.data();
                const isDaily = (n.type === 'daily');

                // 2. DELETE THE NURSE
                await deleteDoc(nurseRef);

                // 3. UPDATE THE NUMBERS (The Smart Part)
                if (isDaily) {
                    // ðŸŽ« DAILY LOGIC:
                    // We ALREADY burned the pass when we added them.
                    // We DO NOT touch 'nurseCount' because daily staff don't count towards that limit.
                    // So we just delete the doc and do nothing else.
                    console.log("ðŸŽ« Daily Staff deleted. Cleanup only.");
                }
                else {
                    // ðŸ—“ï¸ MONTHLY LOGIC:
                    const updates = {
                        nurseCount: increment(-1) // 1. Always lower Active Count
                    };

                    // Check Expiry for "Burn" logic
                    const now = Date.now();
                    const validUntil = n.validUntil || (n.createdAt + (30 * 24 * 60 * 60 * 1000));
                    const isExpired = validUntil < now;

                    // 2. If they used the full month, burn the slot limit too.
                    if (isExpired) {
                        console.log("ðŸ”¥ Burning used Monthly slot...");
                        updates.extraSlots = increment(-1);
                    }

                    await updateDoc(doc(db, "users", currentUser.uid), updates);
                }

                // 4. UI CLEANUP
                const btn = document.querySelector(`button[onclick*="${id}"]`);
                if (btn) btn.closest('div').remove();

                await checkNurseValidity(currentUser.uid);

            } catch (error) {
                console.error("Removal Error:", error);
                alert("Could not remove staff. Please try again.");
            }
        };

        // --- THE GATEKEEPER (Step 3: Prepaid Validity Model) ---
        function setupGatekeeper(uid) {
            unsubscribeUserDoc = onSnapshot(doc(db, "users", uid), (docSnap) => {

                // 1. SUPER ADMIN BYPASS
                if (currentUser.email === "supercare655@gmail.com") {
                    document.getElementById('modal-onboarding').style.display = 'none';
                    document.getElementById('modal-payment-lock').style.display = 'none';
                    startDataSync(uid);
                    return;
                }

                // 2. HANDLE NEW USERS
                if (!docSnap.exists()) {
                    document.getElementById('modal-onboarding').style.display = 'flex';
                    return;
                }

                currentUserData = docSnap.data();

                // 3. CHECK ONBOARDING
                if (!currentUserData.agencyName) {
                    document.getElementById('modal-onboarding').style.display = 'flex';
                    return;
                } else {
                    document.getElementById('modal-onboarding').style.display = 'none';
                }

                // 4. CHECK PREPAID VALIDITY (New Model)
                // This scans all your nurses. If any are expired, it shows the Lock Screen.
                // It replaces the old "isPaid" and "Payment Pending" checks.
                if (typeof checkNurseValidity === 'function') {
                    checkNurseValidity(uid);
                }

                // 5. START DATA SYNC
                // We load data so the dashboard is ready as soon as they recharge.
                startDataSync(uid);
            });
        }
        // --- DATA SYNC (Loads Nurses/Logs/Payouts ONLY after Gatekeeper passes) ---
       // --- DATA SYNC (Reads Bookings AND Availability Attendance) ---
       function startDataSync(uid) {
        if (unsubscribeNurses) return;

        console.log("ðŸ”„ Starting Data Sync...");

        // 1. Nurses Directory
        unsubscribeNurses = onSnapshot(collection(db, "users", uid, "nurses"), (snapshot) => {
            allNurses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderStaffList();
            populateLoginSelect();
            const totalEl = document.getElementById('stat-total');
            if (totalEl) totalEl.innerText = allNurses.length;
        });

        // 2. COMBINED LOGS: Bookings + Attendance (Availability)
        const bookingsRef = collection(db, "users", uid, "bookings");
        const attendanceRef = collection(db, "users", uid, "attendance");

        // Init temporary holders attached to window so they persist between updates
        window.tempBookingsLogs = [];
        window.tempAttendanceLogs = [];

        // Helper to merge both lists and update the UI
        const updateMergedLogs = () => {
            // Combine arrays
            const merged = [...window.tempBookingsLogs, ...window.tempAttendanceLogs];
            
            // Sort by time (newest first)
            merged.sort((a, b) => b.timestamp - a.timestamp);
            
            allLogs = merged; // Update Global State

            // Render UI
            renderDashboardLogs();
            renderAllLogs();

            // Update "Present Today" Stat
            const today = new Date().toDateString();
            const todayCount = allLogs.filter(l => new Date(l.timestamp).toDateString() === today).length;
            
            const presentEl = document.getElementById('stat-present');
            if (presentEl) presentEl.innerText = todayCount;

            // Recalculate Payroll (if view is open)
            if (document.getElementById('view-payroll') && document.getElementById('view-payroll').classList.contains('active-view')) {
                window.calculatePayroll();
            }
        };

        // Listener A: Bookings (Actual Jobs)
        unsubscribeLogs = onSnapshot(query(bookingsRef, orderBy("timestamp", "desc")), (snapshot) => {
            window.tempBookingsLogs = [];
            snapshot.forEach(doc => {
                const b = doc.data();
                // We treat "Arrived", "In Progress", and "Completed" as being PRESENT
                if (['nurse_arrived', 'in_progress', 'completed'].includes(b.status)) {
                    window.tempBookingsLogs.push({
                        id: doc.id,
                        nurseId: b.assignedNurseId, 
                        nurseName: b.assignedNurseName || "Assigned Nurse",
                        timestamp: b.startedAt || b.timestamp,
                        photo: b.nurse_selfie_url || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png",
                        address: b.nurse_location_address || b.location,
                        type: 'job'
                    });
                }
            });
            updateMergedLogs();
        });

        // Listener B: Attendance (Availability Check-ins from Bot)
        // ðŸŒŸ This picks up the new records created when they share location
        const unsubAttendance = onSnapshot(query(attendanceRef, orderBy("timestamp", "desc")), (snapshot) => {
            window.tempAttendanceLogs = [];
            snapshot.forEach(doc => {
                const a = doc.data();
                window.tempAttendanceLogs.push({
                    id: doc.id,
                    nurseId: a.nurseId,
                    nurseName: a.nurseName,
                    timestamp: a.timestamp,
                    photo: a.photo || "https://cdn-icons-png.flaticon.com/512/684/684908.png", // Map Icon
                    address: a.address,
                    type: 'checkin'
                });
            });
            updateMergedLogs();
        });
        
        // Track this listener to unsubscribe later if needed
        window.unsubscribeAttendance = unsubAttendance;

        // 3. Payouts (Existing Code)
        const payoutsRef = collection(db, "users", uid, "payouts");
        onSnapshot(payoutsRef, (snapshot) => {
            allPayouts = snapshot.docs.map(doc => doc.id);
            if (document.getElementById('view-payroll') && document.getElementById('view-payroll').classList.contains('active-view')) {
                window.calculatePayroll();
            }
        });
        
         // 4. Bookings Request Feed (Existing Code)
        unsubscribeBookings = onSnapshot(query(bookingsRef, orderBy("timestamp", "desc")), (snapshot) => {
            const grid = document.getElementById('bookings-grid');
            if (grid) {
                grid.innerHTML = '';
                if (snapshot.empty) {
                    grid.innerHTML = '<p style="color:#888; grid-column:1/-1; text-align:center;">No new requests.</p>';
                } else {
                    snapshot.docs.forEach(doc => {
                        const b = doc.data();
                        grid.innerHTML += `
                        <div class="card" style="border-left: 5px solid #25D366;">
                            <h3><i class="fa-brands fa-whatsapp"></i> ${b.clientPhone}</h3>
                            <p style="font-size:0.9rem;"><b>Loc:</b> ${b.location}</p>
                            <span style="font-size:0.8rem; color:#888;">${new Date(b.timestamp).toLocaleTimeString()}</span>
                        </div>`;
                    });
                }
            }
        });
    }

        // ==========================================
        // ðŸ’° PRICING & PLAN LOGIC (Copy This Block)
        // ==========================================

        // 1. CONFIGURATION
        const MONTHLY_RATE = 199;
        const DAILY_RATE = 10;
        let currentPlan = 'monthly'; // Default setting

        // Initialize the order object so it's never undefined
        let currentOrder = {
            slots: 1,
            totalPrice: 199,
            type: 'monthly'
        };

        // 2. THE MISSING FUNCTION: Switch Plan Logic
        window.switchPlan = (plan) => {
            currentPlan = plan;

            // Get Elements
            const btnMonthly = document.getElementById('plan-monthly');
            const btnDaily = document.getElementById('plan-daily');
            const desc = document.getElementById('plan-desc');
            const rateTxt = document.getElementById('plan-rate');

            // Update UI Styles
            if (plan === 'monthly') {
                // Active: Monthly
                btnMonthly.style.background = 'white';
                btnMonthly.style.color = 'var(--navy)';
                btnMonthly.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';

                // Inactive: Daily
                btnDaily.style.background = 'transparent';
                btnDaily.style.color = '#666';
                btnDaily.style.boxShadow = 'none';

                // Text Updates
                if (desc) desc.innerText = "Best for regular staff. Valid for 30 days.";
                if (rateTxt) rateTxt.innerHTML = `<span style="color:#138808; font-weight:bold;">â‚¹${MONTHLY_RATE} per slot</span>`;

            } else {
                // Active: Daily
                btnDaily.style.background = 'white';
                btnDaily.style.color = '#d32f2f'; // Red highlight
                btnDaily.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';

                // Inactive: Monthly
                btnMonthly.style.background = 'transparent';
                btnMonthly.style.color = '#666';
                btnMonthly.style.boxShadow = 'none';

                // Text Updates
                if (desc) desc.innerText = "For temporary/unscattered needs. Valid for 24 hours.";
                if (rateTxt) rateTxt.innerHTML = `<span style="color:#d32f2f; font-weight:bold;">â‚¹${DAILY_RATE} per pass</span>`;
            }

            // Recalculate Price Immediately
            window.calculateTotal();
        };

        // 3. UPDATED CALCULATOR
        window.calculateTotal = () => {
            const input = document.getElementById('slot-quantity');
            if (!input) return;

            let qty = parseInt(input.value) || 1;
            if (qty < 1) qty = 1;

            // Use Rate based on the selected plan
            const rate = currentPlan === 'monthly' ? MONTHLY_RATE : DAILY_RATE;
            const finalPrice = qty * rate;

            // Update Global Order State (Critical for Payment)
            currentOrder = {
                slots: qty,
                totalPrice: finalPrice,
                type: currentPlan // Stores 'monthly' or 'daily'
            };

            // Update Totals on Screen
            const billTotal = document.getElementById('bill-total');
            if (billTotal) billTotal.innerText = `â‚¹${finalPrice}`;

            // Update Button Text
            const btn = document.getElementById('rzp-button');
            if (btn) btn.innerText = `Pay â‚¹${finalPrice} & Activate`;
        };

        // Helper Styles
        function highlightBadge(id) {
            const el = document.getElementById(id);
            if (el) { el.style.background = '#4caf50'; el.style.color = 'white'; el.style.fontWeight = 'bold'; }
        }
        function resetBadges() {
            ['badge-5', 'badge-10', 'badge-20'].forEach(id => {
                const el = document.getElementById(id);
                if (el) { el.style.background = '#eee'; el.style.color = '#999'; el.style.fontWeight = 'normal'; }
            });
        }

        // Initialize Modal
        window.initPricingModal = () => {
            const input = document.getElementById('slot-quantity');
            if (input) input.value = 1;
            calculateTotal(); // Run calculation for 1
        }

        // --- 1. UI HELPER: Updates the Green/Red Credit Text in Modal ---
        window.updateCreditDisplay = () => {
            // A. Find out which plan is currently selected (Monthly or Daily)
            const radios = document.getElementsByName('staffPlan');
            let plan = 'monthly';
            for (const r of radios) { if (r.checked) plan = r.value; }

            // B. Update the Visual Selection (Orange Border)
            const optMonthly = document.getElementById('opt-monthly');
            const optDaily = document.getElementById('opt-daily');

            if (plan === 'monthly') {
                optMonthly.className = 'plan-option active';
                optDaily.className = 'plan-option';
            } else {
                optMonthly.className = 'plan-option';
                optDaily.className = 'plan-option active';
            }

            // C. Calculate Available Credits
            const statusTxt = document.getElementById('credit-status-text');

            // Monthly Math: (Total Paid Slots) - (Active Monthly Nurses)
            const extraSlots = currentUserData?.extraSlots || 0;
            // We filter so we don't count "Daily" nurses against your "Monthly" limit
            const usedSlots = allNurses.filter(n => !n.type || n.type === 'monthly').length;
            const monthlyLeft = Math.max(0, extraSlots - usedSlots);

            // Daily Math: Just read the pass count
            const dailyPasses = currentUserData?.dailyPasses || 0;

            // D. Update the Text based on choice
            if (plan === 'monthly') {
                if (monthlyLeft > 0) {
                    statusTxt.innerHTML = `<i class="fa-solid fa-circle-check" style="color:#138808;"></i> Available Slots: <b>${monthlyLeft}</b>`;
                    statusTxt.style.color = '#138808';
                    statusTxt.style.background = '#e8f5e9';
                    statusTxt.style.borderColor = '#c8e6c9';
                } else {
                    statusTxt.innerHTML = `<i class="fa-solid fa-circle-xmark" style="color:#d32f2f;"></i> Limit Reached. Purchase more slots.`;
                    statusTxt.style.color = '#d32f2f';
                    statusTxt.style.background = '#ffebee';
                    statusTxt.style.borderColor = '#ffcdd2';
                }
            } else {
                if (dailyPasses > 0) {
                    statusTxt.innerHTML = `<i class="fa-solid fa-ticket" style="color:#138808;"></i> Daily Passes: <b>${dailyPasses}</b>`;
                    statusTxt.style.color = '#138808';
                    statusTxt.style.background = '#e8f5e9';
                    statusTxt.style.borderColor = '#c8e6c9';
                } else {
                    statusTxt.innerHTML = `<i class="fa-solid fa-circle-xmark" style="color:#d32f2f;"></i> No Passes. Purchase Required (â‚¹10).`;
                    statusTxt.style.color = '#d32f2f';
                    statusTxt.style.background = '#ffebee';
                    statusTxt.style.borderColor = '#ffcdd2';
                }
            }
        };
        // --- SMART TRIGGER: Handles New vs. Existing Users ---
        window.openModal = (isOnboarding = false) => {

            // ðŸŸ¢ RESET PLAN BUTTONS (Fix for Lock Screen Loophole)
            // We must unhide the Daily button in case the Lock Screen hid it previously.
            const dailyBtn = document.getElementById('plan-daily');
            const monthlyBtn = document.getElementById('plan-monthly');

            if (dailyBtn) dailyBtn.style.display = 'block'; // Bring it back
            if (monthlyBtn) {
                monthlyBtn.innerText = "Monthly (30 Days)"; // Reset Text
                monthlyBtn.style.width = ""; // Reset width (remove 100% stretch)
            }

            // 1. Check if User is Active (Has paid at least once)
            const isPaidUser = currentUserData?.isPaid === true;

            // Fallback: If 'isPaid' is missing but they have history (legacy users)
            const hasHistory = (currentUserData?.extraSlots > 0) ||
                (currentUserData?.dailyPasses > 0) ||
                (allNurses.length > 0);

            const isActiveAccount = isPaidUser || hasHistory;

            // 2. LOGIC: New User vs Existing
            if (!isActiveAccount || isOnboarding) {
                // ðŸ›‘ CASE A: NEW USER (Not Active)
                // Don't show the form. Go straight to Payment/Activation.

                document.getElementById('addModal').classList.remove('active'); // Ensure form is closed
                document.getElementById('modal-payment-lock').style.display = 'flex';

                // Update Title for Context
                const payTitle = document.querySelector('#payment-form-section h2');
                if (payTitle) payTitle.innerText = "Activate Account";

                // Default to Monthly for first purchase
                if (window.switchPlan) window.switchPlan('monthly');

                return; // Stop here
            }

            // âœ… CASE B: EXISTING USER (Active)
            // Show the Add Form (They can see 'Buy More' inside if they have 0 credits)
            document.getElementById('addModal').classList.add('active');

            // 3. Auto-Select the Plan they have credits for
            const extraSlots = currentUserData?.extraSlots || 0;
            const usedSlots = allNurses.filter(n => !n.type || n.type === 'monthly').length;
            const monthlyLeft = Math.max(0, extraSlots - usedSlots);
            const dailyPasses = currentUserData?.dailyPasses || 0;

            const monthlyRadio = document.querySelector('input[value="monthly"]');
            const dailyRadio = document.querySelector('input[value="daily"]');

            if (monthlyLeft > 0) {
                if (monthlyRadio) { monthlyRadio.checked = true; monthlyRadio.click(); }
            } else if (dailyPasses > 0) {
                if (dailyRadio) { dailyRadio.checked = true; dailyRadio.click(); }
            } else {
                // If 0 credits, default to Monthly
                if (monthlyRadio) { monthlyRadio.checked = true; monthlyRadio.click(); }
            }

            // Refresh the Green/Red text
            if (typeof window.updateCreditDisplay === 'function') {
                window.updateCreditDisplay();
            }
        };
        window.closeModal = () => document.getElementById('addModal').classList.remove('active');

        // --- FUNCTION: Razorpay Payment Trigger (Updated for Hybrid Model) ---
        window.startRazorpayPayment = () => {
            // 1. Safety Check
            if (!currentOrder || !currentOrder.totalPrice) {
                alert("Error: Invalid order details. Please refresh and try again.");
                return;
            }

            // 2. Convert Price to Paise (Razorpay expects 100 for â‚¹1)
            // âœ… FIX: Use the actual calculated price
            const amountInPaise = 100;

            const options = {
                "key": "rzp_live_RulrnBRfeFkxjt", // âœ… Your Live Key
                "amount": amountInPaise,
                "currency": "INR",
                "name": "Silver Care",
                // âœ… FIX: Dynamic Description
                "description": `Payment for ${currentOrder.slots} ${currentOrder.type === 'daily' ? 'Daily Passes' : 'Monthly Slots'}`,
                "image": "https://silvercareprototype.web.app/icon.png",

                "handler": async function (response) {
                    // --- SUCCESS HANDLER ---
                    console.log("Payment Success:", response.razorpay_payment_id);

                    const btn = document.getElementById('rzp-button');
                    if (btn) {
                        btn.innerText = "Activating Credits...";
                        btn.disabled = true;
                    }

                    try {
                        const userRef = doc(db, "users", currentUser.uid);
                        const userSnap = await getDoc(userRef);
                        const userData = userSnap.data();
                        const referrerCode = userData.referralBy;

                        // --- A. CREDIT UPDATE (The Core Fix) ---
                        if (currentOrder.type === 'daily') {
                            // ðŸŸ  BUYING DAILY PASSES
                            await updateDoc(userRef, {
                                paymentRequest: {
                                    status: 'approved',
                                    amount: currentOrder.totalPrice,
                                    method: 'razorpay',
                                    transactionId: response.razorpay_payment_id,
                                    paidAt: serverTimestamp(),
                                    type: 'daily',
                                    quantity: currentOrder.slots
                                },
                                dailyPasses: increment(currentOrder.slots), // ðŸ‘ˆ Adds Daily Passes
                                lastPaymentId: response.razorpay_payment_id
                            });
                        } else {
                            // ðŸ”µ BUYING MONTHLY SLOTS (Standard)
                            await updateDoc(userRef, {
                                paymentRequest: {
                                    status: 'approved',
                                    amount: currentOrder.totalPrice,
                                    method: 'razorpay',
                                    transactionId: response.razorpay_payment_id,
                                    paidAt: serverTimestamp(),
                                    type: 'monthly',
                                    slotsPurchased: currentOrder.slots
                                },
                                isPaid: true,
                                extraSlots: increment(currentOrder.slots), // ðŸ‘ˆ Adds Monthly Slots
                                lastPaymentId: response.razorpay_payment_id
                            });

                            // Legacy Renewal Logic (Only for Monthly)
                            if (typeof expiredNursesList !== 'undefined' && expiredNursesList.length > 0) {
                                const days30 = 30 * 24 * 60 * 60 * 1000;
                                const renewalPromises = expiredNursesList.map(nurse => {
                                    const nurseRef = doc(db, "users", currentUser.uid, "nurses", nurse.id);

                                    // ðŸŸ¢ FIX: Also update 'type' to 'monthly' so the badge turns Blue!
                                    return updateDoc(nurseRef, {
                                        validUntil: Date.now() + days30,
                                        type: 'monthly'  // <--- THIS IS THE KEY LINE
                                    });
                                });
                                await Promise.all(renewalPromises);
                                expiredNursesList = [];
                            }
                        }

                        // --- B. INTERN SALES TRACKING ---
                        if (referrerCode && referrerCode !== "DIRECT") {
                            const q = query(collection(db, "users"), where("agencyName", "==", referrerCode));
                            const internSnap = await getDocs(q);

                            if (!internSnap.empty) {
                                internSnap.forEach(async (internDoc) => {
                                    await updateDoc(doc(db, "users", internDoc.id), {
                                        sales: increment(1),
                                        totalRevenue: increment(currentOrder.totalPrice)
                                    });
                                });
                            }
                        }

                        // --- C. SUCCESS UI ---
                        alert(`âœ… Payment Successful! ${currentOrder.slots} ${currentOrder.type === 'daily' ? 'Daily Passes' : 'Monthly Slots'} added.`);
                        document.getElementById('modal-payment-lock').style.display = 'none';

                        // Refresh the Add Modal Credits Display immediately
                        if (typeof window.updateCreditDisplay === 'function') {
                            window.updateCreditDisplay();
                        }

                        // Reload data
                        if (currentUser) startDataSync(currentUser.uid);

                    } catch (error) {
                        console.error("Activation Error:", error);
                        alert("Payment received but update failed. ID: " + response.razorpay_payment_id);
                    }
                },
                "prefill": {
                    "name": currentUser?.displayName || "",
                    "email": currentUser?.email || "",
                    "contact": currentUser?.phoneNumber || ""
                },
                "theme": {
                    "color": "#ff9933"
                },
                "modal": {
                    "ondismiss": function () {
                        console.log('Payment cancelled');
                    }
                }
            };

            const rzp1 = new Razorpay(options);
            rzp1.on('payment.failed', function (response) {
                alert("âŒ Payment Failed: " + response.error.description);
            });
            rzp1.open();
        };
        // --- UPDATED ONBOARDING (Preserves Lead Logic + Auto-Payment) ---
        window.submitOnboarding = async () => {
            const agencyName = document.getElementById('inp-agency-name').value;
            let referralCode = document.getElementById('inp-referral-code').value;

            if (!agencyName) return alert("Enter Agency Name");

            // Normalize code to uppercase
            referralCode = referralCode ? referralCode.toUpperCase().trim() : "DIRECT";

            try {
                const btn = document.querySelector('#modal-onboarding .btn-primary');
                if (btn) btn.innerText = "Setting up...";

                // 1. Create/Update the Agency Profile
                await setDoc(doc(db, "users", currentUser.uid), {
                    agencyName: agencyName,
                    referralBy: referralCode,
                    email: currentUser.email,
                    createdAt: serverTimestamp(),
                    leadStatus: 'captured', // Mark so we don't count leads twice
                    nurseCount: 0,
                    extraSlots: 0
                }, { merge: true });

                // 2. INCREMENT INTERN LEAD COUNT (If code exists)
                if (referralCode !== "DIRECT") {
                    // Find the intern who owns this Agency Name/Code
                    const q = query(collection(db, "users"), where("agencyName", "==", referralCode));
                    const snapshot = await getDocs(q);

                    if (!snapshot.empty) {
                        snapshot.forEach(async (internDoc) => {
                            await updateDoc(doc(db, "users", internDoc.id), {
                                leads: increment(1) // ðŸŸ¢ +1 Lead instantly
                            });
                        });
                    }
                }

                // 3. Hide Modal & Refresh Admin Access
                document.getElementById('modal-onboarding').style.display = 'none';
                if (window.checkAdminAccess) window.checkAdminAccess(currentUser);

                // 4. ðŸ‘‡ TRIGGER PAYMENT SCREEN IMMEDIATELY ðŸ‘‡
                // Using 'true' ensures the user sees "Activate Your Account" 
                // without an unnecessary "Limit Reached" alert.
                setTimeout(() => {
                    if (typeof window.openModal === 'function') {
                        window.openModal(true);
                    }
                }, 500);

            } catch (e) {
                console.error("Onboarding Error:", e);
                alert("Error saving profile: " + e.message);
                const btn = document.querySelector('#modal-onboarding .btn-primary');
                if (btn) btn.innerText = "Continue";
            }
        };

        // --- FUNCTION: Close Payment Modal (Cancel/Skip) ---
        window.activatePayLater = () => {
            // 1. Hide the payment modal
            document.getElementById('modal-payment-lock').style.display = 'none';

            // 2. Ensure dashboard data is synced so the user can see their current staff
            if (currentUser) {
                startDataSync(currentUser.uid);
            }
        };

        // ==========================================
        // ðŸ‘‘ SUPER ADMIN LOGIC
        // ==========================================
        const SUPER_ADMIN_EMAIL = "supercare655@gmail.com";

        window.checkAdminAccess = (user) => {
            if (user.email === SUPER_ADMIN_EMAIL) {
                console.log("ðŸ‘‘ SUPER ADMIN");
                document.getElementById('nav-super-admin').style.display = 'flex';

                // Hide Payment/Onboarding Modals for Admin
                document.getElementById('modal-payment-lock').style.display = 'none';
                document.getElementById('modal-onboarding').style.display = 'none';

                // Hide normal nav items
                document.querySelectorAll('.nav-item:not(#nav-super-admin):not([onclick="logoutApp()"])')
                    .forEach(el => el.style.display = 'none');

                // Switch to Admin View
                switchTab('super-admin');
                loadAdminData();
            }
        }


        // --- UPDATED ADMIN LOADER (Shows Slots + Daily Passes) ---
        function loadAdminData() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                const allTable = document.getElementById('admin-all-users');
                const leaderboardDiv = document.getElementById('admin-leaderboard');

                // âœ… Save data for CSV Export
                allAgencies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Clear existing data
                if (allTable) allTable.innerHTML = '';
                if (leaderboardDiv) leaderboardDiv.innerHTML = '';

                // Clear pending table
                const pendingTable = document.getElementById('admin-pending-table');
                if (pendingTable) pendingTable.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999; padding:20px;">Automated Payments Active (No Pending Actions)</td></tr>';

                let referralCounts = {};

                snapshot.docs.forEach(doc => {
                    const u = doc.data();

                    // --- 1. DATA PREP ---
                    const usedSlots = u.nurseCount || 0;
                    const paidSlots = u.extraSlots || 0;
                    const dailyPasses = u.dailyPasses || 0; // ðŸ‘ˆ NEW: Get Daily Pass Count

                    // Calculate Bar Percentage
                    let percentage = 0;
                    if (paidSlots > 0) percentage = Math.min((usedSlots / paidSlots) * 100, 100);

                    const barColor = usedSlots >= paidSlots ? '#e65100' : '#138808';

                    // --- 2. BUILD THE DISPLAY HTML ---
                    let slotDisplay = '';

                    if (u.plan === 'unlimited') {
                        slotDisplay = `<span style="color:#e65100; font-weight:bold;">ðŸ’Ž Unlimited</span>`;
                    } else {
                        // ðŸŸ¢ HYBRID DISPLAY: Slots Bar + Daily Pass Badge
                        slotDisplay = `
                    <div style="font-size:0.85rem; font-weight:600; color:#333; margin-bottom:4px;">
                        ${usedSlots} / ${paidSlots} Slots
                    </div>
                    <div style="height:6px; width:100px; background:#e0e0e0; border-radius:3px; overflow:hidden; margin-bottom:6px;">
                        <div style="height:100%; width:${percentage}%; background:${barColor};"></div>
                    </div>
                    
                    
                    <div style="font-size:0.75rem; color:#666; font-weight:500; display:flex; align-items:center; gap:5px;">
                        <i class="fa-solid fa-ticket" style="color:#ff9933;"></i> ${dailyPasses} Daily Passes Available
                    </div>
                `;
                    }

                    // --- 3. LEADERBOARD ---
                    if (u.referralBy && u.referralBy !== "DIRECT") {
                        if (!referralCounts[u.referralBy]) referralCounts[u.referralBy] = { total: 0, paid: 0 };
                        referralCounts[u.referralBy].total += 1;
                        if (u.isPaid) referralCounts[u.referralBy].paid += 1;
                    }

                    // --- 4. STATUS ---
                    let statusHtml = '<span style="color:#c62828; background:#ffebee; padding:4px 8px; border-radius:12px; font-size:0.7rem; font-weight:600;">LOCKED</span>';
                    if (u.isPaid) {
                        statusHtml = '<span style="color:#1b5e20; background:#e8f5e9; padding:4px 8px; border-radius:12px; font-size:0.7rem; font-weight:600;">ACTIVE</span>';
                    }

                    // --- 5. RENDER ROW ---
                    allTable.innerHTML += `
                <tr style="border-bottom:1px solid #f0f0f0;">
                    <td style="padding:15px 10px;">
                        <div style="font-weight:bold; color:var(--navy); font-size:0.95rem;">${u.agencyName || 'Incomplete Profile'}</div>
                        <div style="font-size:0.8rem; color:#666; margin-top:2px;">${u.email}</div>
                    </td>
                    <td style="padding:15px 10px; vertical-align:middle;">
                        ${slotDisplay}
                    </td>
                    <td style="padding:15px 10px; font-weight:500; color:#555;">
                        ${u.referralBy || 'DIRECT'}
                    </td>
                    <td style="padding:15px 10px;">
                        ${statusHtml}
                    </td>
                    <td style="padding:15px 10px; text-align:right;">
                        <button onclick="viewAgencyDetails('${doc.id}', '${u.agencyName || 'Agency'}')" 
                            style="background: white; border: 1px solid #ccc; color: var(--navy); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition:0.2s;">
                            View Staff <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </td>
                </tr>`;
                });

                // (Leaderboard rendering code remains the same...)
                Object.keys(referralCounts).forEach(code => {
                    const data = referralCounts[code];
                    leaderboardDiv.innerHTML += `
                <div class="card stat-card" style="border-top: 4px solid ${data.paid > 0 ? '#138808' : '#999'}; padding:1rem;">
                    <div style="font-size: 1.1rem; font-weight: bold; color:var(--navy);">${code}</div>
                    <div style="display:flex; gap:10px; margin-top:12px;">
                        <div style="flex:1; background:#f5f5f5; padding:8px; border-radius:8px; text-align:center;">
                            <div style="font-size:1.3rem; font-weight:700; color:#138808; line-height:1;">${data.paid}</div>
                            <div style="font-size:0.65rem; color:#666; font-weight:600; margin-top:4px;">SALES</div>
                        </div>
                        <div style="flex:1; background:#f5f5f5; padding:8px; border-radius:8px; text-align:center;">
                            <div style="font-size:1.3rem; font-weight:700; color:#333; line-height:1;">${data.total}</div>
                            <div style="font-size:0.65rem; color:#666; font-weight:600; margin-top:4px;">LEADS</div>
                        </div>
                    </div>
                </div>`;
                });
            });
        }

        // ðŸŸ¢ NEW FUNCTION: View Specific Agency Staff (Admin Side)
        window.viewAgencyDetails = async (agencyId, agencyName) => {
            // 1. Open Modal & Set Title
            const modal = document.getElementById('adminAgencyModal');
            document.getElementById('admin-view-title').innerText = agencyName || "Agency Details";
            document.getElementById('admin-view-subtitle').innerText = "Fetching real-time data...";
            modal.classList.add('active');

            const listContainer = document.getElementById('admin-staff-list');
            listContainer.innerHTML = '<div style="padding:20px; text-align:center;"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading...</div>';

            try {
                // 2. Fetch Nurses for this Agency
                const q = query(collection(db, "users", agencyId, "nurses"));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    listContainer.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No staff found.</p>';
                    document.getElementById('adm-count-active').innerText = "0";
                    document.getElementById('adm-count-expired').innerText = "0";
                    return;
                }

                // 3. Sort Logic (Active vs Expired)
                const now = Date.now();
                const active = [];
                const expired = [];

                snapshot.forEach(doc => {
                    const n = doc.data();
                    // Default to 7 days grace if validUntil is missing
                    const expiry = n.validUntil || (now + (7 * 24 * 60 * 60 * 1000));

                    if (expiry < now) {
                        expired.push(n);
                    } else {
                        active.push(n);
                    }
                });

                // 4. Update Counts
                document.getElementById('adm-count-active').innerText = active.length;
                document.getElementById('adm-count-expired').innerText = expired.length;

                // 5. Generate HTML
                let html = '';

                // --- SECTION A: EXPIRED (Red Box) ---
                if (expired.length > 0) {
                    html += `<div style="background:#ffebee; border:1px solid #ffcdd2; border-radius:8px; padding:10px; margin-bottom:10px;">
                <h5 style="color:#c62828; margin-bottom:8px;"><i class="fa-solid fa-triangle-exclamation"></i> EXPIRED STAFF</h5>`;

                    expired.forEach(n => {
                        const isDaily = n.type === 'daily';
                        const badge = isDaily
                            ? '<span style="background:#fff3e0; color:#e65100; font-size:0.7rem; padding:2px 6px; border-radius:4px; border:1px solid #ffe0b2;">Daily</span>'
                            : '<span style="background:#e3f2fd; color:#1565c0; font-size:0.7rem; padding:2px 6px; border-radius:4px; border:1px solid #bbdefb;">Monthly</span>';

                        html += `
                <div style="background:white; padding:8px; border-radius:6px; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:600; color:#333;">${n.name} ${badge}</div>
                        <div style="font-size:0.75rem; color:#666;">${n.role}</div>
                    </div>
                    <div style="font-size:0.75rem; color:#c62828; font-weight:700;">Expired</div>
                </div>`;
                    });
                    html += `</div>`;
                }

                // --- SECTION B: ACTIVE (Normal List) ---
                if (active.length > 0) {
                    html += `<h5 style="color:#2e7d32; margin:10px 0 5px 0;">âœ… ACTIVE STAFF</h5>`;

                    active.forEach(n => {
                        const isDaily = n.type === 'daily';

                        // Badges
                        const badgeStyle = isDaily
                            ? 'background:#fff3e0; color:#ef6c00; border:1px solid #ffe0b2;'
                            : 'background:#e3f2fd; color:#1565c0; border:1px solid #bbdefb;';
                        const typeText = isDaily ? 'Daily Pass' : 'Monthly Slot';

                        // Time Left Calc
                        const daysLeft = Math.ceil((n.validUntil - now) / (1000 * 60 * 60 * 24));
                        const timeText = isDaily
                            ? '< 24 Hours'
                            : `${daysLeft} Days left`;

                        html += `
                <div style="background:#f9f9f9; padding:10px; border-radius:8px; border-left: 4px solid ${isDaily ? '#ff9800' : '#138808'}; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:600; color:#333;">${n.name}</div>
                        <span style="font-size:0.7rem; padding:2px 6px; border-radius:4px; font-weight:600; display:inline-block; margin-top:2px; ${badgeStyle}">
                            ${typeText}
                        </span>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:0.8rem; font-weight:600; color:#333;">â‚¹${n.rate}</div>
                        <div style="font-size:0.7rem; color:${isDaily ? '#e65100' : '#138808'};">${timeText}</div>
                    </div>
                </div>`;
                    });
                }

                listContainer.innerHTML = html;

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<p style="color:red; text-align:center;">Error loading data.</p>';
            }
        };
        window.exportToCSV = () => {
            // 1. Check if it is the Super Admin
            if (currentUser && currentUser.email === "supercare655@gmail.com") {

                if (!allAgencies || allAgencies.length === 0) {
                    alert("No agency data found to export.");
                    return;
                }

                // 2. Prepare Agency Data
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Agency Name,Email,Referral Code,Used Slots,Paid Slots,Status,Total Revenue (INR)\n";

                allAgencies.forEach(agency => {
                    const safeName = (agency.agencyName || "Unknown").replace(/,/g, " ");
                    const status = agency.isPaid ? "PAID ACTIVE" : "LOCKED";

                    // âœ… NEW MATH LOGIC:
                    // If they are paid, Revenue = Total Slots * 199. Otherwise 0.
                    const revenue = agency.isPaid ? (agency.extraSlots * 199) : 0;

                    const row = [
                        safeName,
                        agency.email,
                        agency.referralBy || "DIRECT",
                        agency.nurseCount || 0,
                        agency.extraSlots || 0,
                        status,
                        revenue // ðŸ‘ˆ Shows calculated amount (e.g., 1990)
                    ];
                    csvContent += row.join(",") + "\n";
                });

                // 3. Download File
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `SuperAdmin_Report_${new Date().toISOString().slice(0, 10)}.csv`);
                document.body.appendChild(link);
                link.click();
                link.remove();
                return;
            }

            // --- NORMAL USER EXPORT (Kept same as before) ---
            if (!allNurses || allNurses.length === 0) {
                alert("No staff data to export.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Name,Phone,Role,Daily Rate (INR),Status,Validity Expires\n";

            allNurses.forEach(nurse => {
                const now = Date.now();
                const days30 = 30 * 24 * 60 * 60 * 1000;
                const expiry = nurse.validUntil || (now + (7 * days30));
                const isExpired = expiry < now;

                const status = isExpired ? "Expired" : "Active";
                const expiryDate = new Date(expiry).toLocaleDateString();
                const safeName = nurse.name.replace(/,/g, " ");

                const row = [
                    safeName,
                    nurse.phone,
                    nurse.role,
                    nurse.rate,
                    status,
                    expiryDate
                ];
                csvContent += row.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `SilverCare_Staff_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            link.remove();
        };
        // ==========================================
        // ðŸ‘¤ PROFILE MODAL LOGIC (NEW)
        // ==========================================

        // ==========================================
        // ðŸ‘¤ PROFILE, TABS & CALENDAR LOGIC
        // ==========================================

        // 1. OPEN PROFILE
        window.openProfile = async (id) => {
            currentNurseId = id;
            const nurse = allNurses.find(n => n.id === id);
            if (!nurse) return;

            // Fill Info
            document.getElementById('p-name').innerText = nurse.name;
            document.getElementById('p-role').innerText = nurse.role;

            // Fill Edit Form
            document.getElementById('edit-id').value = nurse.id;
            document.getElementById('edit-name').value = nurse.name;
            document.getElementById('edit-phone').value = nurse.phone;
            document.getElementById('edit-rate').value = nurse.rate;
            document.getElementById('edit-role').value = nurse.role;

            // RESET Calendar to Today & Render
            currentCalDate = new Date();
            renderCalendar();

            // Load Docs
            loadDocuments(id);

            // Show Modal & Switch to first tab
            document.getElementById('profileModal').classList.add('active');
            window.switchProfileTab('attendance');
        };

        // 2. SWITCH TABS (Keep this!)
        window.switchProfileTab = (tab) => {
            // Reset buttons and content
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Activate clicked tab
            // Note: We search for the button that has the onclick handler for this specific tab
            const btn = Array.from(document.querySelectorAll('.tab-btn'))
                .find(b => b.getAttribute('onclick').includes(tab));

            if (btn) btn.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        };


        // CALENDAR LOGIC
        window.changeMonth = (offset) => {
            currentCalDate.setMonth(currentCalDate.getMonth() + offset);
            renderCalendar();
        };

        // NEW: Change Year
        window.changeYear = (offset) => {
            currentCalDate.setFullYear(currentCalDate.getFullYear() + offset);
            renderCalendar();
        };

        function renderCalendar() {
            const container = document.getElementById('cal-days-container');

            // Update Text
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('cal-month-text').innerText = monthNames[currentCalDate.getMonth()];
            document.getElementById('cal-year-text').innerText = currentCalDate.getFullYear();

            container.innerHTML = `
        <div class="cal-day-header">Sun</div><div class="cal-day-header">Mon</div>
        <div class="cal-day-header">Tue</div><div class="cal-day-header">Wed</div>
        <div class="cal-day-header">Thu</div><div class="cal-day-header">Fri</div>
        <div class="cal-day-header">Sat</div>
    `;

            const year = currentCalDate.getFullYear();
            const month = currentCalDate.getMonth();
            const firstDayIndex = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Get Presence Data
            const presentDays = allLogs
                .filter(l => l.nurseId === currentNurseId)
                .filter(l => {
                    const d = new Date(l.timestamp);
                    return d.getMonth() === month && d.getFullYear() === year;
                })
                .map(l => new Date(l.timestamp).getDate());

            const today = new Date();
            const isTodayMonth = today.getMonth() === month && today.getFullYear() === year;

            // Empty Slots
            for (let x = 0; x < firstDayIndex; x++) {
                const empty = document.createElement('div');
                empty.classList.add('cal-day', 'empty');
                container.appendChild(empty);
            }

            // Days
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('cal-day');
                dayEl.innerText = i;

                if (isTodayMonth && i === today.getDate()) dayEl.classList.add('today');

                if (presentDays.includes(i)) {
                    dayEl.classList.add('present');
                    dayEl.title = "Present";
                } else {
                    // Only mark absent if passed
                    let checkDate = new Date(year, month, i);
                    if (checkDate < new Date().setHours(0, 0, 0, 0)) {
                        dayEl.classList.add('absent');
                    }
                }
                container.appendChild(dayEl);
            }
        }
        // --- DOCUMENT LOCKER LOGIC ---
        async function loadDocuments(nurseId) {
            const list = document.getElementById('doc-list');
            list.innerHTML = '<p style="color:#999; text-align:center;">Loading...</p>';

            // Fetch Docs from Subcollection
            const q = query(collection(db, "users", currentUser.uid, "nurses", nurseId, "documents"), orderBy("uploadedAt", "desc"));
            const snapshot = await getDocs(q);

            list.innerHTML = '';
            if (snapshot.empty) {
                list.innerHTML = '<p style="color:#999; text-align:center; font-size:0.8rem; margin-top:10px;">No documents yet.</p>';
                return;
            }

            snapshot.forEach(docSnap => {
                const d = docSnap.data();
                list.innerHTML += `
        <div class="doc-item">
            <div class="doc-icon"><i class="fa-solid fa-file-contract"></i></div>
            <div style="flex:1; overflow:hidden;">
                <div style="font-weight:600; font-size:0.9rem;">${d.name}</div>
                <div style="font-size:0.7rem; color:#888;">${new Date(d.uploadedAt).toLocaleDateString()}</div>
            </div>
            <a href="${d.data}" download="${d.name}" style="color:var(--primary); margin-right:15px;"><i class="fa-solid fa-download"></i></a>
            <button onclick="window.deleteDoc('${docSnap.id}')" style="color:#ff4444; background:none; border:none; cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
        </div>`;
            });
        }

        // Upload Listener
        const uploadInput = document.getElementById('doc-upload');
        if (uploadInput) {
            uploadInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file || !currentNurseId) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const base64 = event.target.result;
                    await addDoc(collection(db, "users", currentUser.uid, "nurses", currentNurseId, "documents"), {
                        name: file.name,
                        data: base64,
                        uploadedAt: Date.now()
                    });
                    loadDocuments(currentNurseId); // Refresh UI
                };
                reader.readAsDataURL(file);
            });
        }

        window.deleteDoc = async (docId) => {
            if (confirm('Delete this document permanently?')) {
                await deleteDoc(doc(db, "users", currentUser.uid, "nurses", currentNurseId, "documents", docId));
                loadDocuments(currentNurseId);
            }
        };

        // --- EDIT PROFILE SUBMIT ---
        const editForm = document.getElementById('editNurseForm');
        if (editForm) {
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-id').value;

                await updateDoc(doc(db, "users", currentUser.uid, "nurses", id), {
                    name: document.getElementById('edit-name').value,
                    phone: document.getElementById('edit-phone').value,
                    rate: document.getElementById('edit-rate').value,
                    role: document.getElementById('edit-role').value
                });

                alert('Profile Updated Successfully!');
                // Update Modal Title instantly
                document.getElementById('p-name').innerText = document.getElementById('edit-name').value;
                document.getElementById('p-role').innerText = document.getElementById('edit-role').value;
            });
        }

        // ==========================================
        // ðŸ› ï¸ HELPER FUNCTIONS (Render, Camera, Etc)
        // ==========================================

        window.loginWithGoogle = () => {
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            signInWithPopup(auth, provider).catch(err => alert("Login Failed: " + err.message));
        };

        window.logoutApp = () => {
            signOut(auth).then(() => window.location.reload());
        };

        // --- HELPER: Generate Star HTML ---
        function getStarRatingHTML(rating, count) {
            // 1. If no rating, show "New" badge
            if (!rating || count === 0) {
                return `<div class="star-row"><span class="new-badge">New Staff</span></div>`;
            }

            // 2. Round to nearest 0.5 (e.g., 4.3 -> 4.5, 4.1 -> 4.0)
            const rounded = Math.round(rating * 2) / 2;
            let stars = '';

            // 3. Loop 5 times to create full, half, or empty stars
            for (let i = 1; i <= 5; i++) {
                if (rounded >= i) {
                    stars += '<i class="fa-solid fa-star"></i>'; // Full Star
                } else if (rounded >= i - 0.5) {
                    stars += '<i class="fa-solid fa-star-half-stroke"></i>'; // Half Star
                } else {
                    stars += '<i class="fa-regular fa-star" style="color:#ddd;"></i>'; // Empty Star (Grey)
                }
            }

            // 4. Return the complete HTML
            return `
        <div class="star-row" title="Average Rating: ${rating}">
            ${stars}
            <span class="rating-text">(${count} reviews)</span>
        </div>
    `;
        }
        // Global State for Bulk Actions
        let isManageMode = false;
        let selectedNurses = new Set();
        // --- FINAL RENDER FUNCTION (Clean UI + Fixed Buttons) ---
        function renderStaffList() {
            const grid = document.getElementById('staff-grid');
            grid.innerHTML = '';

            const now = Date.now();
            const msPerDay = 24 * 60 * 60 * 1000;

            allNurses.forEach(nurse => {
                // 1. Initials
                const names = nurse.name.split(' ');
                const initials = names.length > 1 ? names[0][0] + names[1][0] : names[0][0];

                // 2. Expiry Logic (Prioritize validUntil from DB)
                let expiry = nurse.validUntil;
                if (!expiry) {
                    // Fallback: If DB value is missing, use CreatedAt + 30 Days
                    const start = nurse.createdAt || now;
                    expiry = start + (30 * msPerDay);
                }

                const daysLeft = Math.ceil((expiry - now) / msPerDay);

                // 3. Colors & Text
                let statusColor = '#138808'; // Green
                let statusText = `${daysLeft} Days Left`;

                if (daysLeft <= 0) {
                    statusColor = '#d32f2f'; // Red
                    statusText = "EXPIRED";
                } else if (daysLeft <= 5) {
                    statusColor = '#ff9933'; // Orange
                    statusText = `${daysLeft} Days (Renew Soon)`;
                }

                // 4. Badge Logic (Daily vs Monthly)
                const isDaily = nurse.type === 'daily';
                const badgeHtml = isDaily
                    ? `<span style="background:#fff3e0; color:#e65100; font-size:0.6rem; padding:2px 6px; border-radius:4px; border:1px solid #ffe0b2; margin-left:6px; vertical-align:middle; font-weight:bold;">DAILY</span>`
                    : `<span style="background:#e3f2fd; color:#1565c0; font-size:0.6rem; padding:2px 6px; border-radius:4px; border:1px solid #bbdefb; margin-left:6px; vertical-align:middle; font-weight:bold;">MONTHLY</span>`;

                // 5. Checkbox & Rating
                const checkDisplay = isManageMode ? 'flex' : 'none';
                const isChecked = selectedNurses.has(nurse.id) ? 'checked' : '';
                const rating = nurse.rating || 4.5;
                const reviewCount = nurse.reviewCount || 12;
                const starHTML = getStarRatingHTML(rating, reviewCount);

                // ðŸŸ¢ FIXED BUTTONS: Side-by-Side, No Overlap, Always Visible
                const actionButtonsHtml = `
                <div style="position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; z-index: 20;">
                    
                    <button onclick="openReplaceModal('${nurse.id}', '${nurse.name}', ${nurse.validUntil})" 
                        title="Replace Staff"
                        style="width: 32px; height: 32px; border-radius: 50%; border: none; 
                               background: #e3f2fd; color: #1565c0; cursor: pointer; 
                               display: flex; align-items: center; justify-content: center; 
                               box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: 0.2s;">
                        <i class="fa-solid fa-arrow-right-arrow-left"></i>
                    </button>
                    
                    <button onclick="window.removeNurse('${nurse.id}')"
                        title="Delete Permanently"
                        class="delete-btn-force"
                        style="width: 32px; height: 32px; border-radius: 50%; border: none; 
                               background: #ffebee; color: #c62828; cursor: pointer; 
                               display: flex; align-items: center; justify-content: center; 
                               box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: 0.2s;
                               opacity: 1; visibility: visible;">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>`;

                // Render Card
                grid.innerHTML += `
    <div class="card nurse-card" style="display: flex; flex-direction: column; height: 100%; min-height: 280px; position: relative;">
        
        <div style="display: ${checkDisplay}; position: absolute; top: 12px; left: 12px; z-index: 10;">
            <input type="checkbox" style="width: 20px; height: 20px; accent-color: #d32f2f; cursor: pointer;" 
                ${isChecked} onchange="toggleSelection('${nurse.id}')">
        </div>

        ${actionButtonsHtml}

        <div style="flex: 1;">
            <div class="nurse-header" style="margin-top: 25px;">
                <div class="nurse-avatar">${initials}</div>
                <div class="nurse-info">
                    <h3 style="margin-bottom:2px; display:flex; align-items:center;">
                        ${nurse.name} 
                        ${badgeHtml}
                    </h3>
                    <p style="font-size:0.85rem; color:#666;">${nurse.role}</p>
                    ${starHTML}
                </div>
            </div>

            <div class="metrics-row">
                <div class="metric">
                    <span class="metric-val">â‚¹${nurse.rate}</span>
                    <span class="metric-lbl">Daily Rate</span>
                </div>
                <div class="metric">
                    <span class="metric-val" style="color:${statusColor}; font-size:0.9rem;">
                        ${statusText}
                    </span>
                    <span class="metric-lbl">Validity</span>
                </div>
            </div>
        </div>

        <button class="btn-profile" onclick="window.openProfile('${nurse.id}')" 
            style="margin-top: 20px; width: 100%; background: #e3f2fd; color: #1565c0; 
                   border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer;">
            View Profile
        </button>
    </div>`;
            });
        }

        function populateLoginSelect() {
            const sel = document.getElementById('nurse-login-select');
            sel.innerHTML = '<option value="">-- Select Name --</option>';
            allNurses.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n.id;
                opt.innerText = n.name;
                sel.appendChild(opt);
            });
        }

        function renderDashboardLogs() {
            const grid = document.getElementById('dashboard-grid');
            grid.innerHTML = '';

            // Show message if empty
            if (!allLogs || allLogs.length === 0) {
                grid.innerHTML = '<p style="color:#999; grid-column:1/-1; text-align:center;">No activity today.</p>';
                return;
            }

            // Show top 3
            allLogs.slice(0, 3).forEach(log => {
                grid.innerHTML += createLogCard(log);
            });
        }

        function renderAllLogs() {
            const container = document.getElementById('logs-list-container');
            container.innerHTML = '';

            // Show message if empty
            if (!allLogs || allLogs.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:3rem; color:#999;">
                        <i class="fa-solid fa-clipboard-list" style="font-size:3rem; margin-bottom:1rem; opacity:0.3;"></i>
                        <p>No attendance logs found.</p>
                    </div>`;
                return;
            }

            allLogs.forEach(log => {
                container.innerHTML += createLogCard(log);
            });
        }

        function createLogCard(log) {
            // Safety check for data
            const timestamp = log.timestamp || Date.now();
            const nurseName = log.nurseName || "Unknown Staff";
            const photoUrl = log.photo || "https://via.placeholder.com/60";
            const locationText = log.address || "GPS Location Recorded";

            const dateObj = new Date(timestamp);

            // Format Time (e.g., 09:30 AM)
            const timeStr = dateObj.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });

            // Format Date (e.g., OCT 24)
            const dateStr = dateObj.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });

            // Sanitize data for the onclick function to prevent syntax errors with quotes
            const safeName = nurseName.replace(/'/g, "\\'");
            const safeTime = `${dateStr}, ${timeStr}`;

            return `
            <div class="log-card">
                <div class="log-time-box">
                    <div class="log-time-big">${timeStr}</div>
                    <div class="log-date-small">${dateStr}</div>
                    <div style="font-size:0.65rem; color:#138808; font-weight:bold; margin-top:2px;">REACHED</div>
                </div>

                <div class="log-photo-frame" onclick="viewImage('${photoUrl}', '${safeName}', '${safeTime}')">
                    <img src="${photoUrl}" class="log-photo" alt="Selfie">
                    <div style="position:absolute; bottom:-5px; right:-5px; background:white; border-radius:50%; padding:4px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                        <i class="fa-solid fa-magnifying-glass-plus" style="font-size:0.7rem; color:var(--primary);"></i>
                    </div>
                </div>

                <div class="log-details">
                    <h4>${nurseName}</h4>
                    <div class="log-location">
                        <i class="fa-solid fa-location-dot" style="color:#d32f2f; margin-top:3px;"></i>
                        <span>${locationText}</span>
                    </div>
                </div>
            </div>`;
        }

        window.viewImage = (src, name, time) => {
            const modal = document.getElementById('img-viewer-modal');
            const img = document.getElementById('img-viewer-full');
            const cap = document.getElementById('img-viewer-caption');

            img.src = src;
            cap.innerHTML = `<b>${name}</b> â€¢ Checked in at ${time}`;
            modal.style.display = 'flex';
        };

        window.closeImageViewer = () => {
            document.getElementById('img-viewer-modal').style.display = 'none';
        };

        window.closeImageViewer = () => {
            document.getElementById('img-viewer-modal').style.display = 'none';
        };
        // Function to save the "Paid" status to Firebase
        window.togglePayout = async (nurseId, monthSuffix, isChecked) => {
            // Unique ID for this payment: "NurseID_MonthYear"
            const docId = `${nurseId}_${monthSuffix}`;
            const docRef = doc(db, "users", currentUser.uid, "payouts", docId);

            if (isChecked) {
                // Create the record
                await setDoc(docRef, {
                    paidAt: serverTimestamp(),
                    nurseId: nurseId,
                    month: monthSuffix
                });
            } else {
                // Delete the record (Uncheck)
                await deleteDoc(docRef);
            }
        };
        window.calculatePayroll = () => {
            const tbody = document.getElementById('payroll-table-body');
            const picker = document.getElementById('payroll-month-picker');

            tbody.innerHTML = '';
            let totalPayroll = 0;

            // 1. Get the target Month & Year from the picker
            let targetDate = picker.value ? new Date(picker.value + "-01") : new Date();

            // If picker was empty, set it to today
            if (!picker.value) {
                const yyyy = targetDate.getFullYear();
                const mm = String(targetDate.getMonth() + 1).padStart(2, '0');
                picker.value = `${yyyy}-${mm}`;
            }

            const tMonth = targetDate.getMonth();
            const tYear = targetDate.getFullYear();

            // Generate a unique key for this month (e.g., "2025-12")
            const monthKeySuffix = `${tYear}-${String(tMonth + 1).padStart(2, '0')}`;

            allNurses.forEach(nurse => {
                // 2. Count days worked in that specific month
                const daysWorked = allLogs.filter(l => {
                    const d = new Date(l.timestamp);
                    return l.nurseId === nurse.id && d.getMonth() === tMonth && d.getFullYear() === tYear;
                }).length;

                const salary = daysWorked * (parseInt(nurse.rate) || 0);
                totalPayroll += salary;

                // 3. CHECK STATUS: Is this nurse paid for this specific month?
                // We look for a key like: "nurseID_2025-12"
                const payoutId = `${nurse.id}_${monthKeySuffix}`;
                const isPaid = allPayouts.includes(payoutId);

                // 4. Render the Row with the Checkbox
                tbody.innerHTML += `
                    <tr>
                        <td><b>${nurse.name}</b></td>
                        <td>â‚¹${nurse.rate}</td>
                        <td>${daysWorked}</td>
                        <td style="color:var(--primary); font-weight:bold;">â‚¹${salary}</td>
                        <td style="text-align:center;">
                            <input type="checkbox" 
                                   class="paid-checkbox" 
                                   style="width: 20px; height: 20px; accent-color: #ff9933; cursor: pointer;"
                                   ${isPaid ? "checked" : ""} 
                                   onchange="togglePayout('${nurse.id}', '${monthKeySuffix}', this.checked)">
                        </td>
                    </tr>`;
            });
            document.getElementById('stat-payroll-total').innerText = 'â‚¹' + totalPayroll;
        };

        // --- CAMERA & LOCATION ---
        window.startCamera = async () => {
            try {
                const video = document.getElementById('video-feed');
                currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                video.srcObject = currentStream;
                getLocation();
            } catch (e) { alert("Camera Access Denied"); }
        };

        window.stopCamera = () => { if (currentStream) currentStream.getTracks().forEach(track => track.stop()); };

        window.getLocation = () => {
            const status = document.getElementById('location-status');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    status.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Finding Address...`;
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                        const data = await res.json();
                        window.currentLocation = { lat, lng, address: data.display_name.split(',').slice(0, 3).join(',') };
                        status.innerHTML = `<i class="fa-solid fa-check"></i> ${window.currentLocation.address}`;
                    } catch (e) { status.innerHTML = "GPS Recorded"; window.currentLocation = { lat, lng, address: "GPS Only" }; }
                });
            }
        };

        window.performCheckIn = async () => {
            if (!currentUser) return alert("Error: No User");
            const nurseId = document.getElementById('nurse-login-select').value;
            if (!nurseId) return alert("Select Name");

            const video = document.getElementById('video-feed');
            const canvas = document.getElementById('canvas-capture');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            await addDoc(collection(db, "users", currentUser.uid, "attendance"), {
                nurseId: nurseId,
                nurseName: allNurses.find(n => n.id === nurseId).name,
                timestamp: Date.now(),
                photo: canvas.toDataURL('image/jpeg', 0.5),
                address: window.currentLocation?.address || "Unknown"
            });
            alert("Check-in Success!");
            window.toggleMode();
        };

        // --- UPDATED FORM SUBMISSION (Dual Write: Dashboard + Bot) ---
        document.getElementById('addNurseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // 1. GET FORM VALUES
            const planType = document.querySelector('input[name="staffPlan"]:checked').value;
            const name = document.getElementById('nurseName').value;
            const phone = document.getElementById('nursePhone').value;
            const role = document.getElementById('nurseSpec').value;
            const rate = document.getElementById('nurseRate').value;

            // 2. CHECK CREDITS
            const extraSlots = currentUserData?.extraSlots || 0;
            const usedSlots = allNurses.filter(n => !n.type || n.type === 'monthly').length;
            const monthlyLeft = extraSlots - usedSlots;
            const dailyPasses = currentUserData?.dailyPasses || 0;

            // A. Block if no Monthly Slots
            if (planType === 'monthly' && monthlyLeft <= 0) {
                alert("âš ï¸ No Monthly Slots Available!\n\nPlease click the 'Buy More' button above to purchase slots.");
                return;
            }

            // B. Block if no Daily Passes
            if (planType === 'daily' && dailyPasses <= 0) {
                alert("âš ï¸ No Daily Passes Available!\n\nPlease click the 'Buy More' button above to purchase a pass.");
                return;
            }

            // 3. CALCULATE EXPIRY DATE
            let expiryDate;
            if (planType === 'monthly') {
                // ðŸ—“ï¸ Monthly: Today + 30 Days
                expiryDate = Date.now() + (30 * 24 * 60 * 60 * 1000);
            } else {
                // ðŸ—“ï¸ Daily: Today + 24 Hours
                expiryDate = Date.now() + (24 * 60 * 60 * 1000);
            }

            try {
                // 4. PREPARE BATCH WRITE
                const batch = writeBatch(db);

                // A. Generate Unique ID (Use Root Collection to ensure global uniqueness)
                const newNurseRef = doc(collection(db, "nurses"));
                const nurseId = newNurseRef.id;

                // B. Create References for Dual Write
                const agencyNurseRef = doc(db, "users", currentUser.uid, "nurses", nurseId); // Dashboard View
                const rootNurseRef = doc(db, "nurses", nurseId); // Bot View

                // C. Prepare Data Object
                const nurseData = {
                    name,
                    phone,
                    role,
                    rate,
                    timestamp: Date.now(),
                    validUntil: expiryDate,
                    type: planType,
                    status: "offline", // Initial status for bot
                    agencyId: currentUser.uid, // Link back to Agency
                    agencyName: currentUserData.agencyName || "Silver Care Agency"
                };

                // D. Queue the Writes
                batch.set(agencyNurseRef, nurseData);
                batch.set(rootNurseRef, nurseData);

                // 5. CONSUME THE CORRECT CREDIT (In the same batch)
                const agencyUserRef = doc(db, "users", currentUser.uid);

                if (planType === 'monthly') {
                    batch.update(agencyUserRef, {
                        nurseCount: increment(1)
                    });
                } else {
                    batch.update(agencyUserRef, {
                        dailyPasses: increment(-1)
                    });
                }

                // 6. COMMIT ALL CHANGES AT ONCE
                await batch.commit();

                // 7. SUCCESS FEEDBACK
                alert(`âœ… Staff Added Successfully!\nActive on WhatsApp Bot.\nValidity: ${planType === 'monthly' ? '30 Days' : '24 Hours'}`);
                window.closeModal();
                e.target.reset();

            } catch (err) {
                console.error("Error adding staff:", err);
                alert("Error saving data: " + err.message);
            }
        });


        // --- 1. TOAST FUNCTION (Replaces alert) ---
        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            // Set Icon and Color
            const icon = type === 'success' ? '<i class="fa-solid fa-circle-check" style="color:#4caf50;"></i>' : '<i class="fa-solid fa-circle-xmark" style="color:#d32f2f;"></i>';
            const borderClass = type === 'success' ? '' : 'error';

            toast.className = `toast ${borderClass}`;
            toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div class="toast-msg">${message}</div>
    `;

            container.appendChild(toast);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        };

        // --- 2. CONFIRM MODAL LOGIC ---
        let confirmCallback = null;

        window.showConfirmDialog = (title, message, callback) => {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerHTML = message;

            confirmCallback = callback;
            document.getElementById('confirmModal').classList.add('active');
        };

        window.closeConfirmModal = () => {
            document.getElementById('confirmModal').classList.remove('active');
            confirmCallback = null;
        };

        // Bind the YES button
        document.getElementById('confirm-btn-yes').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            closeConfirmModal();
        });
        // --- STRICT DELETE (No Refunds - "Buy Again" Model) ---
        window.removeNurse = (id) => {
            // 1. Define the Warning Message
            const title = "Delete Staff?";
            const msg = `
        <strong style="color:#d32f2f;">Warning: Action cannot be undone.</strong><br>
        Deleting this staff member will remove them permanently from the Dashboard AND the Bot.<br><br>
        <span style="font-size:0.85rem; background:#ffebee; padding:4px 8px; border-radius:4px; color:#c62828;">
           âš ï¸ You will <b>NOT</b> get the slot or pass back.
        </span>
    `;

            // 2. Trigger Custom Modal
            
            window.showConfirmDialog(title, msg, async () => {
                try {
                    // A. Check the Nurse Type first (from Agency view)
                    const agencyDocRef = doc(db, "users", currentUser.uid, "nurses", id);
                    const agencyDocSnap = await getDoc(agencyDocRef);

                    if (!agencyDocSnap.exists()) {
                        window.showToast("Error: Staff not found in dashboard.", 'error');
                        return;
                    }

                    const nurseData = agencyDocSnap.data();
                    const isMonthly = !nurseData.type || nurseData.type === 'monthly'; 

                    // B. PREPARE BATCH DELETE
                    const batch = writeBatch(db);

                    // 1. Delete from Agency View (Dashboard)
                    batch.delete(agencyDocRef);

                    // 2. Delete from Bot View (Root Collection)
                    const rootDocRef = doc(db, "nurses", id);
                    batch.delete(rootDocRef);

                    // C. Update Counters (BURN LOGIC)
                    const agencyRef = doc(db, "users", currentUser.uid);

                    if (isMonthly) {
                        // ðŸ”¥ Monthly: Burn the slot so they lose it
                        batch.update(agencyRef, {
                            nurseCount: increment(-1), // Remove from active count
                            extraSlots: increment(-1)  // Remove from total limit
                        });
                    } else {
                        // ðŸŽ« Daily: Do NOTHING.
                        // The pass was already subtracted when added. 
                        // By not adding it back, they effectively "lose" it.
                    }

                    // D. COMMIT ALL OPERATIONS
                    await batch.commit();

                    // E. Success Message
                    window.showToast("Staff deleted from Dashboard & Bot.");

                } catch (error) {
                    console.error(error);
                    window.showToast("Error deleting: " + error.message, 'error');
                }
            });
        };

        // --- NAVIGATION ---
        let isNurseMode = false;
        window.toggleMode = () => {
            isNurseMode = !isNurseMode;
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active-view'));

            if (isNurseMode) {
                document.getElementById('view-nurse').classList.add('active-view');
                document.getElementById('mode-text').innerText = "Admin Dashboard";
                document.getElementById('admin-menu').style.display = 'none';
                window.startCamera();
            } else {
                document.getElementById('view-dashboard').classList.add('active-view');
                document.getElementById('mode-text').innerText = "Nurse App";
                document.getElementById('admin-menu').style.display = 'flex';
                window.stopCamera();
            }
        };

        window.switchTab = (tab) => {
            if (isNurseMode) return;
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const nav = document.getElementById(`nav-${tab}`);
            if (nav) nav.classList.add('active');

            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active-view'));
            const view = document.getElementById(`view-${tab}`);
            view.classList.add('active-view');

            // ðŸ‘‡ ADD THIS NEW BLOCK ðŸ‘‡
            // If opening Payroll, run calculation immediately to set default date
            if (tab === 'war-room') window.loadWarRoom();

            if (tab === 'payroll') {
                window.calculatePayroll();
            }
        };

        window.showLogin = () => {
            document.getElementById('public-landing').style.display = 'none';
            document.getElementById('login-overlay').style.display = 'flex';
        };


        // --- NEW FUNCTION: Show List of Present Nurses ---
        window.showPresentToday = () => {
            const today = new Date().toDateString();

            // 1. Get logs for today
            const todaysLogs = allLogs.filter(l => new Date(l.timestamp).toDateString() === today);

            // 2. Get unique names to avoid duplicates
            const names = [...new Set(todaysLogs.map(l => l.nurseName))];

            // 3. Show Alert with names
            if (names.length === 0) {
                alert("ðŸ“… No attendance marked today yet.");
            } else {
                alert(`âœ… Present Today (${names.length}):\n\nâ€¢ ` + names.join("\nâ€¢ "));
            }
        };
        // --- WAR ROOM LOGIC (Updated with Expiry Gatekeeper) ---
        let warRoomInterval = null;
        let unsubscribeWarRoom = null;
        let logListeners = [];

        window.loadWarRoom = () => {
            // 1. GATEKEEPER CHECK
            if (typeof expiredNursesList !== 'undefined' && expiredNursesList.length > 0) {
                showRenewalModal(expiredNursesList);
                return;
            }

            // 2. Clean up previous listeners
            if (warRoomInterval) clearInterval(warRoomInterval);
            if (unsubscribeWarRoom) unsubscribeWarRoom();
            logListeners.forEach(unsub => unsub());
            logListeners = [];

            // 3. Query Active AND Completed Bookings
            const q = query(
                collection(db, "bookings"),
                // Added 'completed' to this list so they don't vanish instantly
                where("status", "in", ["assigned", "nurse_arrived", "in_progress", "completed"]),
                orderBy("timestamp", "desc")
            );

            unsubscribeWarRoom = onSnapshot(q, (snapshot) => {
                const grid = document.getElementById('war-room-grid');
                if (!grid) return;
                grid.innerHTML = '';

                if (snapshot.empty) {
                    grid.innerHTML = `<div class="empty-state"><i class="fa-solid fa-mug-hot" style="font-size: 3rem; margin-bottom: 1rem; color:#ccc;"></i><h3>All Quiet</h3><p>No active deployments.</p></div>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const b = doc.data();
                    const bid = doc.id;
                    const status = b.status;

                    // ðŸ›‘ FILTER: If completed more than 24 hours ago, hide it.
                    if (status === 'completed' && b.completedAt) {
                        const oneDay = 24 * 60 * 60 * 1000;
                        if (Date.now() - b.completedAt > oneDay) return;
                    }

                    // Render Card IDs
                    const cardId = `card-${bid}`;
                    const logsId = `logs-${bid}`;

                    // --- STATUS & TIMELINE LOGIC ---
                    // s1=Assigned, s2=Arrived, s3=Started
                    let s1 = '', s2 = '', s3 = '';

                    if (status === 'assigned') { s1 = 'active'; }
                    else if (status === 'nurse_arrived') { s1 = 'done'; s2 = 'active'; }
                    else if (status === 'in_progress') { s1 = 'done'; s2 = 'done'; s3 = 'active'; }
                    else if (status === 'completed') { s1 = 'done'; s2 = 'done'; s3 = 'done'; }

                    // Timer Logic
                    let timerHtml = '';
                    if (status === 'in_progress' && b.startedAt) {
                        timerHtml = `<div class="war-timer" data-start="${b.startedAt}">00h 00m 00s</div>`;
                    } else if (status === 'completed') {
                        timerHtml = `<span style="color:#757575; font-weight:bold;">COMPLETED</span>`;
                    } else {
                        timerHtml = `<span style="color:#ff9933; font-size:0.8rem;">En Route...</span>`;
                    }

                    const html = `
            <div class="war-card status-${status}" id="${cardId}">
                <div class="war-header">
                    <div>
                        <h3 style="margin:0; color:var(--navy); font-size:1.1rem;">${b.assignedNurseName}</h3>
                        <span style="font-size:0.75rem; color:#666;">${b.patient_details || 'Patient'}</span>
                    </div>
                    ${timerHtml}
                </div>
                <div class="war-body">
                    <div style="margin-bottom:15px;">
                         <div style="font-weight:600; font-size:0.85rem; margin-bottom:5px; color:#444;">Status:</div>
                         <div style="background:#f9f9f9; padding:10px; border-radius:8px; border:1px solid #eee;">
                            <div class="war-step ${s1}"><i class="fa-solid fa-circle-check"></i> Booked & Assigned</div>
                            <div class="war-step ${s2}"><i class="fa-solid fa-location-dot"></i> Arrived at Home</div>
                            <div class="war-step ${s3}"><i class="fa-solid fa-user-nurse"></i> <b>Care in Progress</b></div>
                         </div>
                    </div>
                    
                    <div style="font-size:0.8rem; font-weight:bold; color:#555; margin-bottom:5px; margin-top:15px; border-top:1px dashed #eee; padding-top:10px;">
                        ðŸ“ Live Nurse Logs
                    </div>
                    <div class="vitals-container" id="${logsId}">
                        <div style="text-align:center; color:#ccc; padding:10px;">Waiting for nurse updates...</div>
                    </div>

                    <div style="display:flex; justify-content:space-between; margin-top:15px; align-items:center;">
                        <a href="tel:${b.clientPhone}" class="client-pill" style="margin:0;"><i class="fa-solid fa-phone"></i> Call Client</a>
                        <button class="btn-report" onclick="window.generateShiftReport('${bid}')">
                            <i class="fa-solid fa-file-pdf"></i> Report
                        </button>
                    </div>
                </div>
            </div>`;

                    grid.innerHTML += html;

                    // 4. LISTEN FOR LOGS (Sub-collection)
                    const logsQuery = query(collection(db, "bookings", bid, "logs"), orderBy("timestamp", "desc"), limit(10)); // Increased limit to 10

                    const unsubLogs = onSnapshot(logsQuery, (logSnap) => {
                        const logContainer = document.getElementById(logsId);
                        if (!logContainer) return;

                        if (logSnap.empty) {
                            logContainer.innerHTML = '<div style="text-align:center; color:#ccc; padding:10px;">No logs yet.</div>';
                        } else {
                            logContainer.innerHTML = ''; // Clear loading text
                            logSnap.forEach(lDoc => {
                                const l = lDoc.data();
                                const time = new Date(l.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                                let contentClass = l.is_critical ? 'log-critical' : '';

                                // 1. Get the TEXT note (Summary or Raw Text)
                                let mainText = l.summary || l.raw_text || "Update logged.";

                                // 2. Get the VITALS data (if exists)
                                let vitalsHtml = '';
                                if (l.vitals) {
                                    let parts = [];
                                    if (l.vitals.bp) parts.push(`BP: ${l.vitals.bp}`);
                                    if (l.vitals.temp) parts.push(`Temp: ${l.vitals.temp}`);
                                    if (l.vitals.sugar) parts.push(`Sugar: ${l.vitals.sugar}`);
                                    if (l.vitals.spo2) parts.push(`SpO2: ${l.vitals.spo2}`);

                                    if (parts.length > 0) {
                                        vitalsHtml = `<br><span class="log-vitals-badge">${parts.join(' | ')}</span>`;
                                    }
                                }

                                // 3. Render Combined
                                logContainer.innerHTML += `
                        <div class="log-item">
                            <div class="log-time">${time}</div>
                            <div class="log-content ${contentClass}">
                                ${mainText}
                                ${vitalsHtml}
                            </div>
                        </div>`;
                            });
                        }
                    });
                    logListeners.push(unsubLogs);
                });

                // Restart Timer Interval
                if (warRoomInterval) clearInterval(warRoomInterval);
                warRoomInterval = setInterval(updateWarTimers, 1000);
            });
        };
        function updateWarTimers() {
            document.querySelectorAll('.war-timer').forEach(el => {
                const start = parseInt(el.getAttribute('data-start'));
                if (!start) return;
                const diff = Date.now() - start;

                const hrs = Math.floor(diff / (1000 * 60 * 60));
                const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((diff % (1000 * 60)) / 1000);

                el.innerText = `${hrs}h ${mins}m ${secs}s`;
            });
        }

        // ... existing updateWarTimers code is above here ...

        // ðŸ‘‡ PASTE THIS MISSING FUNCTION HERE ðŸ‘‡

        // --- GENERATE PDF REPORT ---
        window.generateShiftReport = async (bookingId) => {
            const { jsPDF } = window.jspdf;

            // 1. Fetch Data
            try {
                // Get Booking Details
                const bookingSnap = await getDoc(doc(db, "bookings", bookingId));
                if (!bookingSnap.exists()) return alert("Booking not found!");
                const booking = bookingSnap.data();

                // Get Medical Logs (Ordered by time)
                const logsQuery = query(collection(db, "bookings", bookingId, "logs"), orderBy("timestamp", "asc"));
                const logsSnap = await getDocs(logsQuery);

                // 2. Setup PDF
                const docPdf = new jsPDF();

                // --- HEADER ---
                docPdf.setFillColor(255, 153, 51); // Saffron Color
                docPdf.rect(0, 0, 210, 20, 'F');   // Header Bar
                docPdf.setTextColor(255, 255, 255);
                docPdf.setFontSize(16);
                docPdf.setFont("helvetica", "bold");
                docPdf.text("Silver Care - Shift Report", 15, 13);

                // --- PATIENT DETAILS ---
                docPdf.setTextColor(0, 0, 0);
                docPdf.setFontSize(10);
                docPdf.setFont("helvetica", "normal");

                docPdf.text(`Patient Name: ${booking.patient_details || 'N/A'}`, 15, 30);
                docPdf.text(`Assigned Nurse: ${booking.assignedNurseName}`, 15, 36);
                docPdf.text(`Shift Date: ${new Date(booking.timestamp).toDateString()}`, 15, 42);
                docPdf.text(`Location: ${booking.location || 'Home Care'}`, 15, 48);

                // --- VITALS & LOGS TABLE ---
                const tableData = [];

                if (logsSnap.empty) {
                    // Handle empty logs
                    tableData.push(["-", "No updates recorded yet.", "-"]);
                } else {
                    logsSnap.forEach(snap => {
                        const l = snap.data();
                        const time = new Date(l.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                        // Format Vitals Column
                        let vitals = "-";
                        if (l.vitals) {
                            let parts = [];
                            if (l.vitals.bp) parts.push(`BP: ${l.vitals.bp}`);
                            if (l.vitals.temp) parts.push(`Temp: ${l.vitals.temp}`);
                            if (l.vitals.sugar) parts.push(`Sugar: ${l.vitals.sugar}`);
                            if (l.vitals.spo2) parts.push(`SpO2: ${l.vitals.spo2}%`);
                            vitals = parts.join(', ');
                        }

                        // Format Summary Column
                        let summary = l.summary || l.raw_text || "Routine Check";
                        if (l.is_critical) summary = "[ALERT] " + summary;

                        tableData.push([time, summary, vitals]);
                    });
                }

                // Generate Table
                docPdf.autoTable({
                    startY: 55,
                    head: [['Time', 'Observation / Action', 'Vitals Recorded']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [0, 51, 102], // Navy Blue
                        textColor: 255
                    },
                    styles: { fontSize: 9 },
                    columnStyles: {
                        0: { cellWidth: 30 }, // Time
                        1: { cellWidth: 'auto' }, // Observation
                        2: { cellWidth: 50 }  // Vitals
                    }
                });

                // --- FOOTER ---
                const finalY = docPdf.lastAutoTable.finalY || 60;
                docPdf.setFontSize(8);
                docPdf.setTextColor(150);
                docPdf.text("Generated automatically by Silver Care AI System", 15, finalY + 10);
                docPdf.text(`Report ID: ${bookingId}`, 15, finalY + 15);

                // Save File
                docPdf.save(`SilverCare_Report_${booking.assignedNurseName}_${Date.now()}.pdf`);

            } catch (e) {
                console.error("PDF Generation Error:", e);
                alert("Failed to generate report. See console for details.");
            }
        };
        // --- 1. MANAGE MODE TOGGLE ---
        window.toggleManageMode = () => {
            isManageMode = !isManageMode;
            selectedNurses.clear(); // Clear selections when toggling
            updateBulkUI();
            renderStaffList();
        };

        window.toggleSelection = (id) => {
            if (selectedNurses.has(id)) selectedNurses.delete(id);
            else selectedNurses.add(id);
            updateBulkUI();
        };

        function updateBulkUI() {
            const bar = document.getElementById('bulk-action-bar');
            const countSpan = document.getElementById('selected-count');

            if (isManageMode && selectedNurses.size > 0) {
                bar.style.display = 'flex';
                countSpan.innerText = selectedNurses.size;
            } else {
                bar.style.display = 'none';
            }
        }

        // --- 2. BULK DELETE LOGIC ---
        window.bulkDelete = async () => {
            if (!confirm(`Delete ${selectedNurses.size} staff members permanently?`)) return;

            try {
                const batchPromises = Array.from(selectedNurses).map(id =>
                    deleteDoc(doc(db, "users", currentUser.uid, "nurses", id))
                );

                await Promise.all(batchPromises);

                // Update Counter
                await updateDoc(doc(db, "users", currentUser.uid), {
                    nurseCount: increment(-selectedNurses.size)
                });

                alert("Selected staff deleted.");
                window.toggleManageMode(); // Exit manage mode

            } catch (e) {
                console.error(e);
                alert("Error deleting: " + e.message);
            }
        };

        // --- 3. REPLACE STAFF LOGIC (The Swap) ---
        window.openReplaceModal = (id, name, validUntil) => {
            // 1. Set the hidden ID
            const hiddenInput = document.getElementById('replace-old-id');
            if (hiddenInput) hiddenInput.value = id;

            // 2. Calculate Days Remaining
            const now = Date.now();
            const msPerDay = 24 * 60 * 60 * 1000;
            // Handle case where validUntil might be undefined (legacy data)
            const targetDate = validUntil || (now + (7 * msPerDay));
            const daysLeft = Math.ceil((targetDate - now) / msPerDay);

            // 3. Build the Message HTML
            const displayHtml = `
        You are replacing <b style="color:var(--navy);">${name}</b>.<br>
        <span style="display:inline-block; margin-top:8px; color:#1565c0; background:#e3f2fd; padding:4px 8px; border-radius:4px; font-weight:600; font-size:0.85rem;">
            <i class="fa-solid fa-clock-rotate-left"></i> The new staff member will inherit <u>${daysLeft} Days</u> of validity.
        </span>
    `;

            // 4. âœ… SAFE UPDATE: Targets the correct ID 'replace-message'
            const msgBox = document.getElementById('replace-message');
            if (msgBox) {
                msgBox.innerHTML = displayHtml;
                document.getElementById('replaceModal').classList.add('active');
            } else {
                console.error("Error: Could not find element #replace-message. Please check your HTML.");
            }
        };

       // --- SMART REPLACE (Dual Write: Dashboard + Bot) ---
       document.getElementById('replaceNurseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const oldId = document.getElementById('replace-old-id').value;
        const btn = e.target.querySelector('button');
        const originalBtnText = btn.innerHTML; // Store original button content
        
        btn.innerText = "Swapping...";
        btn.disabled = true;

        try {
            // 1. Get Old Data (We need to copy the Validity & Plan Type)
            const oldAgencyRef = doc(db, "users", currentUser.uid, "nurses", oldId);
            const oldSnap = await getDoc(oldAgencyRef);

            if (!oldSnap.exists()) throw new Error("Original staff not found.");
            const oldData = oldSnap.data();

            // 2. Prepare Batch Operation
            const batch = writeBatch(db);

            // --- STEP A: DELETE OLD NURSE (Revoke Access) ---
            // 1. Delete from Dashboard
            batch.delete(oldAgencyRef); 
            // 2. Delete from Bot (Global) - This stops the old number from working
            batch.delete(doc(db, "nurses", oldId)); 

            // --- STEP B: CREATE NEW NURSE (Grant Access) ---
            // Generate a NEW ID for the new person (globally unique)
            const newNurseRef = doc(collection(db, "nurses"));
            const newId = newNurseRef.id;

            const newNurseData = {
                name: document.getElementById('repName').value,
                phone: document.getElementById('repPhone').value, // New WhatsApp Number
                role: document.getElementById('repRole').value,
                rate: document.getElementById('repRate').value,
                timestamp: Date.now(),
                
                // ðŸ›‘ CRITICAL: Inherit Validity from Old Nurse
                validUntil: oldData.validUntil, 
                type: oldData.type || 'monthly', 

                // Bot Fields
                status: "offline",
                agencyId: currentUser.uid,
                agencyName: currentUserData.agencyName || "Silver Care Agency"
            };

            // 3. Add to Dashboard (using the new ID)
            const newAgencyRef = doc(db, "users", currentUser.uid, "nurses", newId);
            batch.set(newAgencyRef, newNurseData);
            
            // 4. Add to Bot (Global) - This activates the new number
            const newGlobalRef = doc(db, "nurses", newId);
            batch.set(newGlobalRef, newNurseData);

            // --- STEP C: COMMIT ---
            await batch.commit();

            // 3. Success Feedback
            alert(`âœ… Staff Replaced Successfully!\n\nâ€¢ Old Number: Access Revoked\nâ€¢ New Number: Active on Bot\nâ€¢ Validity: Preserved`);
            document.getElementById('replaceModal').classList.remove('active');
            e.target.reset();

        } catch (error) {
            console.error(error);
            alert("Error: " + error.message);
        } finally {
            btn.innerHTML = originalBtnText; // Restore original button text/icon
            btn.disabled = false;
        }
    });
        // --- 4. REDIRECT HELPER ---
        window.openPaymentModal = (preferredPlan) => {
            // Hide the add form
            document.getElementById('addModal').classList.remove('active');

            // Show the payment screen
            document.getElementById('modal-payment-lock').style.display = 'flex';

            // Auto-select the plan they need (Monthly or Daily)
            if (window.switchPlan) {
                window.switchPlan(preferredPlan);
            }
        };
        window.openPaymentFromForm = () => {
            // 1. Get current selection to know what they want to buy
            const planType = document.querySelector('input[name="staffPlan"]:checked').value;

            // 2. Hide Add Form
            document.getElementById('addModal').classList.remove('active');

            // 3. Open Payment Screen
            document.getElementById('modal-payment-lock').style.display = 'flex';

            // 4. Switch the store tab to match
            if (window.switchPlan) window.switchPlan(planType);
        };

        // Define these globally so HTML buttons can see them
        window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
            'size': 'invisible'
        });

        window.sendOTP = () => {
            const phoneNumber = document.getElementById('phone-number').value;
            const appVerifier = window.recaptchaVerifier;

            signInWithPhoneNumber(auth, phoneNumber, appVerifier)
                .then((confirmationResult) => {
                    window.confirmationResult = confirmationResult;
                    document.getElementById('step-phone').style.display = 'none';
                    document.getElementById('step-otp').style.display = 'block';
                    window.showToast("OTP Sent!", "success");
                }).catch((error) => {
                    console.error(error);
                    window.showToast("Error sending OTP: " + error.message, "error");
                });
        };

        window.verifyOTP = () => {
            const code = document.getElementById('otp-code').value;
            window.confirmationResult.confirm(code).then((result) => {
                // User signed in successfully.
                window.showToast("Verified Success!", "success");
                // onAuthStateChanged will handle the rest
            }).catch((error) => {
                window.showToast("Invalid OTP", "error");
            });
        };
    </script>
</body>

</html>
