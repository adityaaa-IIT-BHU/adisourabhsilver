<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silver Seva | Care Management</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Rozha+One&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-main: #fffdf5;
            --bg-panel: #ffffff;
            --primary: #ff9933;
            /* Saffron */
            --primary-hover: #e68a00;
            --accent: #138808;
            /* India Green */
            --text-dark: #1a1a1a;
            --text-muted: #666666;
            --navy: #003366;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-main);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(255, 153, 51, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(19, 136, 8, 0.05) 0%, transparent 20%);
            color: var(--text-dark);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Layout --- */
        .app-container {
            display: grid;
            grid-template-columns: 260px 1fr;
            min-height: 100vh;
        }

        /* --- Sidebar --- */
        .sidebar {
            background: var(--bg-panel);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.02);
            height: 100vh;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .logo {
            font-family: 'Rozha One', serif;
            font-size: 1.8rem;
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .nav-menu {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .nav-item {
            padding: 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #fff5e6;
            color: var(--primary-hover);
            border-left: 4px solid var(--primary);
        }

        /* --- Main Content --- */
        .main-content {
            padding: 2rem 3rem;
            overflow-y: auto;
            position: relative;
        }

        /* Views */
        .view-section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .view-section.active-view {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
        }

        .page-title h1 {
            font-family: 'Rozha One', serif;
            font-size: 2.5rem;
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .namaste-icon {
            color: var(--primary);
            font-size: 2rem;
        }

        .page-title p {
            color: var(--text-muted);
            font-size: 1rem;
            margin-top: 5px;
        }

        /* --- Buttons & Inputs --- */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #ff7700);
            color: white;
            border: none;
            padding: 0.8rem 1.8rem;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 15px rgba(255, 153, 51, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 153, 51, 0.4);
        }

        .btn-mode {
            background: var(--navy);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            border: none;
            cursor: pointer;
            margin-bottom: 1rem;
            width: 100%;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
            transition: 0.2s;
        }

        .btn-icon:hover {
            color: #ff4444;
        }

        /* --- Stats & Cards --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .card {
            background: var(--bg-panel);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0, 0, 0, 0.02);
            transition: transform 0.3s ease;
        }

        .stat-card {
            border-top: 4px solid var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
            color: var(--navy);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .icon-circle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            background: #fff5e6;
            color: var(--primary);
            font-size: 1.2rem;
        }

        /* --- Nurse Grid --- */
        .nurse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .nurse-card {
            position: relative;
            border-top: 4px solid transparent;
            transition: 0.3s;
        }

        .nurse-card:hover {
            border-top: 4px solid var(--accent);
            transform: translateY(-3px);
        }

        .delete-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            opacity: 0;
            transition: 0.2s;
        }

        .nurse-card:hover .delete-btn {
            opacity: 1;
        }

        .nurse-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .nurse-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f0f0f0, #e0e0e0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--navy);
            font-weight: 700;
            position: relative;
            border: 2px solid white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .status-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-online {
            background: var(--accent);
        }

        .status-busy {
            background: #ff4444;
        }

        .status-offline {
            background: #ccc;
        }

        .nurse-info h3 {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--navy);
        }

        .metrics-row {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed #eee;
        }

        .metric-val {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
            text-align: center;
        }

        .metric-lbl {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            display: block;
            text-align: center;
        }

        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            color: var(--navy);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 0.8rem;
            border-radius: 8px;
            color: #333;
            outline: none;
        }

        .form-input:focus {
            border-color: var(--primary);
            background: #fff;
        }

        .close-modal {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* --- Camera & Nurse App Specifics --- */
        .cam-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            margin-bottom: 1rem;
            border: 4px solid var(--navy);
        }

        video {
            width: 100%;
            height: 350px;
            object-fit: cover;
        }

        /* --- Payroll Table --- */
        .simple-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .simple-table th {
            text-align: left;
            padding: 1rem;
            background: #fff5e6;
            color: var(--navy);
            border-radius: 8px 8px 0 0;
        }

        .simple-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            font-size: 0.95rem;
        }

        /* --- Doc Locker Preview --- */
        .doc-box {
            border: 2px dashed #ccc;
            padding: 1rem;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            color: #777;
        }

        .doc-box:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .om-symbol {
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 10rem;
            opacity: 0.03;
            pointer-events: none;
            color: var(--primary);
            font-family: 'Rozha One', serif;
        }

        /* --- New Login UI Styles --- */
        .login-container {
            background: linear-gradient(135deg, #fffdf5 0%, #fff7e6 100%);
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Animated Background Shapes */
        .shape {
            position: absolute;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 10s infinite ease-in-out;
        }

        .shape-1 {
            top: -10%;
            right: -10%;
            width: 500px;
            height: 500px;
            background: #ff9933;
            animation-delay: 0s;
        }

        .shape-2 {
            bottom: -10%;
            left: -10%;
            width: 400px;
            height: 400px;
            background: #138808;
            animation-delay: 2s;
        }

        .shape-3 {
            top: 40%;
            left: 40%;
            width: 300px;
            height: 300px;
            background: #003366;
            opacity: 0.1;
            animation-delay: 4s;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(30px, 50px);
            }
        }

        /* Glass Card */
        .login-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 32px;
            padding: 4rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 51, 102, 0.15);
            position: relative;
            animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-logo {
            font-size: 4rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #ff9933, #003366);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: pulse 3s infinite;
        }

        /* Google Button */
        .google-btn {
            width: 100%;
            background: white;
            border: 2px solid #f0f0f0;
            padding: 1rem;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            color: #333;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 2rem;
            position: relative;
            overflow: hidden;
        }

        .google-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            border-color: #ff9933;
        }

        .google-btn:active {
            transform: scale(0.98);
        }

        /* Decorative Elements */
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #ddd, transparent);
            margin: 2rem 0;
            width: 100%;
        }

        .secure-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #f0f9ff;
            color: #003366;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 2rem;
        }

        /* Update .login-card width */
        .login-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 1);
            border-radius: 24px;
            padding: 3.5rem;
            /* More breathing room */
            width: 100%;
            max-width: 480px;
            /* Wider for desktop */
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        /* New Input Styles */
        .input-label {
            display: block;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
            color: #444;
            margin-bottom: 8px;
            margin-left: 4px;
        }

        .input-group {
            display: flex;
            gap: 0;
            /* Connected inputs */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            border-radius: 12px;
        }

        .modern-input {
            flex: 1;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-right: none;
            border-radius: 12px 0 0 12px;
            font-size: 1rem;
            outline: none;
            background: #fff;
            transition: 0.2s;
        }

        .modern-input:focus {
            border-color: var(--primary);
            background: #fffdf5;
        }

        .input-btn {
            border-radius: 0 12px 12px 0;
            padding: 0 1.5rem;
            margin: 0;
            box-shadow: none;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        /* Link Text */
        .link-text {
            font-size: 0.8rem;
            color: #666;
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.2s;
        }

        .link-text:hover {
            color: var(--primary);
        }

        /* Fix Divider */
        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 2rem 0;
            color: #aaa;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #eee;
        }

        .divider span {
            padding: 0 15px;
        }

        /* --- FIX: Hide Floating ReCAPTCHA Badge --- */
        .grecaptcha-badge {
            visibility: hidden;
        }

        /* 1. Make the overlay cover the WHOLE screen */
        .login-overlay {
            position: fixed;
            /* üëà This is the key */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            /* üëà Ensures it's above everything */
        }

        /* 2. Style the White Card inside */
        .login-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideUp 0.3s ease-out;
        }

        /* 3. Small animation to make it pop */
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        /* --- Profile Modal Styles --- */
.profile-tabs { display: flex; background: #f5f5f5; border-radius: 10px; padding: 4px; margin-bottom: 1.5rem; }
.tab-btn { flex: 1; border: none; background: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #666; transition: 0.3s; }
.tab-btn.active { background: white; color: var(--navy); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Calendar */
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
.cal-day-header { text-align: center; font-size: 0.75rem; color: #888; padding-bottom: 5px; }
.cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.9rem; background: #f9f9f9; color: #ccc; }
.cal-day.present { background: #e8f5e9; color: #2e7d32; font-weight: bold; border: 1px solid #c8e6c9; }
.cal-day.absent { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
.cal-day.today { border: 2px solid var(--primary); }

/* Document Locker */
.doc-item { display: flex; align-items: center; gap: 10px; background: #fff; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-bottom: 8px; }
.doc-icon { width: 40px; height: 40px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #1565c0; }
.btn-profile { width: 100%; margin-top: 10px; background: #e3f2fd; color: #1565c0; border: none; padding: 8px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    </style>
</head>

<body>
    <div id="public-landing"
        style="background: linear-gradient(135deg, #fffdf5 0%, #fff7e6 100%); min-height: 100vh; display: flex; flex-direction: column;">

        <nav style="padding: 1.5rem 3rem; display: flex; justify-content: space-between; align-items: center;">
            <div
                style="font-family: 'Rozha One', serif; font-size: 1.8rem; color: #003366; display: flex; align-items: center; gap: 10px;">
                <i class="fa-solid fa-hands-holding-circle" style="color: #ff9933;"></i> Silver Seva
            </div>
            <button onclick="showLogin()" class="btn-primary" style="padding: 0.6rem 1.5rem; font-size: 0.9rem;">
                Member Login <i class="fa-solid fa-arrow-right-to-bracket"></i>
            </button>
        </nav>

        <div
            style="flex: 1; display: flex; align-items: center; justify-content: center; text-align: center; padding: 2rem;">
            <div style="max-width: 800px;">
                <span
                    style="background: #e0f2f1; color: #00695c; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                    INDIA'S #1 AGENCY SOFTWARE
                </span>
                <h1
                    style="font-family: 'Rozha One', serif; font-size: 3.5rem; color: #003366; margin: 1.5rem 0; line-height: 1.2;">
                    Manage Your Nursing Staff <br><span style="color: #ff9933;">With Zero Headaches</span>
                </h1>
                <p style="font-size: 1.1rem; color: #666; margin-bottom: 2.5rem; line-height: 1.6;">
                    Automated Attendance, Payroll, and Client Bookings for Nursing Bureaus & Home Care Agencies.
                    Verify staff with GPS and get instant WhatsApp alerts.
                </p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="showLogin()" class="btn-primary" style="padding: 1rem 2.5rem; font-size: 1.1rem;">
                        Login
                    </button>
                </div>
            </div>
        </div>

        <footer style="background: white; padding: 3rem; border-top: 1px solid #eee; margin-top: auto;">
            <div style="max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">

                <div>
                    <h4 style="color: #003366; margin-bottom: 1rem;">Contact Us</h4>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                        <i class="fa-solid fa-envelope"></i> silvercare242@gmail.com
                    </p>
                    <p style="color: #666; font-size: 0.9rem;">
                        <i class="fa-solid fa-phone"></i> +91 8299341343
                    </p>
                    <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">
                        <i class="fa-solid fa-location-dot"></i> Varanasi, Uttar Pradesh, India
                    </p>
                </div>

                <div style="text-align: right;">
                    <h4 style="color: #003366; margin-bottom: 1rem;">Legal</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                        <a href="terms.html" target="_blank"
                            style="color: #666; text-decoration: none; font-size: 0.9rem;">Terms & Conditions</a>
                        <a href="privacy.html" target="_blank"
                            style="color: #666; text-decoration: none; font-size: 0.9rem;">Privacy Policy</a>
                        <a href="refund.html" target="_blank"
                            style="color: #666; text-decoration: none; font-size: 0.9rem;">Refund & Cancellation
                            Policy</a>
                        <a href="pricing.html" target="_blank"
                            style="color: #666; text-decoration: none; font-size: 0.9rem;">Pricing</a>
                        <a href="contact.html" target="_blank"
                            style="color: #666; text-decoration: none; font-size: 0.9rem;">Contact Us</a>
                    </div>
                </div>
            </div>
            <div
                style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px dashed #eee; font-size: 0.8rem; color: #aaa;">
                ¬© 2025 Silver Seva Technologies. All rights reserved.
            </div>
        </footer>
    </div>

    <div id="login-overlay" class="login-container">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>

        <div class="login-card">
            <div class="secure-badge">
                <i class="fa-solid fa-shield-halved"></i> Secure Staff Portal
            </div>

            <h1 class="login-logo" style="font-family: 'Rozha One', serif;">Silver Seva</h1>
            <p style="color: #555; font-size: 1rem; margin-bottom: 2.5rem;">
                Log in to manage staff, payroll, and bookings.
            </p>

            <div id="phone-auth-section">
                <div id="recaptcha-container"></div>

                <div id="step-phone">
                    <label class="input-label">Mobile Number</label>
                    <div class="input-group">
                        <input type="tel" id="phone-number" class="modern-input" placeholder="+91 98765 43210">
                        <button onclick="sendOTP()" id="send-otp-btn" class="btn-primary input-btn">
                            Send OTP
                        </button>
                    </div>
                </div>

                <div id="step-otp" style="display: none;">
                    <label class="input-label">One Time Password</label>
                    <div class="input-group">
                        <input type="text" id="otp-code" class="modern-input" placeholder="Enter 6-digit code"
                            maxlength="6" style="letter-spacing: 3px; font-weight: 700;">
                        <button onclick="verifyOTP()" id="verify-otp-btn" class="btn-primary input-btn"
                            style="background: var(--accent);">
                            Verify
                        </button>
                    </div>
                    <div style="text-align: right; margin-top: 8px;">
                        <span class="link-text" onclick="resetPhoneAuth()">Change Number</span>
                    </div>
                </div>
            </div>

            <div class="divider"><span>OR</span></div>

            <button onclick="loginWithGoogle()" class="google-btn" id="g-login-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" alt="Google">
                <span>Continue with Google Account</span>
            </button>

            <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.05);">
                <p style="font-size: 0.7rem; color: #aaa; line-height: 1.4;">
                    By logging in, you agree to the Terms of Service & Privacy Policy.<br>
                    This site is protected by reCAPTCHA and the Google
                    <a href="https://policies.google.com/privacy" target="_blank" style="color:#aaa;">Privacy Policy</a>
                    and
                    <a href="https://policies.google.com/terms" target="_blank" style="color:#aaa;">Terms of Service</a>
                    apply.
                </p>
            </div>
        </div>
    </div>

    <div class="app-container" style="display: none;">
        <nav class="sidebar">
            <div class="logo" onclick="switchTab('dashboard')">
                <i class="fa-solid fa-hands-holding-circle" style="color: var(--primary);"></i> Silver Seva
            </div>

            <button class="btn-mode" onclick="toggleMode()">
                <i class="fa-solid fa-mobile-screen"></i> Switch to <span id="mode-text">Nurse App</span>
            </button>

            <ul class="nav-menu" id="admin-menu">
                <li class="nav-item active" id="nav-dashboard" onclick="switchTab('dashboard')">
                    <i class="fa-solid fa-house-chimney-medical"></i> Seva Kendra (Home)
                </li>
                <li class="nav-item" id="nav-staff" onclick="switchTab('staff')">
                    <i class="fa-solid fa-user-nurse"></i> Karmachari (Staff)
                </li>
                <li class="nav-item" id="nav-logs" onclick="switchTab('logs')">
                    <i class="fa-solid fa-clipboard-list"></i> Daily Logs
                </li>
                <li class="nav-item" id="nav-payroll" onclick="switchTab('payroll')">
                    <i class="fa-solid fa-money-check-dollar"></i> Payroll
                </li>
                <li class="nav-item" id="nav-bookings" onclick="switchTab('bookings')">
                    <i class="fa-brands fa-whatsapp" style="color: #25D366;"></i> AI Bookings
                </li>

                <li class="nav-item" onclick="logoutApp()" style="margin-top: 1rem; color: #ff4444;">
                    <i class="fa-solid fa-right-from-bracket"></i> Logout
                </li>

                <li class="nav-item" id="nav-super-admin" onclick="switchTab('super-admin')"
                    style="display: none; margin-top: 20px; background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; font-weight: bold;">
                    <i class="fa-solid fa-user-secret"></i> Super Admin
                </li>
            </ul>

            <div
                style="margin-top: auto; padding: 1rem; background: #f0f7ff; border-radius: 12px; border: 1px solid #dbeafe;">
                <p style="font-size: 0.8rem; color: var(--navy); font-weight: 600;">System Status</p>
                <div
                    style="display: flex; align-items: center; gap: 8px; color: var(--accent); font-size: 0.85rem; margin-top: 5px;">
                    <div class="status-dot status-online" style="position: relative;"></div> Firebase Connected
                </div>
            </div>
        </nav>

        <main class="main-content">
            <div class="om-symbol">‡•ê</div>

            <div id="view-dashboard" class="view-section active-view">
                <header>
                    <div class="page-title">
                        <h1><span class="namaste-icon"><i class="fa-solid fa-hands-praying"></i></span> Namaste, <span
                                id="admin-name">Admin</span></h1>
                        <p>Welcome to your Digital Seva Portal</p>
                    </div>
                    <button class="btn-primary" onclick="openModal()">
                        <i class="fa-solid fa-plus"></i> Add Sahayak
                    </button>
                </header>

                <div class="stats-grid">
                    <div class="card stat-card">
                        <div class="icon-circle"><i class="fa-solid fa-users"></i></div>
                        <div class="stat-label">Total Staff</div>
                        <div class="stat-value" id="stat-total">0</div>
                    </div>
                    <div class="card stat-card">
                        <div class="icon-circle" style="color: var(--accent);"><i class="fa-solid fa-check-to-slot"></i>
                        </div>
                        <div class="stat-label">Present Today</div>
                        <div class="stat-value" id="stat-present">0</div>
                    </div>
                    <div class="card stat-card">
                        <div class="icon-circle" style="color: var(--navy);"><i
                                class="fa-solid fa-indian-rupee-sign"></i></div>
                        <div class="stat-label">Payroll Est.</div>
                        <div class="stat-value" id="stat-payroll-total">‚Çπ0</div>
                    </div>
                </div>

                <h2 style="font-family: 'Rozha One'; color: var(--navy); margin-bottom: 1.5rem;">Recent Activity</h2>
                <div class="nurse-grid" id="dashboard-grid">
                </div>
            </div>

            <div id="view-bookings" class="view-section">
                <header>
                    <div class="page-title">
                        <h1>WhatsApp Requests</h1>
                        <p>Real-time orders extracted by AI</p>
                    </div>
                </header>

                <div class="nurse-grid" id="bookings-grid">
                    <div style="color: #999; grid-column: 1/-1; text-align: center; padding: 2rem;">
                        Waiting for new messages...
                    </div>
                </div>
            </div>

            <div id="view-nurse" class="view-section">
                <div class="card" style="max-width: 450px; margin: 0 auto; text-align: center;">
                    <h2 style="font-family:'Rozha One'; color: var(--navy); margin-bottom: 1rem;">Daily Check-In</h2>

                    <div class="form-group" style="text-align: left;">
                        <label>Select Your Name</label>
                        <select id="nurse-login-select" class="form-input">
                        </select>
                    </div>

                    <div class="cam-container">
                        <video id="video-feed" autoplay playsinline></video>
                        <canvas id="canvas-capture" style="display:none;"></canvas>
                    </div>

                    <div id="location-status"
                        style="background: #f0f0f0; padding: 10px; border-radius: 8px; font-size: 0.8rem; margin-bottom: 1rem; color: #555;">
                        <i class="fa-solid fa-location-crosshairs"></i> Waiting for GPS...
                    </div>

                    <button class="btn-primary" style="width: 100%; padding: 1rem;" onclick="performCheckIn()">
                        <i class="fa-solid fa-camera"></i> SNAP & CHECK IN
                    </button>
                    <p style="font-size: 0.7rem; color: #999; margin-top: 10px;">Location recorded for verification</p>
                </div>
            </div>

            <div id="view-staff" class="view-section">
                <header>
                    <div class="page-title">
                        <h1>Staff Directory</h1>
                        <p>Manage all registered employees</p>
                    </div>
                </header>
                <div class="nurse-grid" id="staff-grid"></div>
            </div>

            <div id="view-super-admin" class="view-section">
                <header>
                    <div class="page-title">
                        <h1><span class="namaste-icon">üëë</span> Admin Control</h1>
                        <p>Verify payments & track sales</p>
                    </div>
                    <button class="btn-primary" onclick="window.exportToCSV()">
                        <i class="fa-solid fa-download"></i> Export CSV
                    </button>
                </header>

                <h3
                    style="color: var(--navy); margin-bottom: 1rem; border-bottom: 2px solid #ff9933; display:inline-block;">
                    üîî Pending Payments (Verify UTR)
                </h3>
                <div class="card" style="margin-bottom: 2rem; overflow-x: auto; border: 2px solid #ff9933;">
                    <table class="simple-table">
                        <thead>
                            <tr>
                                <th>Agency Name</th>
                                <th>Amount</th>
                                <th>Referral Code</th>
                                <th>UTR Number</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="admin-pending-table">
                            <tr>
                                <td colspan="5" style="text-align:center;">Waiting for data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3
                    style="color: var(--navy); margin-bottom: 1rem; border-bottom: 2px solid #138808; display:inline-block;">
                    üèÜ Intern Leaderboard
                </h3>
                <div class="stats-grid" id="admin-leaderboard">
                </div>

                <h3 style="color: var(--navy); margin-bottom: 1rem;">üë• All Agencies</h3>
                <div class="card" style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                    <table class="simple-table">
                        <thead>
                            <tr>
                                <th>Agency</th>
                                <th>Email</th>
                                <th>Referral</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="admin-all-users"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-logs" class="view-section">
                <header>
                    <div class="page-title">
                        <h1>Daily Attendance Logs</h1>
                        <p>Real-time check-in data with location</p>
                    </div>
                </header>
                <div id="logs-list-container" style="display: flex; flex-direction: column; gap: 1rem;">
                </div>
            </div>

            <div id="view-payroll" class="view-section">
                <header>
                    <div class="page-title">
                        <h1>Payroll Calculation</h1>
                        <p>Automated salary based on attendance</p>
                    </div>
                    <button class="btn-primary" onclick="alert('Exporting PDF...')">
                        <i class="fa-solid fa-download"></i> Export
                    </button>
                </header>
                <div class="card" style="overflow-x: auto;">
                    <table class="simple-table">
                        <thead>
                            <tr>
                                <th>Nurse Name</th>
                                <th>Daily Rate</th>
                                <th>Days Worked</th>
                                <th>Total Salary</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="payroll-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div class="modal" id="addModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
            <h2 style="margin-bottom: 1.5rem; font-family: 'Rozha One'; color: var(--navy);">New Staff Entry</h2>
            <form id="addNurseForm">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" class="form-input" id="nurseName" required placeholder="Ex. Anjali Gupta">
                </div>

                <div class="form-group">
                    <label>WhatsApp Number (Active)</label>
                    <input type="tel" class="form-input" id="nursePhone" required
                        placeholder="919876543210 (No spaces or +)">
                    <p style="font-size: 0.7rem; color: #888;">Must match their WhatsApp number exactly.</p>
                </div>

                <div class="form-group">
                    <label>Role</label>
                    <input type="text" class="form-input" id="nurseSpec" required placeholder="Ex. Senior Sister">
                </div>
                <div class="form-group">
                    <label>Daily Rate (‚Çπ)</label>
                    <input type="number" class="form-input" id="nurseRate" required placeholder="Ex. 800">
                </div>

                <div class="form-group">
                    <label>Document Locker (Aadhaar/ID)</label>
                    <input type="file" id="nurseDoc" style="display: none;" accept="image/*,.pdf"
                        onchange="handleFileSelect(this)">
                    <div class="doc-box" id="doc-trigger" onclick="document.getElementById('nurseDoc').click()">
                        <i class="fa-solid fa-cloud-arrow-up" id="doc-icon"></i>
                        <span id="doc-text">Upload ID Card</span>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Save Entry</button>
            </form>
        </div>
    </div>

    <div id="modal-onboarding" class="login-overlay" style="display: none; z-index: 9999;">
        <div class="login-card" style="text-align: center;">
            <h2 style="color: var(--navy); margin-bottom: 1rem;">Welcome to Silver Seva!</h2>
            <p style="color: #666; margin-bottom: 2rem;">Please setup your agency profile.</p>

            <input type="text" id="inp-agency-name" class="form-input" placeholder="Enter Agency Name (e.g. Happy Care)"
                style="margin-bottom: 1rem;">
            <input type="text" id="inp-referral-code" class="form-input" placeholder="Referral Code (Optional)"
                style="margin-bottom: 2rem; border: 2px dashed #ff9933;">

            <button onclick="submitOnboarding()" class="btn-primary" style="width: 100%;">
                Continue <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>
    <div id="modal-payment-lock" class="login-overlay" style="display: none; z-index: 9999;">
        <div class="login-card" style="text-align: center; max-width: 450px; position: relative;">

            <div id="payment-form-section">
                <div
                    style="background: #e3f2fd; color: #1565c0; padding: 5px 15px; border-radius: 20px; display: inline-block; font-size: 0.8rem; font-weight: bold; margin-bottom: 1rem;">
                    <i class="fa-solid fa-calculator"></i> FLEXI-PLAN
                </div>

                <h2 style="color: var(--navy); margin-bottom: 0.5rem;">Add More Staff</h2>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">
                    Enter slots needed. Discount applies automatically!
                </p>

                <div
                    style="background: #e3f2fd; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #90caf9;">
                    <p style="margin:0 0 8px 0; font-weight:bold; color:#1565c0; font-size:0.9rem;">
                        üî• Bulk Discounts Available:
                    </p>

                    <div style="display:flex; gap:5px; justify-content:space-between;">
                        <div id="badge-5"
                            style="background:#eee; color:#999; padding:5px 8px; border-radius:6px; font-size:0.75rem; text-align:center; flex:1; border:1px solid #ddd;">
                            <b>5+ Slots</b><br>10% OFF
                        </div>
                        <div id="badge-10"
                            style="background:#eee; color:#999; padding:5px 8px; border-radius:6px; font-size:0.75rem; text-align:center; flex:1; border:1px solid #ddd;">
                            <b>10+ Slots</b><br>15% OFF
                        </div>
                        <div id="badge-20"
                            style="background:#eee; color:#999; padding:5px 8px; border-radius:6px; font-size:0.75rem; text-align:center; flex:1; border:1px solid #ddd;">
                            <b>20+ Slots</b><br>30% OFF
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 1.5rem; text-align: left;">
                    <label style="font-weight: bold; color: var(--navy); font-size: 0.9rem;">Number of Nurses:</label>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <input type="number" id="slot-quantity" class="form-input" value="1" min="1" max="100"
                            oninput="calculateTotal()"
                            style="font-size: 1.2rem; font-weight: bold; text-align: center;">
                    </div>
                    <div style="font-size: 0.8rem; color: #888; margin-top: 5px;">Rate: ‚Çπ200 / nurse</div>
                </div>

                <div
                    style="background: #f9f9f9; padding: 15px; border-radius: 12px; border: 1px dashed #ccc; margin-bottom: 1.5rem; text-align: left;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; color: var(--navy);">Total to Pay:</span>
                        <span id="bill-total" style="font-size: 1.4rem; color: #138808; font-weight: bold;">‚Çπ200</span>
                    </div>
                </div>

                <div style="text-align: center; margin-bottom: 1rem;">
                    <img id="payment-qr-img" src=""
                        style="width: 120px; height: 120px; border-radius: 8px; border: 2px solid #eee;">
                    <div style="font-size: 0.7rem; color: #666; margin-top: 5px;">Scan via UPI</div>
                </div>

                <input type="text" id="inp-utr" class="form-input" placeholder="Enter 12-digit UTR"
                    style="margin-bottom: 1rem;">

                <button id="btn-verify-payment" onclick="submitPaymentUTR()" class="btn-primary"
                    style="width: 100%; margin-bottom: 10px;">
                    Verify Payment
                </button>

                <button id="btn-pay-later" onclick="activatePayLater()"
                    style="background: none; border: none; color: #666; text-decoration: underline; cursor: pointer; font-size: 0.9rem;">
                    Cancel (Go Back)
                </button>
            </div>

            <div id="payment-pending-section" style="display: none; padding: 1rem;">
                <i class="fa-solid fa-clock-rotate-left"
                    style="font-size: 3.5rem; color: #ff9933; margin-bottom: 1.5rem;"></i>

                <h2 style="color: var(--navy); margin-bottom: 1rem;">Verification in Progress</h2>

                <p style="color: #555; font-size: 1rem; line-height: 1.6; margin-bottom: 1.5rem;">
                    Thank you! We have received your UTR. <br>
                    Admin is verifying the transaction.
                </p>

                <div
                    style="background: #fff8e1; border: 1px solid #ffe0b2; padding: 15px; border-radius: 8px; color: #e65100; font-size: 0.9rem; margin-bottom: 2rem;">
                    <strong>Estimated Wait:</strong><br>
                    Usually 1-2 hours (Max 24 Hours)
                </div>

                <button onclick="activatePayLater()" class="btn-primary"
                    style="width: 100%; background-color: #78909c;">
                    Okay, I'll wait
                </button>
            </div>

        </div>
    </div>

    <div class="modal" id="profileModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <button class="close-modal" onclick="document.getElementById('profileModal').classList.remove('active')"><i class="fa-solid fa-xmark"></i></button>
            
            <div style="text-align:center; margin-bottom:1.5rem;">
                <h2 id="p-name" style="color:var(--navy);">Nurse Name</h2>
                <p id="p-role" style="color:#666; font-size:0.9rem;">Role</p>
            </div>
    
            <div class="profile-tabs">
                <button class="tab-btn active" onclick="switchProfileTab('attendance')">Attendance</button>
                <button class="tab-btn" onclick="switchProfileTab('docs')">Documents</button>
                <button class="tab-btn" onclick="switchProfileTab('edit')">Edit Info</button>
            </div>
    
            <div id="tab-attendance" class="tab-content active">
    
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee;">
                    <button onclick="changeMonth(-1)" style="border: none; background: none; cursor: pointer; font-size: 1.2rem; color: var(--navy); padding: 0 10px;">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    
                    <h4 id="cal-month-year" style="margin: 0; color: var(--navy);">Month Year</h4>
                    
                    <button onclick="changeMonth(1)" style="border: none; background: none; cursor: pointer; font-size: 1.2rem; color: var(--navy); padding: 0 10px;">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
            
                <div class="calendar-grid" id="cal-days-container"></div>
            
                <div style="display:flex; gap:15px; justify-content:center; margin-top:15px; font-size:0.8rem;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <div style="width:10px; height:10px; background:#e8f5e9; border:1px solid #c8e6c9; border-radius:50%;"></div> Present
                    </div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <div style="width:10px; height:10px; background:#ffebee; border:1px solid #ffcdd2; border-radius:50%;"></div> Absent
                    </div>
                </div>
            </div>
    
            <div id="tab-docs" class="tab-content">
                <div style="border:2px dashed #ddd; padding:1.5rem; text-align:center; border-radius:12px; cursor:pointer; margin-bottom:15px;" onclick="document.getElementById('doc-upload').click()">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size:1.5rem; color:var(--primary);"></i>
                    <p style="font-size:0.8rem; color:#666;">Upload ID/Certificate</p>
                    <input type="file" id="doc-upload" hidden accept="image/*,.pdf">
                </div>
                <div id="doc-list"></div>
            </div>
    
            <div id="tab-edit" class="tab-content">
                <form id="editNurseForm">
                    <input type="hidden" id="edit-id">
                    <div class="form-group"><label>Full Name</label><input type="text" id="edit-name" class="form-input"></div>
                    <div class="form-group"><label>Phone</label><input type="text" id="edit-phone" class="form-input"></div>
                    <div class="form-group"><label>Rate (‚Çπ)</label><input type="number" id="edit-rate" class="form-input"></div>
                    <div class="form-group"><label>Role</label><input type="text" id="edit-role" class="form-input"></div>
                    <button type="submit" class="btn-primary" style="width:100%; margin-top:10px;">Update Profile</button>
                </form>
            </div>
        </div>
    </div>
    <script type="module">
        // 1. IMPORTS (VERIFIED & CLEAN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

        // üëá This checks all your imports are correct and includes 'where', 'getDocs', 'increment'
        import {
            getFirestore, collection, addDoc, onSnapshot, query, orderBy,
            deleteDoc, doc, updateDoc, getDoc, serverTimestamp, setDoc, increment,
            where, getDocs
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        import {
            getAuth, GoogleAuthProvider, signInWithPopup, signOut,
            onAuthStateChanged, RecaptchaVerifier, signInWithPhoneNumber
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyADbFSo1XZA78Sj-ooJ7Av8tDxbctS-Qws",
            authDomain: "silvercareprototype.firebaseapp.com",
            projectId: "silvercareprototype",
            storageBucket: "silvercareprototype.firebasestorage.app",
            messagingSenderId: "695863800030",
            appId: "1:695863800030:web:751cb3b0d536464957924f"
        };

        const app = initializeApp(firebaseConfig);
        // ... (Your code continues below as normal)
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- STATE VARIABLES ---
        let currentUser = null;
        let currentUserData = null; // Stores user profile (payment status, etc.)
        let allNurses = [];
        let allLogs = [];
        let currentStream = null;
        let currentNurseId = null;
        let currentCalDate = new Date(); // Tracks the calendar month


        // Unsubscribe functions
        let unsubscribeUserDoc = null;
        let unsubscribeNurses = null;
        let unsubscribeLogs = null;
        let unsubscribeBookings = null;

        // ==========================================
        // üîê AUTH & GATEKEEPER LOGIC
        // ==========================================

        onAuthStateChanged(auth, (user) => {
            const landingPage = document.getElementById('public-landing');
            const dashboard = document.querySelector('.app-container');
            const loginOverlay = document.getElementById('login-overlay');
            const nameSpan = document.getElementById('admin-name');

            if (user) {
                // LOGGED IN
                console.log("User Logged In:", user.uid);
                currentUser = user;

                // UI Updates
                landingPage.style.display = 'none';
                loginOverlay.style.display = 'none';
                dashboard.style.display = 'grid';
                nameSpan.innerText = user.displayName ? user.displayName.split(' ')[0] : 'Admin';

                // 1. Check if Super Admin
                checkAdminAccess(user);

                // 2. Start Gatekeeper (Checks Payment -> Then Loads Data)
                setupGatekeeper(user.uid);

            } else {
                // LOGGED OUT
                console.log("User Logged Out");
                currentUser = null;
                currentUserData = null;

                // UI Updates
                landingPage.style.display = 'flex';
                dashboard.style.display = 'none';
                loginOverlay.style.display = 'none';

                // Hide Modals
                document.getElementById('modal-onboarding').style.display = 'none';
                document.getElementById('modal-payment-lock').style.display = 'none';

                // Detach Listeners
                if (unsubscribeUserDoc) unsubscribeUserDoc();
                if (unsubscribeNurses) unsubscribeNurses();
                if (unsubscribeLogs) unsubscribeLogs();
                if (unsubscribeBookings) unsubscribeBookings();

                // Clear Data
                allNurses = [];
                allLogs = [];
                renderStaffList();
                renderDashboardLogs();
            }
        });

        // --- THE GATEKEEPER (Fixed Order & Pay Later) ---
        // --- THE GATEKEEPER (Fixed Order & Pay Later) ---
        let isPayLaterMode = false;

        function setupGatekeeper(uid) {
            unsubscribeUserDoc = onSnapshot(doc(db, "users", uid), (docSnap) => {

                // 1. SUPER ADMIN BYPASS
                if (currentUser.email === "supercare655@gmail.com") {
                    document.getElementById('modal-onboarding').style.display = 'none';
                    document.getElementById('modal-payment-lock').style.display = 'none';
                    startDataSync(uid);
                    return;
                }

                // 2. HANDLE NEW USERS
                if (!docSnap.exists()) {
                    document.getElementById('modal-onboarding').style.display = 'flex';
                    return;
                }

                currentUserData = docSnap.data();

                // 3. CHECK ONBOARDING
                if (!currentUserData.agencyName) {
                    document.getElementById('modal-onboarding').style.display = 'flex';
                    return;
                } else {
                    document.getElementById('modal-onboarding').style.display = 'none';
                }

                // 4. CHECK PAYMENT STATUS
                const payModal = document.getElementById('modal-payment-lock');
                const verifyBtn = document.getElementById('btn-verify-payment');
                const payLaterBtn = document.getElementById('btn-pay-later');
                const statusText = document.getElementById('payment-status-text');

                // A. User is Paid
                if (currentUserData.isPaid) {
                    payModal.style.display = 'none';
                    startDataSync(uid);
                    return;
                }

                // B. Payment Pending (Locked)
                if (currentUserData.paymentRequest && currentUserData.paymentRequest.status === 'pending') {
                    payModal.style.display = 'flex';
                    verifyBtn.innerText = "Verification Pending...";
                    verifyBtn.disabled = true;
                    statusText.style.display = 'block';
                    statusText.innerText = "Admin is verifying. Please wait...";
                    if (payLaterBtn) payLaterBtn.style.display = 'none';
                    return;
                }

                // C. Not Paid (Show Gatekeeper)
                if (!isPayLaterMode) {
                    payModal.style.display = 'flex';
                    verifyBtn.innerText = "Verify Payment";
                    verifyBtn.disabled = false;
                    statusText.style.display = 'none';

                    // Show "Skip" Button for Login
                    if (payLaterBtn) {
                        payLaterBtn.style.display = 'block';
                        payLaterBtn.innerText = "Skip for now (View Dashboard)";
                    }

                    if (window.initPricingModal) window.initPricingModal();
                } else {
                    // User clicked Skip -> Dashboard visible
                    payModal.style.display = 'none';
                    startDataSync(uid);
                }
            });
        }

        // --- DATA SYNC (Loads Nurses/Logs ONLY after Gatekeeper passes) ---
        function startDataSync(uid) {
            // Prevent duplicate listeners
            if (unsubscribeNurses) return;

            console.log("Starting Data Sync...");

            // 1. Nurses
            unsubscribeNurses = onSnapshot(collection(db, "users", uid, "nurses"), (snapshot) => {
                allNurses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStaffList();
                populateLoginSelect();
                calculatePayroll();
                document.getElementById('stat-total').innerText = allNurses.length;
            });

            // 2. Attendance
            const attendanceRef = collection(db, "users", uid, "attendance");
            unsubscribeLogs = onSnapshot(query(attendanceRef, orderBy("timestamp", "desc")), (snapshot) => {
                allLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboardLogs();
                renderAllLogs();
                calculatePayroll();

                // Today's Stats
                const today = new Date().toDateString();
                const todayCount = allLogs.filter(l => new Date(l.timestamp).toDateString() === today).length;
                document.getElementById('stat-present').innerText = todayCount;
            });

            // 3. Bookings
            const bookingsRef = collection(db, "users", uid, "bookings");
            unsubscribeBookings = onSnapshot(query(bookingsRef, orderBy("timestamp", "desc")), (snapshot) => {
                const grid = document.getElementById('bookings-grid');
                grid.innerHTML = '';
                if (snapshot.empty) { grid.innerHTML = '<p style="color:#888;">No new bookings.</p>'; return; }

                snapshot.docs.forEach(doc => {
                    const b = doc.data();
                    grid.innerHTML += `
                    <div class="card" style="border-left: 5px solid #25D366;">
                        <h3><i class="fa-brands fa-whatsapp"></i> ${b.clientPhone}</h3>
                        <p style="font-size:0.9rem;"><b>Loc:</b> ${b.location}</p>
                        <p style="font-size:0.8rem; background:#f9f9f9; padding:5px;">"${b.patient_details || 'No details'}"</p>
                        <hr style="margin:10px 0; border:0; border-top:1px dashed #ddd;">
                        <span style="font-size:0.8rem; color:#888;">${new Date(b.timestamp).toLocaleTimeString()}</span>
                    </div>`;
                });
            });
        }

        // ==========================================
        // üí∞ DYNAMIC PRICING ENGINE (Flexi-Plan)
        // ==========================================

        const BASE_RATE = 200;
        const UPI_ID = "8299341343@ptsbi";
        const UPI_NAME = "SilverSeva";
        const FREE_LIMIT = 0;

        // State to hold current calculation
        let currentOrder = {
            slots: 1,
            totalPrice: 200
        };

        // 1. CALCULATE PRICE LIVE (Updates Text & QR)
        window.calculateTotal = () => {
            const input = document.getElementById('slot-quantity');
            if (!input) return; // Safety check if modal HTML isn't loaded

            let qty = parseInt(input.value);

            // Safety: Minimum 1
            if (!qty || qty < 1) { qty = 1; }

            // A. Calculate Discount
            let discountPercent = 0;
            if (qty >= 20) discountPercent = 0.30;       // 30% Off
            else if (qty >= 10) discountPercent = 0.15;  // 15% Off
            else if (qty >= 5) discountPercent = 0.10;  // 10% Off

            // B. Calculate Math
            const subtotal = qty * BASE_RATE;
            const discountAmount = Math.round(subtotal * discountPercent);
            const finalPrice = subtotal - discountAmount;

            // C. Update State
            currentOrder = { slots: qty, totalPrice: finalPrice };

            // D. Update UI Text
            const subEl = document.getElementById('bill-subtotal');
            const discEl = document.getElementById('bill-discount');
            const totEl = document.getElementById('bill-total');

            if (subEl) subEl.innerText = `‚Çπ${subtotal}`;
            if (discEl) discEl.innerText = `-‚Çπ${discountAmount} (${discountPercent * 100}%)`;
            if (totEl) totEl.innerText = `‚Çπ${finalPrice}`;

            // E. Highlight Badges
            resetBadges();
            if (qty >= 20) highlightBadge('badge-20');
            else if (qty >= 10) highlightBadge('badge-10');
            else if (qty >= 5) highlightBadge('badge-5');

            // F. Generate QR Code
            const newUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=upi://pay?pa=${UPI_ID}&pn=${UPI_NAME}&am=${finalPrice}`;
            const qrImg = document.getElementById('payment-qr-img');
            if (qrImg) qrImg.src = newUrl;
        };

        // Helper Styles
        function highlightBadge(id) {
            const el = document.getElementById(id);
            if (el) { el.style.background = '#4caf50'; el.style.color = 'white'; el.style.fontWeight = 'bold'; }
        }
        function resetBadges() {
            ['badge-5', 'badge-10', 'badge-20'].forEach(id => {
                const el = document.getElementById(id);
                if (el) { el.style.background = '#eee'; el.style.color = '#999'; el.style.fontWeight = 'normal'; }
            });
        }

        // Initialize Modal
        window.initPricingModal = () => {
            const input = document.getElementById('slot-quantity');
            if (input) input.value = 1;
            calculateTotal(); // Run calculation for 1
        }

        // --- FUNCTION: Add Nurse Trigger (Smart Check) ---
        window.openModal = () => {
            const extraSlots = currentUserData?.extraSlots || 0;
            const currentCount = allNurses.length;
            const totalLimit = FREE_LIMIT + extraSlots;

            // CHECK IF ALREADY PENDING
            const isPending = currentUserData?.paymentRequest?.status === 'pending';

            // CASE 1: Payment is Pending (User is waiting)
            if (isPending) {
                const payModal = document.getElementById('modal-payment-lock');
                const formSection = document.getElementById('payment-form-section');
                const pendingSection = document.getElementById('payment-pending-section');

                payModal.style.display = 'flex';
                if (formSection) formSection.style.display = 'none';    // Hide Form
                if (pendingSection) pendingSection.style.display = 'block'; // Show Message
                return;
            }

            // CASE 2: User has space -> Open Add Form
            if (currentCount < totalLimit) {
                document.getElementById('addModal').classList.add('active');
            }
            // CASE 3: No space -> Show Payment Form
            else {
                const payModal = document.getElementById('modal-payment-lock');
                const formSection = document.getElementById('payment-form-section');
                const pendingSection = document.getElementById('payment-pending-section');

                payModal.style.display = 'flex';
                if (formSection) formSection.style.display = 'block';   // Show Form
                if (pendingSection) pendingSection.style.display = 'none'; // Hide Message

                // Show Cancel button (Renamed from Pay Later)
                const payLaterBtn = document.getElementById('btn-pay-later');
                if (payLaterBtn) {
                    payLaterBtn.style.display = 'block';
                    payLaterBtn.innerText = "Cancel (Go Back)";
                }

                if (window.initPricingModal) window.initPricingModal();
            }
        };

        window.closeModal = () => document.getElementById('addModal').classList.remove('active');

        // --- FUNCTION: Submit Payment (Switches to Pending View) ---
        window.submitPaymentUTR = async () => {
            const utr = document.getElementById('inp-utr').value;
            if (!utr || utr.length < 4) return alert("Please enter valid UTR");

            const btn = document.getElementById('btn-verify-payment');
            btn.innerText = "Sending...";
            btn.disabled = true;

            // 1. Save to Database
            await setDoc(doc(db, "users", currentUser.uid), {
                paymentRequest: {
                    utr: utr,
                    amount: currentOrder.totalPrice, // Uses calculated price
                    slots: currentOrder.slots,       // Uses calculated slots
                    packId: 'custom',
                    status: 'pending',
                    timestamp: serverTimestamp()
                }
            }, { merge: true });

            // 2. Switch UI to "Pending" Mode immediately
            const formSection = document.getElementById('payment-form-section');
            const pendingSection = document.getElementById('payment-pending-section');

            if (formSection) formSection.style.display = 'none';
            if (pendingSection) pendingSection.style.display = 'block';
        };

        // --- FUNCTION: Onboarding Submit ---
        window.submitOnboarding = async () => {
            const agencyName = document.getElementById('inp-agency-name').value;
            const referralCode = document.getElementById('inp-referral-code').value;
            if (!agencyName) return alert("Enter Agency Name");

            // USE SETDOC HERE TO CREATE FILE
            await setDoc(doc(db, "users", currentUser.uid), {
                agencyName: agencyName,
                referralBy: referralCode ? referralCode.toUpperCase() : "DIRECT",
                email: currentUser.email,
                createdAt: serverTimestamp()
            }, { merge: true });
        };

        // --- FUNCTION: Activate Pay Later (Cancel/Skip) ---
        window.activatePayLater = () => {
            isPayLaterMode = true; // Set flag
            document.getElementById('modal-payment-lock').style.display = 'none';

            // Only try to load data if user exists
            if (currentUser) startDataSync(currentUser.uid);
        };

        // ==========================================
        // üëë SUPER ADMIN LOGIC
        // ==========================================
        const SUPER_ADMIN_EMAIL = "supercare655@gmail.com";

        window.checkAdminAccess = (user) => {
            if (user.email === SUPER_ADMIN_EMAIL) {
                console.log("üëë SUPER ADMIN");
                document.getElementById('nav-super-admin').style.display = 'flex';

                // Hide Payment/Onboarding Modals for Admin
                document.getElementById('modal-payment-lock').style.display = 'none';
                document.getElementById('modal-onboarding').style.display = 'none';

                // Hide normal nav items
                document.querySelectorAll('.nav-item:not(#nav-super-admin):not([onclick="logoutApp()"])')
                    .forEach(el => el.style.display = 'none');

                // Switch to Admin View
                switchTab('super-admin');
                loadAdminData();
            }
        }


        // --- UPDATED ADMIN LOADER (FIXED) ---
        function loadAdminData() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                const pendingTable = document.getElementById('admin-pending-table');
                const allTable = document.getElementById('admin-all-users');
                const leaderboardDiv = document.getElementById('admin-leaderboard');

                pendingTable.innerHTML = '';
                allTable.innerHTML = '';
                leaderboardDiv.innerHTML = '';

                let referralCounts = {};
                let hasPending = false;

                snapshot.docs.forEach(doc => {
                    const u = doc.data();
                    const uid = doc.id;

                    // --- 1. PREPARE DISPLAY DATA ---
                    let planDisplay = '<span style="color:#666; font-size:0.8rem;">Free Tier</span>';
                    if (u.plan === 'unlimited') {
                        planDisplay = '<span style="color:#e65100; font-weight:bold; font-size:0.8rem;">üíé Unlimited</span>';
                    } else if (u.extraSlots > 0) {
                        planDisplay = `<span style="color:#1565c0; font-weight:bold; font-size:0.8rem;">üé´ ${u.extraSlots} Slots</span>`;
                    }

                    const count = u.nurseCount || 0;
                    const countDisplay = `<span style="background:#f0f0f0; padding:2px 6px; border-radius:10px; font-size:0.75rem; color:#333;">üë• ${count} Staff</span>`;

                    // --- 2. LEADERBOARD LOGIC ---
                    if (u.referralBy && u.referralBy !== "DIRECT") {
                        if (!referralCounts[u.referralBy]) referralCounts[u.referralBy] = { total: 0, paid: 0 };
                        referralCounts[u.referralBy].total += 1;
                        if (u.isPaid) referralCounts[u.referralBy].paid += 1;
                    }

                    // --- 3. PENDING TABLE ---
                    if (u.paymentRequest && u.paymentRequest.status === 'pending' && !u.isPaid) {
                        hasPending = true;
                        pendingTable.innerHTML += `
                <tr style="background: #fff8e1;">
                    <td>
                        <b>${u.agencyName}</b><br>
                        ${planDisplay}
                    </td>
                    
                    <td>‚Çπ${u.paymentRequest.amount || 199}</td>
                    
                    <td>${u.referralBy || '-'}</td>
                    <td style="font-family:monospace; color:#003366;">${u.paymentRequest.utr}</td>
                    <td><button onclick="approveUserPayment('${uid}')" class="btn-primary" style="padding:5px 10px; font-size:0.8rem;">Approve ‚úÖ</button></td>
                </tr>`;
                    }

                    // --- 4. ALL USERS TABLE ---
                    allTable.innerHTML += `
            <tr>
                <td>
                    <div style="font-weight:bold; color:var(--navy);">${u.agencyName || 'Incomplete'}</div>
                    <div style="margin-top:4px;">${planDisplay} &bull; ${countDisplay}</div>
                </td>
                <td>${u.email}</td>
                <td>${u.referralBy || 'DIRECT'}</td>
                <td>${u.isPaid ? '<span style="color:green; font-weight:bold;">PAID</span>' : '<span style="color:red;">LOCKED</span>'}</td>
            </tr>`;
                });

                if (!hasPending) pendingTable.innerHTML = '<tr><td colspan="5" style="text-align:center;">No pending payments.</td></tr>';

                // Render Leaderboard
                Object.keys(referralCounts).forEach(code => {
                    const data = referralCounts[code];
                    leaderboardDiv.innerHTML += `
            <div class="card stat-card" style="border-top: 4px solid ${data.paid > 0 ? '#138808' : '#999'};">
                <div style="font-size: 1.2rem; font-weight: bold;">${code}</div>
                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                    <div style="text-align:center;"><div style="font-size:1.5rem; font-weight:700; color:#138808;">${data.paid}</div><div style="font-size:0.7rem;">SALES</div></div>
                    <div style="text-align:center;"><div style="font-size:1.5rem; font-weight:700;">${data.total}</div><div style="font-size:0.7rem;">LEADS</div></div>
                </div>
            </div>`;
                });
            });
        }

        window.approveUserPayment = async (targetUid) => {
            if (!confirm("Confirm payment received?")) return;

            try {
                console.log("Starting Approval for UID:", targetUid);

                // 1. Get the User who just paid (Client)
                const userRef = doc(db, "users", targetUid);
                const userSnap = await getDoc(userRef);

                if (!userSnap.exists()) return alert("User not found");
                const userData = userSnap.data();

                // 2. FIND THE INTERN (RAHUL72)
                // The client was referred by 'referralBy' (which is "RAHUL72")
                const referrerName = userData.referralBy;

                if (referrerName && referrerName !== "DIRECT") {
                    console.log("Searching for Intern:", referrerName);

                    // FIX: Search 'agencyName' because that is where "RAHUL72" is stored
                    const q = query(collection(db, "users"), where("agencyName", "==", referrerName));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        // Intern Found! Update them.
                        querySnapshot.forEach(async (internDoc) => {
                            const internRef = doc(db, "users", internDoc.id);
                            await updateDoc(internRef, {
                                sales: increment(1) // <--- THIS INCREMENTS THE 0 to 1
                            });
                            console.log("SUCCESS: Intern sales updated.");
                        });
                    } else {
                        console.warn("FAILED: Could not find any user named " + referrerName);
                    }
                }

                // 3. UPDATE THE CLIENT (Unlock them)
                const slotsToAdd = userData.paymentRequest?.slots || 1;
                await updateDoc(userRef, {
                    "paymentRequest.status": "approved",
                    "paymentRequest.approvedAt": serverTimestamp(),
                    "extraSlots": increment(slotsToAdd),
                    "isPaid": true
                });

                alert(`Approved! Added slots and updated Intern sales.`);
                // Reload to see the change in the table
                window.location.reload();

            } catch (e) {
                console.error("Approval Error:", e);
                alert("Error: " + e.message);
            }
        };

        window.exportToCSV = () => {
            // ... (Keep existing CSV logic) ...
            alert("Exporting CSV..."); // Placeholder for brevity
        }
        // ==========================================
// üë§ PROFILE MODAL LOGIC (NEW)
// ==========================================

// ==========================================
// üë§ PROFILE, TABS & CALENDAR LOGIC
// ==========================================

// 1. OPEN PROFILE
window.openProfile = async (id) => {
    currentNurseId = id;
    const nurse = allNurses.find(n => n.id === id);
    if (!nurse) return;

    // Fill Info
    document.getElementById('p-name').innerText = nurse.name;
    document.getElementById('p-role').innerText = nurse.role;
    
    // Fill Edit Form
    document.getElementById('edit-id').value = nurse.id;
    document.getElementById('edit-name').value = nurse.name;
    document.getElementById('edit-phone').value = nurse.phone;
    document.getElementById('edit-rate').value = nurse.rate;
    document.getElementById('edit-role').value = nurse.role;

    // RESET Calendar to Today & Render
    currentCalDate = new Date(); 
    renderCalendar(); 

    // Load Docs
    loadDocuments(id);
    
    // Show Modal & Switch to first tab
    document.getElementById('profileModal').classList.add('active');
    window.switchProfileTab('attendance');
};

// 2. SWITCH TABS (Keep this!)
window.switchProfileTab = (tab) => {
    // Reset buttons and content
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    // Activate clicked tab
    // Note: We search for the button that has the onclick handler for this specific tab
    const btn = Array.from(document.querySelectorAll('.tab-btn'))
                     .find(b => b.getAttribute('onclick').includes(tab));
    
    if(btn) btn.classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');
};

// 3. CHANGE MONTH (Next/Prev)
window.changeMonth = (offset) => {
    currentCalDate.setMonth(currentCalDate.getMonth() + offset);
    renderCalendar();
};

// 4. RENDER CALENDAR
function renderCalendar() {
    const container = document.getElementById('cal-days-container');
    const header = document.getElementById('cal-month-year');
    
    // Update Header Text
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    header.innerText = `${monthNames[currentCalDate.getMonth()]} ${currentCalDate.getFullYear()}`;

    // Reset Grid Header
    container.innerHTML = `<div class="cal-day-header">S</div><div class="cal-day-header">M</div><div class="cal-day-header">T</div><div class="cal-day-header">W</div><div class="cal-day-header">T</div><div class="cal-day-header">F</div><div class="cal-day-header">S</div>`;

    const year = currentCalDate.getFullYear();
    const month = currentCalDate.getMonth();
    
    const firstDayIndex = new Date(year, month, 1).getDay(); 
    const daysInMonth = new Date(year, month + 1, 0).getDate(); 
    
    // Get Presence for THIS specific month/year
    const nurseLogs = allLogs.filter(l => l.nurseId === currentNurseId);
    const presentDays = nurseLogs
        .filter(l => {
            const d = new Date(l.timestamp);
            return d.getMonth() === month && d.getFullYear() === year;
        })
        .map(l => new Date(l.timestamp).getDate());

    const today = new Date();
    const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;

    // Render Empty Slots
    for (let x = 0; x < firstDayIndex; x++) {
        container.appendChild(document.createElement('div'));
    }

    // Render Days
    for (let i = 1; i <= daysInMonth; i++) {
        const dayEl = document.createElement('div');
        dayEl.classList.add('cal-day');
        dayEl.innerText = i;

        if (isCurrentMonth && i === today.getDate()) dayEl.classList.add('today');

        if (presentDays.includes(i)) {
            dayEl.classList.add('present');
        } else {
            let checkDate = new Date(year, month, i);
            // Only mark absent if it's in the past
            if (checkDate < new Date().setHours(0,0,0,0)) {
                dayEl.classList.add('absent');
            }
        }
        container.appendChild(dayEl);
    }
}

// --- DOCUMENT LOCKER LOGIC ---
async function loadDocuments(nurseId) {
    const list = document.getElementById('doc-list');
    list.innerHTML = '<p style="color:#999; text-align:center;">Loading...</p>';
    
    // Fetch Docs from Subcollection
    const q = query(collection(db, "users", currentUser.uid, "nurses", nurseId, "documents"), orderBy("uploadedAt", "desc"));
    const snapshot = await getDocs(q);
    
    list.innerHTML = '';
    if (snapshot.empty) { 
        list.innerHTML = '<p style="color:#999; text-align:center; font-size:0.8rem; margin-top:10px;">No documents yet.</p>'; 
        return; 
    }

    snapshot.forEach(docSnap => {
        const d = docSnap.data();
        list.innerHTML += `
        <div class="doc-item">
            <div class="doc-icon"><i class="fa-solid fa-file-contract"></i></div>
            <div style="flex:1; overflow:hidden;">
                <div style="font-weight:600; font-size:0.9rem;">${d.name}</div>
                <div style="font-size:0.7rem; color:#888;">${new Date(d.uploadedAt).toLocaleDateString()}</div>
            </div>
            <a href="${d.data}" download="${d.name}" style="color:var(--primary); margin-right:15px;"><i class="fa-solid fa-download"></i></a>
            <button onclick="window.deleteDoc('${docSnap.id}')" style="color:#ff4444; background:none; border:none; cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
        </div>`;
    });
}

// Upload Listener
const uploadInput = document.getElementById('doc-upload');
if (uploadInput) {
    uploadInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || !currentNurseId) return;

        const reader = new FileReader();
        reader.onload = async (event) => {
            const base64 = event.target.result;
            await addDoc(collection(db, "users", currentUser.uid, "nurses", currentNurseId, "documents"), {
                name: file.name,
                data: base64,
                uploadedAt: Date.now()
            });
            loadDocuments(currentNurseId); // Refresh UI
        };
        reader.readAsDataURL(file);
    });
}

window.deleteDoc = async (docId) => {
    if (confirm('Delete this document permanently?')) {
        await deleteDoc(doc(db, "users", currentUser.uid, "nurses", currentNurseId, "documents", docId));
        loadDocuments(currentNurseId);
    }
};

// --- EDIT PROFILE SUBMIT ---
const editForm = document.getElementById('editNurseForm');
if (editForm) {
    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        
        await updateDoc(doc(db, "users", currentUser.uid, "nurses", id), {
            name: document.getElementById('edit-name').value,
            phone: document.getElementById('edit-phone').value,
            rate: document.getElementById('edit-rate').value,
            role: document.getElementById('edit-role').value
        });
        
        alert('Profile Updated Successfully!');
        // Update Modal Title instantly
        document.getElementById('p-name').innerText = document.getElementById('edit-name').value;
        document.getElementById('p-role').innerText = document.getElementById('edit-role').value;
    });
}

        // ==========================================
        // üõ†Ô∏è HELPER FUNCTIONS (Render, Camera, Etc)
        // ==========================================

        window.loginWithGoogle = () => {
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            signInWithPopup(auth, provider).catch(err => alert("Login Failed: " + err.message));
        };

        window.logoutApp = () => {
            signOut(auth).then(() => window.location.reload());
        };

        function renderStaffList() {
            const grid = document.getElementById('staff-grid');
            grid.innerHTML = '';
            
            allNurses.forEach(nurse => {
                const names = nurse.name.split(' ');
                const initials = names.length > 1 ? names[0][0] + names[1][0] : names[0][0];
                
                // Using flex-direction: column ensures the button stays at the bottom naturally
                grid.innerHTML += `
                <div class="card nurse-card" style="display: flex; flex-direction: column; height: 100%; min-height: 280px;">
                    <div style="flex: 1;">
                        <button class="btn-icon delete-btn" onclick="window.removeNurse('${nurse.id}')">
                            <i class="fa-solid fa-trash"></i>
                        </button>
        
                        <div class="nurse-header">
                            <div class="nurse-avatar">${initials}</div>
                            <div class="nurse-info">
                                <h3>${nurse.name}</h3>
                                <p>${nurse.role}</p>
                            </div>
                        </div>
        
                        <div class="metrics-row">
                            <div class="metric">
                                <span class="metric-val">‚Çπ${nurse.rate}</span>
                                <span class="metric-lbl">Daily Rate</span>
                            </div>
                            <div class="metric">
                                <span class="metric-val" style="color:var(--accent)">Active</span>
                                <span class="metric-lbl">Status</span>
                            </div>
                        </div>
                    </div>
        
                    <button class="btn-profile" onclick="window.openProfile('${nurse.id}')" 
                        style="margin-top: 20px; width: 100%; background: #e3f2fd; color: #1565c0; 
                               border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="fa-solid fa-address-card"></i> View Profile
                    </button>
                </div>`;
            });
        }

        function populateLoginSelect() {
            const sel = document.getElementById('nurse-login-select');
            sel.innerHTML = '<option value="">-- Select Name --</option>';
            allNurses.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n.id;
                opt.innerText = n.name;
                sel.appendChild(opt);
            });
        }

        function renderDashboardLogs() {
            const grid = document.getElementById('dashboard-grid');
            grid.innerHTML = '';
            allLogs.slice(0, 3).forEach(log => {
                grid.innerHTML += createLogCard(log);
            });
        }

        function renderAllLogs() {
            const container = document.getElementById('logs-list-container');
            container.innerHTML = '';
            allLogs.forEach(log => {
                container.innerHTML += createLogCard(log);
            });
        }

        function createLogCard(log) {
            return `
            <div class="card" style="display:flex; gap:15px; align-items:center; padding:1rem;">
                <img src="${log.photo}" style="width:60px; height:60px; border-radius:50%; object-fit:cover; border:2px solid #eee;">
                <div>
                    <h4 style="color:var(--navy); margin-bottom:2px;">${log.nurseName}</h4>
                    <p style="font-size:0.8rem; color:#666;">${new Date(log.timestamp).toLocaleString()}</p>
                    <p style="font-size:0.8rem; color:var(--primary);"><i class="fa-solid fa-map-pin"></i> ${log.address || "GPS Only"}</p>
                </div>
            </div>`;
        }

        function calculatePayroll() {
            const tbody = document.getElementById('payroll-table-body');
            tbody.innerHTML = '';
            let totalPayroll = 0;
            allNurses.forEach(nurse => {
                const daysWorked = allLogs.filter(l => l.nurseId === nurse.id).length;
                const salary = daysWorked * (parseInt(nurse.rate) || 0);
                totalPayroll += salary;
                tbody.innerHTML += `<tr><td><b>${nurse.name}</b></td><td>‚Çπ${nurse.rate}</td><td>${daysWorked}</td><td style="color:var(--primary);">‚Çπ${salary}</td><td>Paid</td></tr>`;
            });
            document.getElementById('stat-payroll-total').innerText = '‚Çπ' + totalPayroll;
        }

        // --- CAMERA & LOCATION ---
        window.startCamera = async () => {
            try {
                const video = document.getElementById('video-feed');
                currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                video.srcObject = currentStream;
                getLocation();
            } catch (e) { alert("Camera Access Denied"); }
        };

        window.stopCamera = () => { if (currentStream) currentStream.getTracks().forEach(track => track.stop()); };

        window.getLocation = () => {
            const status = document.getElementById('location-status');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    status.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Finding Address...`;
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                        const data = await res.json();
                        window.currentLocation = { lat, lng, address: data.display_name.split(',').slice(0, 3).join(',') };
                        status.innerHTML = `<i class="fa-solid fa-check"></i> ${window.currentLocation.address}`;
                    } catch (e) { status.innerHTML = "GPS Recorded"; window.currentLocation = { lat, lng, address: "GPS Only" }; }
                });
            }
        };

        window.performCheckIn = async () => {
            if (!currentUser) return alert("Error: No User");
            const nurseId = document.getElementById('nurse-login-select').value;
            if (!nurseId) return alert("Select Name");

            const video = document.getElementById('video-feed');
            const canvas = document.getElementById('canvas-capture');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            await addDoc(collection(db, "users", currentUser.uid, "attendance"), {
                nurseId: nurseId,
                nurseName: allNurses.find(n => n.id === nurseId).name,
                timestamp: Date.now(),
                photo: canvas.toDataURL('image/jpeg', 0.5),
                address: window.currentLocation?.address || "Unknown"
            });
            alert("Check-in Success!");
            window.toggleMode();
        };

        // --- UPDATED FORM ACTIONS (With Counter) ---
        document.getElementById('addNurseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('nurseName').value;
            const phone = document.getElementById('nursePhone').value;
            const role = document.getElementById('nurseSpec').value;
            const rate = document.getElementById('nurseRate').value;

            // 1. Add Nurse to Subcollection
            await addDoc(collection(db, "users", currentUser.uid, "nurses"), {
                name, phone, role, rate, timestamp: Date.now()
            });

            // 2. UPDATE COUNTER (Increment +1)
            await updateDoc(doc(db, "users", currentUser.uid), {
                nurseCount: increment(1)
            });

            window.closeModal();
            e.target.reset();
        });

        // --- UPDATED REMOVE FUNCTION (With Counter) ---
        window.removeNurse = async (id) => {
            if (confirm("Delete staff?")) {
                // 1. Delete Nurse
                await deleteDoc(doc(db, "users", currentUser.uid, "nurses", id));

                // 2. UPDATE COUNTER (Decrement -1)
                await updateDoc(doc(db, "users", currentUser.uid), {
                    nurseCount: increment(-1)
                });
            }
        };

        // --- NAVIGATION ---
        let isNurseMode = false;
        window.toggleMode = () => {
            isNurseMode = !isNurseMode;
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active-view'));

            if (isNurseMode) {
                document.getElementById('view-nurse').classList.add('active-view');
                document.getElementById('mode-text').innerText = "Admin Dashboard";
                document.getElementById('admin-menu').style.display = 'none';
                window.startCamera();
            } else {
                document.getElementById('view-dashboard').classList.add('active-view');
                document.getElementById('mode-text').innerText = "Nurse App";
                document.getElementById('admin-menu').style.display = 'flex';
                window.stopCamera();
            }
        };

        window.switchTab = (tab) => {
            if (isNurseMode) return;
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const nav = document.getElementById(`nav-${tab}`);
            if (nav) nav.classList.add('active');

            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active-view'));
            document.getElementById(`view-${tab}`).classList.add('active-view');
        };

        window.showLogin = () => {
            document.getElementById('public-landing').style.display = 'none';
            document.getElementById('login-overlay').style.display = 'flex';
        };
    </script>
</body>

</html>
