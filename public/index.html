<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silver Care | Premium Nursing Agency</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Rozha+One&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-main: #fffdf5;
            --bg-panel: #ffffff;
            --primary: #ff9933;
            /* Saffron */
            --primary-hover: #e68a00;
            --accent: #138808;
            /* India Green */
            --text-dark: #1a1a1a;
            --text-muted: #666666;
            --navy: #003366;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-main);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(255, 153, 51, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(19, 136, 8, 0.05) 0%, transparent 20%);
            color: var(--text-dark);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Layout --- */
        .app-container {
            display: grid;
            grid-template-columns: 260px 1fr;
            min-height: 100vh;
        }

        /* --- Sidebar --- */
        .sidebar {
            background: var(--bg-panel);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.02);
            height: 100vh;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .logo {
            font-family: 'Rozha One', serif;
            font-size: 1.8rem;
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .nav-menu {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .nav-item {
            padding: 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #fff5e6;
            color: var(--primary-hover);
            border-left: 4px solid var(--primary);
        }

        /* --- Main Content --- */
        .main-content {
            padding: 2rem 3rem;
            overflow-y: auto;
            position: relative;
        }

        /* Views */
        .view-section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .view-section.active-view {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
        }

        .page-title h1 {
            font-family: 'Rozha One', serif;
            font-size: 2.5rem;
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .namaste-icon {
            color: var(--primary);
            font-size: 2rem;
        }

        .page-title p {
            color: var(--text-muted);
            font-size: 1rem;
            margin-top: 5px;
        }

        /* --- Buttons & Inputs --- */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #ff7700);
            color: white;
            border: none;
            padding: 0.8rem 1.8rem;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 15px rgba(255, 153, 51, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 153, 51, 0.4);
        }

        .btn-mode {
            background: var(--navy);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            border: none;
            cursor: pointer;
            margin-bottom: 1rem;
            width: 100%;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
            transition: 0.2s;
        }

        .btn-icon:hover {
            color: #ff4444;
        }

        /* --- Stats & Cards --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        /* TOAST STYLES */
        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            border-left: 5px solid #4caf50;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
            transform: translateX(0);
            transition: 0.3s;
        }

        .toast.error {
            border-left-color: #d32f2f;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-icon {
            font-size: 1.2rem;
        }

        .toast-msg {
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
        }

        .card {
            background: var(--bg-panel);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0, 0, 0, 0.02);
            transition: transform 0.3s ease;
        }

        .stat-card {
            border-top: 4px solid var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
            color: var(--navy);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* --- UPDATED CALENDAR & CHECKBOX CSS --- */

        /* Payroll Checkbox */
        .paid-checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
            /* Makes the tick orange */
            cursor: pointer;
        }

        /* Calendar Header */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cal-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid #eee;
            background: white;
            cursor: pointer;
            color: var(--navy);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .cal-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .current-date-display {
            text-align: center;
        }

        .cal-month {
            font-weight: 700;
            color: var(--navy);
            font-size: 1.1rem;
        }

        .cal-year {
            font-size: 0.8rem;
            color: #888;
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .cal-day-header {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: #aaa;
            text-transform: uppercase;
            padding-bottom: 5px;
        }

        .cal-day {
            aspect-ratio: 1;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
            color: #444;
            border: 1px solid #f4f4f4;
            font-weight: 500;
            transition: all 0.2s;
        }

        .cal-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: var(--primary);
            z-index: 2;
        }

        .cal-day.present {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
            font-weight: 700;
        }

        .cal-day.absent {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .cal-day.today {
            border: 2px solid var(--primary);
        }

        .cal-day.empty {
            background: transparent;
            border: none;
            pointer-events: none;
        }

        .icon-circle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            background: #fff5e6;
            color: var(--primary);
            font-size: 1.2rem;
        }

        /* Add/Update this in your <style> block */

        .nurse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            padding-bottom: 2rem;
        }

        .nurse-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            /* Soft shadow */
            border: 1px solid rgba(0, 0, 0, 0.04);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .nurse-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        .delete-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            opacity: 0;
            transition: 0.2s;
        }

        .nurse-card:hover .delete-btn {
            opacity: 1;
        }

        .nurse-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.2rem;
            padding-bottom: 1rem;
            border-bottom: 1px dashed #eee;
        }

        .nurse-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: var(--navy);
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .status-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-online {
            background: var(--accent);
        }

        .status-busy {
            background: #ff4444;
        }

        .status-offline {
            background: #ccc;
        }

        .nurse-info h3 {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--navy);
        }

        .metrics-row {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed #eee;
        }

        .metric-val {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
            text-align: center;
        }

        .metric-lbl {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            display: block;
            text-align: center;
        }

        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            color: var(--navy);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 0.8rem;
            border-radius: 8px;
            color: #333;
            outline: none;
        }

        .form-input:focus {
            border-color: var(--primary);
            background: #fff;
        }

        .close-modal {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* --- Camera & Nurse App Specifics --- */
        .cam-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            margin-bottom: 1rem;
            border: 4px solid var(--navy);
        }

        video {
            width: 100%;
            height: 350px;
            object-fit: cover;
        }

        /* --- Payroll Table --- */
        .simple-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .simple-table th {
            text-align: left;
            padding: 1rem;
            background: #fff5e6;
            color: var(--navy);
            border-radius: 8px 8px 0 0;
        }

        .simple-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            font-size: 0.95rem;
        }

        /* --- Doc Locker Preview --- */
        .doc-box {
            border: 2px dashed #ccc;
            padding: 1rem;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            color: #777;
        }

        .doc-box:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .om-symbol {
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 10rem;
            opacity: 0.03;
            pointer-events: none;
            color: var(--primary);
            font-family: 'Rozha One', serif;
        }

        /* --- New Login UI Styles --- */
        .login-container {
            background: linear-gradient(135deg, #fffdf5 0%, #fff7e6 100%);
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Animated Background Shapes */
        .shape {
            position: absolute;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 10s infinite ease-in-out;
        }

        .shape-1 {
            top: -10%;
            right: -10%;
            width: 500px;
            height: 500px;
            background: #ff9933;
            animation-delay: 0s;
        }

        .shape-2 {
            bottom: -10%;
            left: -10%;
            width: 400px;
            height: 400px;
            background: #138808;
            animation-delay: 2s;
        }

        .shape-3 {
            top: 40%;
            left: 40%;
            width: 300px;
            height: 300px;
            background: #003366;
            opacity: 0.1;
            animation-delay: 4s;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(30px, 50px);
            }
        }

        /* Glass Card */
        .login-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 32px;
            padding: 4rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 51, 102, 0.15);
            position: relative;
            animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-logo {
            font-size: 4rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #ff9933, #003366);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: pulse 3s infinite;
        }

        /* Google Button */
        .google-btn {
            width: 100%;
            background: white;
            border: 2px solid #f0f0f0;
            padding: 1rem;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            color: #333;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 2rem;
            position: relative;
            overflow: hidden;
        }

        .google-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            border-color: #ff9933;
        }

        .google-btn:active {
            transform: scale(0.98);
        }

        /* Decorative Elements */
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #ddd, transparent);
            margin: 2rem 0;
            width: 100%;
        }

        .secure-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #f0f9ff;
            color: #003366;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 2rem;
        }

        /* Update .login-card width */
        .login-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 1);
            border-radius: 24px;
            padding: 3.5rem;
            /* More breathing room */
            width: 100%;
            max-width: 480px;
            /* Wider for desktop */
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        /* New Input Styles */
        .input-label {
            display: block;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
            color: #444;
            margin-bottom: 8px;
            margin-left: 4px;
        }

        .input-group {
            display: flex;
            gap: 0;
            /* Connected inputs */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            border-radius: 12px;
        }

        .modern-input {
            flex: 1;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-right: none;
            border-radius: 12px 0 0 12px;
            font-size: 1rem;
            outline: none;
            background: #fff;
            transition: 0.2s;
        }

        .modern-input:focus {
            border-color: var(--primary);
            background: #fffdf5;
        }

        .input-btn {
            border-radius: 0 12px 12px 0;
            padding: 0 1.5rem;
            margin: 0;
            box-shadow: none;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        /* Link Text */
        .link-text {
            font-size: 0.8rem;
            color: #666;
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.2s;
        }

        .link-text:hover {
            color: var(--primary);
        }

        /* Fix Divider */
        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 2rem 0;
            color: #aaa;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #eee;
        }

        .divider span {
            padding: 0 15px;
        }

        /* --- FIX: Hide Floating ReCAPTCHA Badge --- */
        .grecaptcha-badge {
            visibility: hidden;
        }

        /* 1. Make the overlay cover the WHOLE screen */
        .login-overlay {
            position: fixed;
            /* ðŸ‘ˆ This is the key */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            /* ðŸ‘ˆ Ensures it's above everything */
        }

        /* 2. Style the White Card inside */
        .login-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideUp 0.3s ease-out;
        }

        /* 3. Small animation to make it pop */
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* --- Profile Modal Styles --- */
        .profile-tabs {
            display: flex;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            flex: 1;
            border: none;
            background: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: 0.3s;
        }

        .tab-btn.active {
            background: white;
            color: var(--navy);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Calendar */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .cal-day-header {
            text-align: center;
            font-size: 0.75rem;
            color: #888;
            padding-bottom: 5px;
        }

        .cal-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.9rem;
            background: #f9f9f9;
            color: #ccc;
        }

        .cal-day.present {
            background: #e8f5e9;
            color: #2e7d32;
            font-weight: bold;
            border: 1px solid #c8e6c9;
        }

        .cal-day.absent {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .cal-day.today {
            border: 2px solid var(--primary);
        }

        /* Document Locker */
        .doc-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #fff;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .doc-icon {
            width: 40px;
            height: 40px;
            background: #e3f2fd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1565c0;
        }

        .btn-profile {
            width: 100%;
            margin-top: 10px;
            background: #e3f2fd;
            color: #1565c0;
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Add this to your CSS */
        .stat-card {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        /* --- WAR ROOM STYLES --- */
        .war-room-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .war-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #ccc;
            position: relative;
            overflow: hidden;
            transition: 0.3s;
        }

        .war-card.status-assigned {
            border-left-color: #ff9933;
        }

        .war-card.status-nurse_arrived {
            border-left-color: #2196F3;
        }

        .war-card.status-in_progress {
            border-left-color: #138808;
            background: #f1f8e9;
        }

        .war-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .war-timer {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.2rem;
            color: #138808;
            background: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #c8e6c9;
        }

        .war-body {
            padding: 1rem;
        }

        .war-step {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #555;
        }

        .war-step.active {
            color: #ff9933;
            font-weight: bold;
            animation: pulseText 1.5s infinite;
        }

        @keyframes pulseText {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .client-pill {
            background: #e3f2fd;
            color: #0d47a1;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            text-decoration: none;
        }
        /* Plan Selector Styles */
.plan-option.active {
    border-color: var(--primary) !important;
    background: #fff5e6 !important;
    color: var(--primary);
}
.plan-option:hover {
    background: #f9f9f9;
}
    </style>
</head>

<body>
    <div id="public-landing"
        style="background: linear-gradient(135deg, #fffdf5 0%, #fff7e6 100%); min-height: 100vh; display: flex; flex-direction: column;">

        <nav
            style="padding: 1rem 3rem; display: flex; justify-content: space-between; align-items: center; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000;">
            <div
                style="font-family: 'Rozha One', serif; font-size: 1.8rem; color: #003366; display: flex; align-items: center; gap: 10px;">
                <i class="fa-solid fa-hands-holding-circle" style="color: #ff9933;"></i> Silver Care
            </div>

            <div style="display: flex; align-items: center; gap: 30px;">
                <div style="display: flex; gap: 25px; font-weight: 500; font-size: 0.95rem;">
                    <a href="#" style="text-decoration: none; color: #003366;">Home</a>
                    <a href="#services" style="text-decoration: none; color: #666; transition: 0.3s;">Services</a>
                    <a href="#about" style="text-decoration: none; color: #666; transition: 0.3s;">About Us</a>
                    <a href="#contact" style="text-decoration: none; color: #666; transition: 0.3s;">Contact</a>
                </div>

                <button onclick="showLogin()" class="btn-primary"
                    style="padding: 0.6rem 1.5rem; font-size: 0.9rem; border-radius: 30px;">
                    Staff Login <i class="fa-solid fa-lock"></i>
                </button>
            </div>
        </nav>

        <div
            style="flex: 1; display: flex; align-items: center; justify-content: center; text-align: center; padding: 2rem;">
            <div style="max-width: 800px;">
                <span
                    style="background: #e3f2fd; color: #1565c0; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                    <i class="fa-solid fa-layer-group"></i> INDIA'S #1 AGENCY SOFTWARE
                </span>

                <h1
                    style="font-family: 'Rozha One', serif; font-size: 3.5rem; color: #003366; margin: 1.5rem 0; line-height: 1.2;">
                    The Operating System for <br><span style="color: #ff9933;">Nursing Agencies</span>
                </h1>

                <p
                    style="font-size: 1.1rem; color: #666; margin-bottom: 2.5rem; line-height: 1.6; max-width: 700px; margin-left: auto; margin-right: auto;">
                    Silver Care empowers nursing bureaus to automate staff attendance, streamline payroll, and manage
                    client bookings in real-time.
                    Stop using paper; start scaling your agency.
                </p>

                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="showLogin()" class="btn-primary"
                        style="padding: 1rem 2.5rem; font-size: 1.1rem; border-radius: 30px;">
                        Agency Login <i class="fa-solid fa-arrow-right-to-bracket"></i>
                    </button>

                    <button onclick="window.location.href='#contact'"
                        style="background:white; border:2px solid #003366; color:#003366; padding:1rem 2rem; border-radius:30px; font-weight:600; cursor:pointer; transition: 0.3s;">
                        Contact Sales
                    </button>
                </div>
            </div>
        </div>
        <div id="services" style="padding: 4rem 2rem; text-align: center; background: white;">
            <h2 style="color: #003366; font-family: 'Rozha One', serif; margin-bottom: 3rem;">Platform Features</h2>
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; max-width: 1100px; margin: 0 auto;">

                <div
                    style="padding: 2.5rem; border: 1px solid #eee; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); text-align: left;">
                    <div
                        style="width: 50px; height: 50px; background: #fff3e0; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem;">
                        <i class="fa-solid fa-users-viewfinder" style="font-size: 1.5rem; color: #ff9933;"></i>
                    </div>
                    <h3 style="color: #003366; margin-bottom: 10px; font-weight: 700;">Staff Verification</h3>
                    <p style="color: #666; font-size: 0.95rem; line-height: 1.6;">Digitize your staff records with
                        Aadhaar verification and document lockers. Keep your agency compliant and organized.</p>
                </div>

                <div
                    style="padding: 2.5rem; border: 1px solid #eee; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); text-align: left;">
                    <div
                        style="width: 50px; height: 50px; background: #e8f5e9; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem;">
                        <i class="fa-solid fa-location-dot" style="font-size: 1.5rem; color: #138808;"></i>
                    </div>
                    <h3 style="color: #003366; margin-bottom: 10px; font-weight: 700;">GPS Attendance</h3>
                    <p style="color: #666; font-size: 0.95rem; line-height: 1.6;">Real-time geolocation tracking for
                        nurse check-ins. Eliminate fake attendance and billing disputes instantly.</p>
                </div>

                <div
                    style="padding: 2.5rem; border: 1px solid #eee; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); text-align: left;">
                    <div
                        style="width: 50px; height: 50px; background: #e3f2fd; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem;">
                        <i class="fa-solid fa-file-invoice-dollar" style="font-size: 1.5rem; color: #1565c0;"></i>
                    </div>
                    <h3 style="color: #003366; margin-bottom: 10px; font-weight: 700;">Automated Payroll</h3>
                    <p style="color: #666; font-size: 0.95rem; line-height: 1.6;">Calculate daily wages, overtime, and
                        agency commissions with one click. Export reports for hassle-free payments.</p>
                </div>

            </div>
        </div>

        <div id="about" style="padding: 5rem 2rem; background: #fffdf5; text-align: center;">
            <div style="max-width: 900px; margin: 0 auto;">
                <span style="color: #ff9933; font-weight: 600; letter-spacing: 1px; font-size: 0.9rem;">OUR
                    MISSION</span>
                <h2 style="color: #003366; font-family: 'Rozha One', serif; margin: 10px 0 2rem 0; font-size: 2.5rem;">
                    Digitizing India's Healthcare Workforce</h2>

                <p style="font-size: 1.1rem; color: #555; line-height: 1.8; margin-bottom: 2rem;">
                    Silver Care is a technology partner for nursing bureaus and hospitals. We recognized that agency
                    owners spend too much time on paperwork
                    and not enough on patient care. Our platform provides the digital infrastructure to manage staff
                    efficiently, transparently, and professionally.
                </p>

                <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 3rem;">
                    <div
                        style="flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                        <h3 style="color: #138808; font-size: 2rem; font-weight: 700; margin-bottom: 5px;">50+</h3>
                        <p style="color: #666; font-size: 0.9rem;">Agencies Onboarded</p>
                    </div>
                    <div
                        style="flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                        <h3 style="color: #ff9933; font-size: 2rem; font-weight: 700; margin-bottom: 5px;">10k+</h3>
                        <p style="color: #666; font-size: 0.9rem;">Shifts Tracked</p>
                    </div>
                    <div
                        style="flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                        <h3 style="color: #003366; font-size: 2rem; font-weight: 700; margin-bottom: 5px;">100%</h3>
                        <p style="color: #666; font-size: 0.9rem;">Cloud Secure</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="contact" style="padding: 5rem 2rem; background: white; text-align: center;">
            <div style="max-width: 1000px; margin: 0 auto;">
                <h2 style="color: #003366; font-family: 'Rozha One', serif; margin-bottom: 3rem; font-size: 2.5rem;">Get
                    In Touch</h2>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem;">

                    <div
                        style="padding: 2rem; border: 1px solid #eee; border-radius: 16px; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.03);">
                        <div
                            style="width: 60px; height: 60px; background: #e3f2fd; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem auto;">
                            <i class="fa-solid fa-phone" style="font-size: 1.5rem; color: #1565c0;"></i>
                        </div>
                        <h3 style="color: #333; margin-bottom: 10px; font-weight: 600;">Call Us Anytime</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">Available 24/7 for emergencies.
                        </p>
                        <a href="tel:+918299341343"
                            style="color: #1565c0; font-weight: 700; text-decoration: none; font-size: 1.1rem;">+91
                            82993 41343</a>
                    </div>

                    <div
                        style="padding: 2rem; border: 1px solid #eee; border-radius: 16px; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.03);">
                        <div
                            style="width: 60px; height: 60px; background: #fff3e0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem auto;">
                            <i class="fa-solid fa-envelope" style="font-size: 1.5rem; color: #e65100;"></i>
                        </div>
                        <h3 style="color: #333; margin-bottom: 10px; font-weight: 600;">Email Us</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">For corporate or bulk bookings.
                        </p>
                        <a href="mailto:silvercare242@gmail.com"
                            style="color: #e65100; font-weight: 700; text-decoration: none; font-size: 1.1rem;">silvercare242@gmail.com</a>
                    </div>

                    <div
                        style="padding: 2rem; border: 1px solid #eee; border-radius: 16px; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.03);">
                        <div
                            style="width: 60px; height: 60px; background: #e8f5e9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem auto;">
                            <i class="fa-solid fa-location-dot" style="font-size: 1.5rem; color: #2e7d32;"></i>
                        </div>
                        <h3 style="color: #333; margin-bottom: 10px; font-weight: 600;">Visit Our Office</h3>
                        <p style="color: #666; font-size: 1rem; line-height: 1.5;">
                            Varanasi, Uttar Pradesh<br>India
                        </p>
                    </div>

                </div>
            </div>
        </div>




        <footer style="background: white; padding: 3rem; border-top: 1px solid #eee; margin-top: auto;">
            <div style="max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">

                <div>
                    <h4 style="color: #003366; margin-bottom: 1rem;">Contact Us</h4>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                        <i class="fa-solid fa-envelope"></i> silvercare242@gmail.com
                    </p>
                    <p style="color: #666; font-size: 0.9rem;">
                        <i class="fa-solid fa-phone"></i> +91 8299341343
                    </p>
                    <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">
                        <i class="fa-solid fa-location-dot"></i> Varanasi, Uttar Pradesh, India
                    </p>
                </div>

                <div style="text-align: right;">
                    <h4 style="color: #003366; margin-bottom: 1rem;">Legal</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                        <a href="terms.html" target="_blank"
                            style="color: #666; text-decoration: none; font-size: 0.9rem;">Terms & Conditions</a>
                        <a href="privacy.html" target="_blank"
                            style="color: #666; text-decoration: none; font-size: 0.9rem;">Privacy Policy</a>
                        <a href="refund.html" target="_blank"
                            style="color: #666; text-decoration: none; font-size: 0.9rem;">Refund & Cancellation
                            Policy</a>
                        <a href="pricing.html" target="_blank"
                            style="color: #666; text-decoration: none; font-size: 0.9rem;">Pricing</a>
                        <a href="contact.html" target="_blank"
                            style="color: #666; text-decoration: none; font-size: 0.9rem;">Contact Us</a>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px dashed #eee;">
                <p style="color: #003366; font-weight: 600; font-size: 0.9rem; margin-bottom: 5px;">
                    Silver Care is a product of Q-SENSE DYNAMICS PRIVATE LIMITED.
                </p>
                <p style="font-size: 0.8rem; color: #aaa;">
                    Â© 2025 Silver Care Technologies. All rights reserved.
                </p>
            </div>
        </footer>
    </div>

    <div id="login-overlay" class="login-container">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>

        <div class="login-card">
            <div class="secure-badge">
                <i class="fa-solid fa-shield-halved"></i> Secure Staff Portal
            </div>

            <h1 class="login-logo" style="font-family: 'Rozha One', serif;">Silver Care</h1>
            <p style="color: #555; font-size: 1rem; margin-bottom: 2.5rem;">
                Log in to manage staff, payroll, and bookings.
            </p>

            <div id="phone-auth-section">
                <div id="recaptcha-container"></div>

                <div id="step-phone">
                    <label class="input-label">Mobile Number</label>
                    <div class="input-group">
                        <input type="tel" id="phone-number" class="modern-input" placeholder="+91 98765 43210">
                        <button onclick="sendOTP()" id="send-otp-btn" class="btn-primary input-btn">
                            Send OTP
                        </button>
                    </div>
                </div>

                <div id="step-otp" style="display: none;">
                    <label class="input-label">One Time Password</label>
                    <div class="input-group">
                        <input type="text" id="otp-code" class="modern-input" placeholder="Enter 6-digit code"
                            maxlength="6" style="letter-spacing: 3px; font-weight: 700;">
                        <button onclick="verifyOTP()" id="verify-otp-btn" class="btn-primary input-btn"
                            style="background: var(--accent);">
                            Verify
                        </button>
                    </div>
                    <div style="text-align: right; margin-top: 8px;">
                        <span class="link-text" onclick="resetPhoneAuth()">Change Number</span>
                    </div>
                </div>
            </div>

            <div class="divider"><span>OR</span></div>

            <button onclick="loginWithGoogle()" class="google-btn" id="g-login-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" alt="Google">
                <span>Continue with Google Account</span>
            </button>

            <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.05);">
                <p style="font-size: 0.7rem; color: #aaa; line-height: 1.4;">
                    By logging in, you agree to the Terms of Service & Privacy Policy.<br>
                    This site is protected by reCAPTCHA and the Google
                    <a href="https://policies.google.com/privacy" target="_blank" style="color:#aaa;">Privacy Policy</a>
                    and
                    <a href="https://policies.google.com/terms" target="_blank" style="color:#aaa;">Terms of Service</a>
                    apply.
                </p>
            </div>
        </div>
    </div>

    <div class="app-container" style="display: none;">
        <nav class="sidebar">
            <div class="logo" onclick="switchTab('dashboard')">
                <i class="fa-solid fa-hands-holding-circle" style="color: var(--primary);"></i> Silver Care
            </div>



            <ul class="nav-menu" id="admin-menu">
                <li class="nav-item active" id="nav-dashboard" onclick="switchTab('dashboard')">
                    <i class="fa-solid fa-house-chimney-medical"></i> Seva Kendra (Home)
                </li>
                <li class="nav-item" id="nav-staff" onclick="switchTab('staff')">
                    <i class="fa-solid fa-user-nurse"></i> Karmachari (Staff)
                </li>
                <li class="nav-item" id="nav-war-room" onclick="switchTab('war-room')">
                    <i class="fa-solid fa-tower-broadcast" style="color: #d32f2f;"></i> War Room
                </li>
                <li class="nav-item" id="nav-logs" onclick="switchTab('logs')">
                    <i class="fa-solid fa-clipboard-list"></i> Daily Logs
                </li>
                <li class="nav-item" id="nav-payroll" onclick="switchTab('payroll')">
                    <i class="fa-solid fa-money-check-dollar"></i> Payroll
                </li>
                <li class="nav-item" id="nav-bookings" onclick="switchTab('bookings')">
                    <i class="fa-brands fa-whatsapp" style="color: #25D366;"></i> AI Bookings
                </li>

                <li class="nav-item" onclick="logoutApp()" style="margin-top: 1rem; color: #ff4444;">
                    <i class="fa-solid fa-right-from-bracket"></i> Logout
                </li>

                <li class="nav-item" id="nav-super-admin" onclick="switchTab('super-admin')"
                    style="display: none; margin-top: 20px; background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; font-weight: bold;">
                    <i class="fa-solid fa-user-secret"></i> Super Admin
                </li>
            </ul>

            <div
                style="margin-top: auto; padding: 1rem; background: #f0f7ff; border-radius: 12px; border: 1px solid #dbeafe;">
                <p style="font-size: 0.8rem; color: var(--navy); font-weight: 600;">System Status</p>
                <div
                    style="display: flex; align-items: center; gap: 8px; color: var(--accent); font-size: 0.85rem; margin-top: 5px;">
                    <div class="status-dot status-online" style="position: relative;"></div> Firebase Connected
                </div>
            </div>
        </nav>

        <main class="main-content">
            <div class="om-symbol">à¥</div>

            <div id="view-dashboard" class="view-section active-view">
                <header>
                    <div class="page-title">
                        <h1><span class="namaste-icon"><i class="fa-solid fa-hands-praying"></i></span> Namaste, <span
                                id="admin-name">Admin</span></h1>
                        <p>Welcome to your Digital Seva Portal</p>
                    </div>
                    <button class="btn-primary" onclick="openModal()">
                        <i class="fa-solid fa-plus"></i> Add Sahayak
                    </button>
                </header>

                <div class="stats-grid">
                    <div class="card stat-card" onclick="switchTab('staff')">
                        <div class="icon-circle"><i class="fa-solid fa-users"></i></div>
                        <div class="stat-label">Total Staff</div>
                        <div class="stat-value" id="stat-total">0</div>
                    </div>

                    <div class="card stat-card" onclick="showPresentToday()">
                        <div class="icon-circle" style="color: var(--accent);"><i class="fa-solid fa-check-to-slot"></i>
                        </div>
                        <div class="stat-label">Present Today</div>
                        <div class="stat-value" id="stat-present">0</div>
                    </div>

                    <div class="card stat-card" onclick="switchTab('payroll')">
                        <div class="icon-circle" style="color: var(--navy);"><i
                                class="fa-solid fa-indian-rupee-sign"></i></div>
                        <div class="stat-label">Payroll Est.</div>
                        <div class="stat-value" id="stat-payroll-total">â‚¹0</div>
                    </div>
                </div>

                <h2 style="font-family: 'Rozha One'; color: var(--navy); margin-bottom: 1.5rem;">Recent Activity</h2>
                <div class="nurse-grid" id="dashboard-grid">
                </div>
            </div>

            <div id="view-war-room" class="view-section">
                <header>
                    <div class="page-title">
                        <h1><span class="namaste-icon" style="color:#d32f2f;">ðŸ”´</span> Live War Room</h1>
                        <p>Real-time deployment tracking & timer</p>
                    </div>
                    <div style="font-size:0.9rem; color:#666;">
                        <i class="fa-solid fa-circle" style="color:#ff9933;"></i> En Route &nbsp;
                        <i class="fa-solid fa-circle" style="color:#138808;"></i> On Duty
                    </div>
                </header>

                <div id="war-room-grid" class="war-room-container">
                    <div class="empty-state">
                        <i class="fa-solid fa-satellite-dish" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>No Active Deployments</h3>
                        <p>Waiting for bookings via WhatsApp...</p>
                    </div>
                </div>
            </div>

            <div id="view-bookings" class="view-section">
                <header>
                    <div class="page-title">
                        <h1>WhatsApp Requests</h1>
                        <p>Real-time orders extracted by AI</p>
                    </div>
                </header>

                <div class="nurse-grid" id="bookings-grid">
                    <div style="color: #999; grid-column: 1/-1; text-align: center; padding: 2rem;">
                        Waiting for new messages...
                    </div>
                </div>
            </div>

            <div id="view-nurse" class="view-section">
                <div class="card" style="max-width: 450px; margin: 0 auto; text-align: center;">
                    <h2 style="font-family:'Rozha One'; color: var(--navy); margin-bottom: 1rem;">Daily Check-In</h2>

                    <div class="form-group" style="text-align: left;">
                        <label>Select Your Name</label>
                        <select id="nurse-login-select" class="form-input">
                        </select>
                    </div>

                    <div class="cam-container">
                        <video id="video-feed" autoplay playsinline></video>
                        <canvas id="canvas-capture" style="display:none;"></canvas>
                    </div>

                    <div id="location-status"
                        style="background: #f0f0f0; padding: 10px; border-radius: 8px; font-size: 0.8rem; margin-bottom: 1rem; color: #555;">
                        <i class="fa-solid fa-location-crosshairs"></i> Waiting for GPS...
                    </div>

                    <button class="btn-primary" style="width: 100%; padding: 1rem;" onclick="performCheckIn()">
                        <i class="fa-solid fa-camera"></i> SNAP & CHECK IN
                    </button>
                    <p style="font-size: 0.7rem; color: #999; margin-top: 10px;">Location recorded for verification</p>
                </div>
            </div>

            <div id="view-staff" class="view-section">
                <header
                    style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
                    <div class="page-title">
                        <h1>Staff Directory</h1>
                        <p>Manage all registered employees</p>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button class="btn-primary" onclick="toggleManageMode()"
                            style="background: white; color: var(--navy); border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            <i class="fa-solid fa-list-check"></i> Manage
                        </button>

                        <button class="btn-primary" onclick="window.exportToCSV()"
                            style="box-shadow: 0 4px 15px rgba(255, 153, 51, 0.4);">
                            <i class="fa-solid fa-download"></i> Export
                        </button>
                    </div>
                </header>

                <div id="bulk-action-bar"
                    style="display: none; background: #ffebee; padding: 12px 20px; border-radius: 12px; align-items: center; justify-content: space-between; border: 1px solid #ffcdd2; margin-bottom: 2rem; animation: fadeIn 0.3s ease;">
                    <div style="color: #c62828; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-circle-check"></i>
                        <span id="selected-count">0</span> Staff Selected
                    </div>
                    <button onclick="bulkDelete()"
                        style="background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);">
                        Delete Selected <i class="fa-solid fa-trash" style="margin-left: 5px;"></i>
                    </button>
                </div>

                <div class="nurse-grid" id="staff-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem;">
                </div>
            </div>

            <div class="modal" id="replaceModal">
                <div class="modal-content">
                    <button class="close-modal"
                        onclick="document.getElementById('replaceModal').classList.remove('active')">
                        <i class="fa-solid fa-xmark"></i>
                    </button>

                    <h2 style="margin-bottom: 0.5rem; font-family: 'Rozha One'; color: var(--navy);">Replace Staff</h2>

                    <p id="replace-message"
                        style="color: #666; font-size: 0.95rem; margin-bottom: 1.5rem; line-height: 1.6; background: #f9f9f9; padding: 10px; border-radius: 8px; border-left: 4px solid var(--primary);">
                        Loading details...
                    </p>

                    <form id="replaceNurseForm">
                        <input type="hidden" id="replace-old-id">

                        <div class="form-group">
                            <label>New Staff Name</label>
                            <input type="text" class="form-input" id="repName" required placeholder="Ex. Priya Singh">
                        </div>

                        <div class="form-group">
                            <label>WhatsApp Number</label>
                            <input type="tel" class="form-input" id="repPhone" required placeholder="919876543210">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Role</label>
                                <input type="text" class="form-input" id="repRole" required placeholder="Nurse">
                            </div>
                            <div class="form-group">
                                <label>Rate (â‚¹)</label>
                                <input type="number" class="form-input" id="repRate" required placeholder="800">
                            </div>
                        </div>

                        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">
                            Confirm Swap <i class="fa-solid fa-arrow-right-arrow-left"></i>
                        </button>
                    </form>
                </div>
            </div>

            <div class="modal" id="replaceModal">
                <div class="modal-content">
                    <button class="close-modal"
                        onclick="document.getElementById('replaceModal').classList.remove('active')">
                        <i class="fa-solid fa-xmark"></i>
                    </button>

                    <h2 style="margin-bottom: 0.5rem; font-family: 'Rozha One'; color: var(--navy);">Replace Staff</h2>

                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem; line-height: 1.6;">
                    </p>

                    <form id="replaceNurseForm">
                        <input type="hidden" id="replace-old-id">

                        <div class="form-group">
                            <label>New Staff Name</label>
                            <input type="text" class="form-input" id="repName" required placeholder="New Name">
                        </div>

                        <div class="form-group">
                            <label>New WhatsApp Number</label>
                            <input type="tel" class="form-input" id="repPhone" required placeholder="919876543210">
                        </div>

                        <div class="form-group">
                            <label>Role</label>
                            <input type="text" class="form-input" id="repRole" required placeholder="Ex. Nurse">
                        </div>

                        <div class="form-group">
                            <label>Daily Rate (â‚¹)</label>
                            <input type="number" class="form-input" id="repRate" required placeholder="Ex. 800">
                        </div>

                        <button type="submit" class="btn-primary" style="width: 100%; background: var(--navy);">
                            <i class="fa-solid fa-arrow-right-arrow-left"></i> Confirm Replacement
                        </button>
                    </form>
                </div>
            </div>

            <div id="view-super-admin" class="view-section">
                <header>
                    <div class="page-title">
                        <h1><span class="namaste-icon">ðŸ‘‘</span> Admin Control</h1>
                        <p>Verify payments & track sales</p>
                    </div>
                    <button class="btn-primary" onclick="window.exportToCSV()">
                        <i class="fa-solid fa-download"></i> Export CSV
                    </button>
                </header>




                <h3
                    style="color: var(--navy); margin-bottom: 1rem; border-bottom: 2px solid #138808; display:inline-block;">
                    ðŸ† Intern Leaderboard
                </h3>
                <div class="stats-grid" id="admin-leaderboard">
                </div>

                <h3 style="color: var(--navy); margin-bottom: 1rem;">ðŸ‘¥ All Agencies</h3>
                <div class="card" style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                    <table class="simple-table">
                        <thead>
                            <tr>
                                <th>Agency</th>
                                <th>Email</th>
                                <th>Referral</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="admin-all-users"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-logs" class="view-section">
                <header>
                    <div class="page-title">
                        <h1>Daily Attendance Logs</h1>
                        <p>Real-time check-in data with location</p>
                    </div>
                </header>
                <div id="logs-list-container" style="display: flex; flex-direction: column; gap: 1rem;">
                </div>
            </div>

            <div id="view-payroll" class="view-section">
                <header>
                    <div class="page-title">
                        <h1>Payroll Calculation</h1>
                        <p>Automated salary based on attendance</p>
                    </div>

                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="month" id="payroll-month-picker" class="form-input"
                            style="width: auto; padding: 8px;" onchange="window.calculatePayroll()">

                        <button class="btn-primary" onclick="alert('Exporting PDF...')">
                            <i class="fa-solid fa-download"></i> Export
                        </button>
                    </div>
                </header>
                <div class="card" style="overflow-x: auto;">
                    <table class="simple-table">
                        <thead>
                            <tr>
                                <th>Nurse Name</th>
                                <th>Daily Rate</th>
                                <th>Days Worked</th>
                                <th>Total Salary</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="payroll-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

   
    <div class="modal" id="addModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto; scrollbar-width: thin;">
            <button class="close-modal" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
            <h2 style="margin-bottom: 1rem; font-family: 'Rozha One'; color: var(--navy);">New Staff Entry</h2>
            
            <form id="addNurseForm">
                <div style="background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #eee;">
                    <label style="font-weight: 600; color: var(--navy); margin-bottom: 10px; display: block; font-size: 0.9rem;">Select Validity Plan:</label>
                    
                    <div style="display: flex; gap: 12px;">
                        <label style="flex: 1; cursor: pointer; position: relative;">
                            <input type="radio" name="staffPlan" value="monthly" checked onchange="updateCreditDisplay()" style="position: absolute; opacity: 0; width:0; height:0;">
                            <div id="opt-monthly" class="plan-option active" style="padding: 12px; border: 2px solid var(--primary); border-radius: 8px; text-align: center; background: white; transition: 0.2s; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                                <div style="font-weight: bold; color: var(--navy); font-size: 0.95rem;">Monthly</div>
                                <div style="font-size: 0.75rem; color: #666;">30 Days</div>
                            </div>
                        </label>
    
                        <label style="flex: 1; cursor: pointer; position: relative;">
                            <input type="radio" name="staffPlan" value="daily" onchange="updateCreditDisplay()" style="position: absolute; opacity: 0; width:0; height:0;">
                            <div id="opt-daily" class="plan-option" style="padding: 12px; border: 2px solid transparent; border-radius: 8px; text-align: center; background: white; transition: 0.2s; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                                <div style="font-weight: bold; color: var(--navy); font-size: 0.95rem;">Daily Pass</div>
                                <div style="font-size: 0.75rem; color: #666;">24 Hours</div>
                            </div>
                        </label>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 12px; background: #fff; padding: 8px 12px; border-radius: 6px; border: 1px dashed #ddd;">
                        <span id="credit-status-text" style="font-size: 0.8rem; font-weight: 600; color: #666;">Checking credits...</span>
                        
                        <button type="button" onclick="openPaymentFromForm()" style="background: var(--navy); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 5px;">
                            <i class="fa-solid fa-cart-plus"></i> Buy More
                        </button>
                    </div>
                </div>
    
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" class="form-input" id="nurseName" required placeholder="Ex. Anjali Gupta">
                </div>
    
                <div class="form-group">
                    <label>WhatsApp Number (Active)</label>
                    <input type="tel" class="form-input" id="nursePhone" required
                        placeholder="919876543210 (No spaces or +)">
                    <p style="font-size: 0.7rem; color: #888; margin-top: 4px;">Must match their WhatsApp number exactly.</p>
                </div>
    
                <div class="form-group">
                    <label>Role</label>
                    <input type="text" class="form-input" id="nurseSpec" required placeholder="Ex. Senior Sister">
                </div>
                
                <div class="form-group">
                    <label>Daily Rate (â‚¹)</label>
                    <input type="number" class="form-input" id="nurseRate" required placeholder="Ex. 800">
                </div>
    
                <div class="form-group">
                    <label>Document Locker (Aadhaar/ID)</label>
                    <input type="file" id="nurseDoc" style="display: none;" accept="image/*,.pdf"
                        onchange="handleFileSelect(this)">
                    <div class="doc-box" id="doc-trigger" onclick="document.getElementById('nurseDoc').click()">
                        <i class="fa-solid fa-cloud-arrow-up" id="doc-icon"></i>
                        <span id="doc-text">Upload ID Card</span>
                    </div>
                </div>
                
                <button type="submit" class="btn-primary" style="width: 100%;">Save Entry</button>
            </form>
        </div>
    </div>
    <div id="modal-onboarding" class="login-overlay" style="display: none; z-index: 9999;">
        <div class="login-card" style="text-align: center;">
            <h2 style="color: var(--navy); margin-bottom: 1rem;">Welcome to Silver Care!</h2>
            <p style="color: #666; margin-bottom: 2rem;">Please setup your agency profile.</p>

            <input type="text" id="inp-agency-name" class="form-input" placeholder="Enter Agency Name (e.g. Happy Care)"
                style="margin-bottom: 1rem;">
            <input type="text" id="inp-referral-code" class="form-input" placeholder="Referral Code (Optional)"
                style="margin-bottom: 2rem; border: 2px dashed #ff9933;">

            <button onclick="submitOnboarding()" class="btn-primary" style="width: 100%;">
                Continue <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>
    <div id="modal-payment-lock" class="login-overlay" style="display: none; z-index: 9999;">
        <div class="login-card"
            style="text-align: center; max-width: 450px; position: relative; max-height: 85vh; overflow-y: auto;">
    
            <div id="payment-form-section">
                <div
                    style="background: #e3f2fd; color: #1565c0; padding: 5px 15px; border-radius: 20px; display: inline-block; font-size: 0.8rem; font-weight: bold; margin-bottom: 1rem;">
                    <i class="fa-solid fa-bolt"></i> INSTANT ACTIVATION
                </div>
    
                <h2 style="color: var(--navy); margin-bottom: 0.5rem;">Select Plan</h2>
    
                <div style="background: #f0f0f0; padding: 5px; border-radius: 12px; display: flex; gap: 5px; margin-bottom: 1.5rem; border: 1px solid #ddd;">
                    <button id="plan-monthly" onclick="switchPlan('monthly')" 
                        style="flex: 1; padding: 10px; border-radius: 8px; border: none; background: white; color: var(--navy); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s;">
                        Monthly (30 Days)
                    </button>
                    <button id="plan-daily" onclick="switchPlan('daily')" 
                        style="flex: 1; padding: 10px; border-radius: 8px; border: none; background: transparent; color: #666; font-weight: 600; cursor: pointer; transition: 0.2s;">
                        Daily (24 Hours)
                    </button>
                </div>
    
                <p id="plan-desc" style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem; background: #fff; padding: 10px; border-radius: 8px; border: 1px dashed #ccc;">
                    Best for regular staff. Valid for 30 days.
                </p>
    
                <div style="margin-bottom: 1.5rem; text-align: left;">
                    <label style="font-weight: bold; color: var(--navy); font-size: 0.9rem;">Quantity:</label>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <input type="number" id="slot-quantity" class="form-input" value="1" min="1" max="100"
                            oninput="window.calculateTotal()"
                            style="font-size: 1.2rem; font-weight: bold; text-align: center;">
                    </div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px; font-weight: 500;">
                        Rate: <span id="plan-rate" style="color: #138808; font-weight: bold;">â‚¹199 per slot</span>
                    </div>
                </div>
    
                <div
                    style="background: #f9f9f9; padding: 15px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 1.5rem; text-align: left;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; color: var(--navy);">Total to Pay:</span>
                        <span id="bill-total" style="font-size: 1.4rem; color: #138808; font-weight: bold;">â‚¹199</span>
                    </div>
                </div>
    
                <button id="rzp-button" onclick="window.startRazorpayPayment()" class="btn-primary"
                    style="width: 100%; margin-bottom: 10px;">
                    Pay & Activate <i class="fa-solid fa-credit-card"></i>
                </button>
    
                <button id="btn-pay-later" onclick="window.activatePayLater()"
                    style="background: none; border: none; color: #666; text-decoration: underline; cursor: pointer; font-size: 0.9rem;">
                    Cancel (Go Back)
                </button>
            </div>
    
        </div>
    </div>

    <div class="modal" id="profileModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <button class="close-modal" onclick="document.getElementById('profileModal').classList.remove('active')"><i
                    class="fa-solid fa-xmark"></i></button>

            <div style="text-align:center; margin-bottom:1.5rem;">
                <h2 id="p-name" style="color:var(--navy);">Nurse Name</h2>
                <p id="p-role" style="color:#666; font-size:0.9rem;">Role</p>
            </div>

            <div class="profile-tabs">
                <button class="tab-btn active" onclick="switchProfileTab('attendance')">Attendance</button>
                <button class="tab-btn" onclick="switchProfileTab('docs')">Documents</button>
                <button class="tab-btn" onclick="switchProfileTab('edit')">Edit Info</button>
            </div>

            <div id="tab-attendance" class="tab-content active">
                <div class="calendar-controls">
                    <div class="control-group">
                        <button class="cal-btn" onclick="changeMonth(-1)"><i
                                class="fa-solid fa-chevron-left"></i></button>
                        <div class="current-date-display">
                            <div class="cal-month" id="cal-month-text">Month</div>
                            <div style="font-size: 0.65rem; color:#ccc; text-transform:uppercase;">Month</div>
                        </div>
                        <button class="cal-btn" onclick="changeMonth(1)"><i
                                class="fa-solid fa-chevron-right"></i></button>
                    </div>

                    <div class="control-group">
                        <button class="cal-btn" onclick="changeYear(-1)"><i class="fa-solid fa-backward"></i></button>
                        <div class="current-date-display">
                            <div class="cal-month" id="cal-year-text">Year</div>
                            <div style="font-size: 0.65rem; color:#ccc; text-transform:uppercase;">Year</div>
                        </div>
                        <button class="cal-btn" onclick="changeYear(1)"><i class="fa-solid fa-forward"></i></button>
                    </div>
                </div>

                <div class="calendar-grid" id="cal-days-container"></div>

                <div style="display:flex; gap:15px; justify-content:center; margin-top:20px; font-size:0.8rem;">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <div
                            style="width:12px; height:12px; background:#e8f5e9; border:1px solid #c8e6c9; border-radius:4px;">
                        </div> Present
                    </div>
                    <div style="display:flex; align-items:center; gap:6px;">
                        <div
                            style="width:12px; height:12px; background:#ffebee; border:1px solid #ffcdd2; border-radius:4px;">
                        </div> Absent
                    </div>
                </div>
            </div>

            <div id="tab-docs" class="tab-content">
                <div style="border:2px dashed #ddd; padding:1.5rem; text-align:center; border-radius:12px; cursor:pointer; margin-bottom:15px;"
                    onclick="document.getElementById('doc-upload').click()">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size:1.5rem; color:var(--primary);"></i>
                    <p style="font-size:0.8rem; color:#666;">Upload ID/Certificate</p>
                    <input type="file" id="doc-upload" hidden accept="image/*,.pdf">
                </div>
                <div id="doc-list"></div>
            </div>

            <div id="tab-edit" class="tab-content">
                <form id="editNurseForm">
                    <input type="hidden" id="edit-id">
                    <div class="form-group"><label>Full Name</label><input type="text" id="edit-name"
                            class="form-input"></div>
                    <div class="form-group"><label>Phone</label><input type="text" id="edit-phone" class="form-input">
                    </div>
                    <div class="form-group"><label>Rate (â‚¹)</label><input type="number" id="edit-rate"
                            class="form-input"></div>
                    <div class="form-group"><label>Role</label><input type="text" id="edit-role" class="form-input">
                    </div>
                    <button type="submit" class="btn-primary" style="width:100%; margin-top:10px;">Update
                        Profile</button>
                </form>
            </div>
        </div>
    </div>
    <div class="modal" id="confirmModal" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 400px; text-align: center; border-top: 5px solid #d32f2f;">
            <div
                style="width: 60px; height: 60px; background: #ffebee; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem auto;">
                <i class="fa-solid fa-triangle-exclamation" style="font-size: 1.8rem; color: #d32f2f;"></i>
            </div>

            <h2 id="confirm-title" style="color: var(--navy); margin-bottom: 0.5rem;">Are you sure?</h2>
            <p id="confirm-msg" style="color: #666; font-size: 0.95rem; margin-bottom: 2rem; line-height: 1.6;">
                Warning text goes here.
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button onclick="closeConfirmModal()"
                    style="background: white; border: 1px solid #ccc; color: #555; padding: 12px; border-radius: 30px; font-weight: 600; cursor: pointer;">
                    Cancel
                </button>
                <button id="confirm-btn-yes"
                    style="background: #d32f2f; border: none; color: white; padding: 12px; border-radius: 30px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);">
                    Yes, Delete
                </button>
            </div>
        </div>
    </div>

    <div id="toast-container"
        style="position: fixed; bottom: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px;">
    </div>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script type="module">
        // 1. IMPORTS (VERIFIED & CLEAN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

        // ðŸ‘‡ This checks all your imports are correct and includes 'where', 'getDocs', 'increment'
        import {
            getFirestore, collection, addDoc, onSnapshot, query, orderBy,
            deleteDoc, doc, updateDoc, getDoc, serverTimestamp, setDoc, increment,
            where, getDocs
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        import {
            getAuth, GoogleAuthProvider, signInWithPopup, signOut,
            onAuthStateChanged, RecaptchaVerifier, signInWithPhoneNumber
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyADbFSo1XZA78Sj-ooJ7Av8tDxbctS-Qws",
            authDomain: "silvercareprototype.firebaseapp.com",
            projectId: "silvercareprototype",
            storageBucket: "silvercareprototype.firebasestorage.app",
            messagingSenderId: "695863800030",
            appId: "1:695863800030:web:751cb3b0d536464957924f"
        };

        const app = initializeApp(firebaseConfig);
        // ... (Your code continues below as normal)
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- STATE VARIABLES ---
        let currentUser = null;
        let currentUserData = null; // Stores user profile (payment status, etc.)
        let allNurses = [];
        let allAgencies = []; // ðŸ‘ˆ Add this new variable
        let allLogs = [];
        let currentStream = null;
        let currentNurseId = null;
        let currentCalDate = new Date(); // Tracks the calendar month
        let allPayouts = []; // Stores list of paid months

        // Unsubscribe functions
        let unsubscribeUserDoc = null;
        let unsubscribeNurses = null;
        let unsubscribeLogs = null;
        let unsubscribeBookings = null;

        // ==========================================
        // ðŸ” AUTH & GATEKEEPER LOGIC
        // ==========================================

        onAuthStateChanged(auth, (user) => {
            const landingPage = document.getElementById('public-landing');
            const dashboard = document.querySelector('.app-container');
            const loginOverlay = document.getElementById('login-overlay');
            const nameSpan = document.getElementById('admin-name');

            if (user) {
                // LOGGED IN
                console.log("User Logged In:", user.uid);
                currentUser = user;

                // UI Updates
                landingPage.style.display = 'none';
                loginOverlay.style.display = 'none';
                dashboard.style.display = 'grid';
                nameSpan.innerText = user.displayName ? user.displayName.split(' ')[0] : 'Admin';

                // 1. Check if Super Admin
                checkAdminAccess(user);

                // 2. Start Gatekeeper (Checks Payment -> Then Loads Data)
                setupGatekeeper(user.uid);

            } else {
                // LOGGED OUT
                console.log("User Logged Out");
                currentUser = null;
                currentUserData = null;

                // UI Updates
                landingPage.style.display = 'flex';
                dashboard.style.display = 'none';
                loginOverlay.style.display = 'none';

                // Hide Modals
                document.getElementById('modal-onboarding').style.display = 'none';
                document.getElementById('modal-payment-lock').style.display = 'none';

                // Detach Listeners
                if (unsubscribeUserDoc) unsubscribeUserDoc();
                if (unsubscribeNurses) unsubscribeNurses();
                if (unsubscribeLogs) unsubscribeLogs();
                if (unsubscribeBookings) unsubscribeBookings();

                // Clear Data
                allNurses = [];
                allLogs = [];
                renderStaffList();
                renderDashboardLogs();
            }
        });

        // --- ðŸ—“ï¸ VALIDITY CHECKER SYSTEM (Step 3) ---
        let expiredNursesList = []; // Stores IDs of nurses who need payment

        async function checkNurseValidity(uid) {
            const q = collection(db, "users", uid, "nurses");
            const snapshot = await getDocs(q);

            expiredNursesList = [];
            const now = Date.now();
            const msPerDay = 24 * 60 * 60 * 1000;

            snapshot.forEach(docSnap => {
                const n = docSnap.data();
                // Give old data a 7-day grace period
                const expiry = n.validUntil || (now + (7 * msPerDay));

                if (expiry < now) {
                    expiredNursesList.push({ id: docSnap.id, name: n.name });
                }
            });

            if (expiredNursesList.length > 0) {
                showRenewalModal(expiredNursesList);
            } else {
                const lockModal = document.getElementById('modal-payment-lock');
                if (lockModal) lockModal.style.display = 'none';
            }
        }

        // --- UPDATED: Renewal Modal with Individual Delete Option ---
        function showRenewalModal(expiredList) {
            const modal = document.getElementById('modal-payment-lock');
            const title = document.querySelector('#payment-form-section h2');
            const desc = document.querySelector('#payment-form-section p');
            const input = document.getElementById('slot-quantity');
            const payBtn = document.getElementById('rzp-button');
            const backBtn = document.getElementById('btn-pay-later');

            if (!modal) return;
            modal.style.display = 'flex';

            if (title) {
                title.innerText = "âš ï¸ Membership Expired";
                title.style.color = "#d32f2f";
            }

            if (desc) {
                // Create a list of nurses with a "Delete & Stop Paying" button for each
                let listHtml = `<div style="text-align:left; margin-top:15px; border-top:1px solid #eee; padding-top:10px; max-height:200px; overflow-y:auto;">`;

                expiredList.forEach(nurse => {
                    listHtml += `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background:#fff5f5; padding:10px; border-radius:10px; border:1px solid #ffebee;">
                <div>
                    <span style="font-size:0.9rem; font-weight:600; color:#333; display:block;">${nurse.name}</span>
                    <span style="font-size:0.7rem; color:#d32f2f;">Expired</span>
                </div>
                <button onclick="window.removeNurseFromLock('${nurse.id}')" 
                        style="background:#ff4444; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:0.75rem; font-weight:600; transition:0.2s;">
                    <i class="fa-solid fa-trash"></i> Delete
                </button>
            </div>`;
                });

                listHtml += `</div>`;

                desc.innerHTML = `Action required for <b>${expiredList.length} staff member(s)</b>. Pay to renew or delete to continue: ${listHtml}`;
            }

            if (input) {
                input.value = expiredList.length;
                input.disabled = true;
                if (window.calculateTotal) window.calculateTotal();
            }

            if (payBtn) payBtn.innerText = `Renew ${expiredList.length} Staff (30 Days)`;

            // Hide back button because renewal/cleanup is mandatory to access dashboard
            if (backBtn) backBtn.style.display = 'none';
        }

        // Function to delete staff directly from the Lock Screen
        window.removeNurseFromLock = async (id) => {
            if (confirm("Delete this staff member permanently? You won't have to pay for them, but their attendance data will be lost.")) {
                try {
                    // 1. Delete from Firebase
                    await deleteDoc(doc(db, "users", currentUser.uid, "nurses", id));

                    // 2. Decrement your agency's nurse count
                    await updateDoc(doc(db, "users", currentUser.uid), {
                        nurseCount: increment(-1)
                    });

                    // 3. Re-scan validity. If list is now empty, it hides the modal!
                    await checkNurseValidity(currentUser.uid);

                } catch (error) {
                    console.error("Removal Error:", error);
                    alert("Could not remove staff. Please try again.");
                }
            }
        };

        // --- THE GATEKEEPER (Step 3: Prepaid Validity Model) ---
        function setupGatekeeper(uid) {
            unsubscribeUserDoc = onSnapshot(doc(db, "users", uid), (docSnap) => {

                // 1. SUPER ADMIN BYPASS
                if (currentUser.email === "supercare655@gmail.com") {
                    document.getElementById('modal-onboarding').style.display = 'none';
                    document.getElementById('modal-payment-lock').style.display = 'none';
                    startDataSync(uid);
                    return;
                }

                // 2. HANDLE NEW USERS
                if (!docSnap.exists()) {
                    document.getElementById('modal-onboarding').style.display = 'flex';
                    return;
                }

                currentUserData = docSnap.data();

                // 3. CHECK ONBOARDING
                if (!currentUserData.agencyName) {
                    document.getElementById('modal-onboarding').style.display = 'flex';
                    return;
                } else {
                    document.getElementById('modal-onboarding').style.display = 'none';
                }

                // 4. CHECK PREPAID VALIDITY (New Model)
                // This scans all your nurses. If any are expired, it shows the Lock Screen.
                // It replaces the old "isPaid" and "Payment Pending" checks.
                if (typeof checkNurseValidity === 'function') {
                    checkNurseValidity(uid);
                }

                // 5. START DATA SYNC
                // We load data so the dashboard is ready as soon as they recharge.
                startDataSync(uid);
            });
        }
        // --- DATA SYNC (Loads Nurses/Logs/Payouts ONLY after Gatekeeper passes) ---
        function startDataSync(uid) {
            // Prevent duplicate listeners
            if (unsubscribeNurses) return;

            console.log("Starting Data Sync...");

            // 1. Nurses
            unsubscribeNurses = onSnapshot(collection(db, "users", uid, "nurses"), (snapshot) => {
                allNurses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStaffList();
                populateLoginSelect();
                // Check if the payroll view is active before recalculating to save resources
                if (document.getElementById('view-payroll').classList.contains('active-view')) {
                    window.calculatePayroll();
                }
                document.getElementById('stat-total').innerText = allNurses.length;
            });

            // 2. Attendance
            const attendanceRef = collection(db, "users", uid, "attendance");
            unsubscribeLogs = onSnapshot(query(attendanceRef, orderBy("timestamp", "desc")), (snapshot) => {
                allLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboardLogs();
                renderAllLogs();

                // Recalculate payroll if new logs come in
                if (document.getElementById('view-payroll').classList.contains('active-view')) {
                    window.calculatePayroll();
                }

                // Today's Stats
                const today = new Date().toDateString();
                const todayCount = allLogs.filter(l => new Date(l.timestamp).toDateString() === today).length;
                document.getElementById('stat-present').innerText = todayCount;
            });

            // 3. Bookings
            const bookingsRef = collection(db, "users", uid, "bookings");
            unsubscribeBookings = onSnapshot(query(bookingsRef, orderBy("timestamp", "desc")), (snapshot) => {
                const grid = document.getElementById('bookings-grid');
                grid.innerHTML = '';
                if (snapshot.empty) { grid.innerHTML = '<p style="color:#888;">No new bookings.</p>'; return; }

                snapshot.docs.forEach(doc => {
                    const b = doc.data();
                    grid.innerHTML += `
                    <div class="card" style="border-left: 5px solid #25D366;">
                        <h3><i class="fa-brands fa-whatsapp"></i> ${b.clientPhone}</h3>
                        <p style="font-size:0.9rem;"><b>Loc:</b> ${b.location}</p>
                        <p style="font-size:0.8rem; background:#f9f9f9; padding:5px;">"${b.patient_details || 'No details'}"</p>
                        <hr style="margin:10px 0; border:0; border-top:1px dashed #ddd;">
                        <span style="font-size:0.8rem; color:#888;">${new Date(b.timestamp).toLocaleTimeString()}</span>
                    </div>`;
                });
            });

            // 4. PAYOUTS (New: Needed for the Checkbox)
            const payoutsRef = collection(db, "users", uid, "payouts");
            // We don't need to unsubscribe from this strictly, but it helps sync the checkboxes
            onSnapshot(payoutsRef, (snapshot) => {
                // Store paid records (e.g., "nurseId_2025-12")
                allPayouts = snapshot.docs.map(doc => doc.id);

                // If the user is looking at the payroll screen, update the checkboxes instantly
                if (document.getElementById('view-payroll').classList.contains('active-view')) {
                    window.calculatePayroll();
                }
            });
        }

       // ==========================================
// ðŸ’° PRICING & PLAN LOGIC (Copy This Block)
// ==========================================

// 1. CONFIGURATION
const MONTHLY_RATE = 199;
const DAILY_RATE = 10;
let currentPlan = 'monthly'; // Default setting

// Initialize the order object so it's never undefined
let currentOrder = { 
    slots: 1, 
    totalPrice: 199, 
    type: 'monthly' 
};

// 2. THE MISSING FUNCTION: Switch Plan Logic
window.switchPlan = (plan) => {
    currentPlan = plan;
    
    // Get Elements
    const btnMonthly = document.getElementById('plan-monthly');
    const btnDaily = document.getElementById('plan-daily');
    const desc = document.getElementById('plan-desc');
    const rateTxt = document.getElementById('plan-rate');

    // Update UI Styles
    if (plan === 'monthly') {
        // Active: Monthly
        btnMonthly.style.background = 'white';
        btnMonthly.style.color = 'var(--navy)';
        btnMonthly.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
        
        // Inactive: Daily
        btnDaily.style.background = 'transparent';
        btnDaily.style.color = '#666';
        btnDaily.style.boxShadow = 'none';

        // Text Updates
        if(desc) desc.innerText = "Best for regular staff. Valid for 30 days.";
        if(rateTxt) rateTxt.innerHTML = `<span style="color:#138808; font-weight:bold;">â‚¹${MONTHLY_RATE} per slot</span>`;
        
    } else {
        // Active: Daily
        btnDaily.style.background = 'white';
        btnDaily.style.color = '#d32f2f'; // Red highlight
        btnDaily.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';

        // Inactive: Monthly
        btnMonthly.style.background = 'transparent';
        btnMonthly.style.color = '#666';
        btnMonthly.style.boxShadow = 'none';

        // Text Updates
        if(desc) desc.innerText = "For temporary/unscattered needs. Valid for 24 hours.";
        if(rateTxt) rateTxt.innerHTML = `<span style="color:#d32f2f; font-weight:bold;">â‚¹${DAILY_RATE} per pass</span>`;
    }

    // Recalculate Price Immediately
    window.calculateTotal();
};

// 3. UPDATED CALCULATOR
window.calculateTotal = () => {
    const input = document.getElementById('slot-quantity');
    if (!input) return;

    let qty = parseInt(input.value) || 1;
    if (qty < 1) qty = 1;

    // Use Rate based on the selected plan
    const rate = currentPlan === 'monthly' ? MONTHLY_RATE : DAILY_RATE;
    const finalPrice = qty * rate;

    // Update Global Order State (Critical for Payment)
    currentOrder = { 
        slots: qty, 
        totalPrice: finalPrice, 
        type: currentPlan // Stores 'monthly' or 'daily'
    };

    // Update Totals on Screen
    const billTotal = document.getElementById('bill-total');
    if(billTotal) billTotal.innerText = `â‚¹${finalPrice}`;
    
    // Update Button Text
    const btn = document.getElementById('rzp-button');
    if(btn) btn.innerText = `Pay â‚¹${finalPrice} & Activate`;
};

        // Helper Styles
        function highlightBadge(id) {
            const el = document.getElementById(id);
            if (el) { el.style.background = '#4caf50'; el.style.color = 'white'; el.style.fontWeight = 'bold'; }
        }
        function resetBadges() {
            ['badge-5', 'badge-10', 'badge-20'].forEach(id => {
                const el = document.getElementById(id);
                if (el) { el.style.background = '#eee'; el.style.color = '#999'; el.style.fontWeight = 'normal'; }
            });
        }

        // Initialize Modal
        window.initPricingModal = () => {
            const input = document.getElementById('slot-quantity');
            if (input) input.value = 1;
            calculateTotal(); // Run calculation for 1
        }

        // --- 1. UI HELPER: Updates the Green/Red Credit Text in Modal ---
window.updateCreditDisplay = () => {
    // A. Find out which plan is currently selected (Monthly or Daily)
    const radios = document.getElementsByName('staffPlan');
    let plan = 'monthly';
    for (const r of radios) { if (r.checked) plan = r.value; }
    
    // B. Update the Visual Selection (Orange Border)
    const optMonthly = document.getElementById('opt-monthly');
    const optDaily = document.getElementById('opt-daily');
    
    if (plan === 'monthly') {
        optMonthly.className = 'plan-option active';
        optDaily.className = 'plan-option';
    } else {
        optMonthly.className = 'plan-option';
        optDaily.className = 'plan-option active';
    }

    // C. Calculate Available Credits
    const statusTxt = document.getElementById('credit-status-text');
    
    // Monthly Math: (Total Paid Slots) - (Active Monthly Nurses)
    const extraSlots = currentUserData?.extraSlots || 0;
    // We filter so we don't count "Daily" nurses against your "Monthly" limit
    const usedSlots = allNurses.filter(n => !n.type || n.type === 'monthly').length; 
    const monthlyLeft = Math.max(0, extraSlots - usedSlots);
    
    // Daily Math: Just read the pass count
    const dailyPasses = currentUserData?.dailyPasses || 0;

    // D. Update the Text based on choice
    if (plan === 'monthly') {
        if (monthlyLeft > 0) {
            statusTxt.innerHTML = `<i class="fa-solid fa-circle-check" style="color:#138808;"></i> Available Slots: <b>${monthlyLeft}</b>`;
            statusTxt.style.color = '#138808';
            statusTxt.style.background = '#e8f5e9';
            statusTxt.style.borderColor = '#c8e6c9';
        } else {
            statusTxt.innerHTML = `<i class="fa-solid fa-circle-xmark" style="color:#d32f2f;"></i> Limit Reached. Purchase more slots.`;
            statusTxt.style.color = '#d32f2f';
            statusTxt.style.background = '#ffebee';
            statusTxt.style.borderColor = '#ffcdd2';
        }
    } else {
        if (dailyPasses > 0) {
            statusTxt.innerHTML = `<i class="fa-solid fa-ticket" style="color:#138808;"></i> Daily Passes: <b>${dailyPasses}</b>`;
            statusTxt.style.color = '#138808';
            statusTxt.style.background = '#e8f5e9';
            statusTxt.style.borderColor = '#c8e6c9';
        } else {
            statusTxt.innerHTML = `<i class="fa-solid fa-circle-xmark" style="color:#d32f2f;"></i> No Passes. Purchase Required (â‚¹10).`;
            statusTxt.style.color = '#d32f2f';
            statusTxt.style.background = '#ffebee';
            statusTxt.style.borderColor = '#ffcdd2';
        }
    }
};
// --- SMART TRIGGER: Handles New vs. Existing Users ---
window.openModal = (isOnboarding = false) => {
    // 1. Check if User is Active (Has paid at least once)
    const isPaidUser = currentUserData?.isPaid === true;
    
    // Fallback: If 'isPaid' is missing but they have history (legacy users)
    const hasHistory = (currentUserData?.extraSlots > 0) || 
                       (currentUserData?.dailyPasses > 0) || 
                       (allNurses.length > 0);

    const isActiveAccount = isPaidUser || hasHistory;

    // 2. LOGIC: New User vs Existing
    if (!isActiveAccount || isOnboarding) {
        // ðŸ›‘ CASE A: NEW USER (Not Active)
        // Don't show the form. Go straight to Payment/Activation.
        
        document.getElementById('addModal').classList.remove('active'); // Ensure form is closed
        document.getElementById('modal-payment-lock').style.display = 'flex';
        
        // Update Title for Context
        const payTitle = document.querySelector('#payment-form-section h2');
        if(payTitle) payTitle.innerText = "Activate Account";

        // Default to Monthly for first purchase
        if(window.switchPlan) window.switchPlan('monthly');
        
        return; // Stop here
    }

    // âœ… CASE B: EXISTING USER (Active)
    // Show the Add Form (They can see 'Buy More' inside if they have 0 credits)
    document.getElementById('addModal').classList.add('active');
    
    // 3. Auto-Select the Plan they have credits for
    const extraSlots = currentUserData?.extraSlots || 0;
    const usedSlots = allNurses.filter(n => !n.type || n.type === 'monthly').length;
    const monthlyLeft = Math.max(0, extraSlots - usedSlots);
    const dailyPasses = currentUserData?.dailyPasses || 0;
    
    const monthlyRadio = document.querySelector('input[value="monthly"]');
    const dailyRadio = document.querySelector('input[value="daily"]');
    
    if (monthlyLeft > 0) {
        if(monthlyRadio) { monthlyRadio.checked = true; monthlyRadio.click(); }
    } else if (dailyPasses > 0) {
        if(dailyRadio) { dailyRadio.checked = true; dailyRadio.click(); }
    } else {
        // If 0 credits, default to Monthly
        if(monthlyRadio) { monthlyRadio.checked = true; monthlyRadio.click(); }
    }

    // Refresh the Green/Red text
    if (typeof window.updateCreditDisplay === 'function') {
        window.updateCreditDisplay();
    }
};
        window.closeModal = () => document.getElementById('addModal').classList.remove('active');

        // --- FUNCTION: Razorpay Payment Trigger (Updated for Hybrid Model) ---
window.startRazorpayPayment = () => {
    // 1. Safety Check
    if (!currentOrder || !currentOrder.totalPrice) {
        alert("Error: Invalid order details. Please refresh and try again.");
        return;
    }

    // 2. Convert Price to Paise (Razorpay expects 100 for â‚¹1)
    // âœ… FIX: Use the actual calculated price
    const amountInPaise = 100;
    
    const options = {
        "key": "rzp_live_RulrnBRfeFkxjt", // âœ… Your Live Key
        "amount": amountInPaise,
        "currency": "INR",
        "name": "Silver Care",
        // âœ… FIX: Dynamic Description
        "description": `Payment for ${currentOrder.slots} ${currentOrder.type === 'daily' ? 'Daily Passes' : 'Monthly Slots'}`,
        "image": "https://silvercareprototype.web.app/icon.png",

        "handler": async function (response) {
            // --- SUCCESS HANDLER ---
            console.log("Payment Success:", response.razorpay_payment_id);

            const btn = document.getElementById('rzp-button');
            if (btn) {
                btn.innerText = "Activating Credits...";
                btn.disabled = true;
            }

            try {
                const userRef = doc(db, "users", currentUser.uid);
                const userSnap = await getDoc(userRef);
                const userData = userSnap.data();
                const referrerCode = userData.referralBy;

                // --- A. CREDIT UPDATE (The Core Fix) ---
                if (currentOrder.type === 'daily') {
                    // ðŸŸ  BUYING DAILY PASSES
                    await updateDoc(userRef, {
                        paymentRequest: {
                            status: 'approved',
                            amount: currentOrder.totalPrice,
                            method: 'razorpay',
                            transactionId: response.razorpay_payment_id,
                            paidAt: serverTimestamp(),
                            type: 'daily',
                            quantity: currentOrder.slots
                        },
                        dailyPasses: increment(currentOrder.slots), // ðŸ‘ˆ Adds Daily Passes
                        lastPaymentId: response.razorpay_payment_id
                    });
                } else {
                    // ðŸ”µ BUYING MONTHLY SLOTS (Standard)
                    await updateDoc(userRef, {
                        paymentRequest: {
                            status: 'approved',
                            amount: currentOrder.totalPrice,
                            method: 'razorpay',
                            transactionId: response.razorpay_payment_id,
                            paidAt: serverTimestamp(),
                            type: 'monthly',
                            slotsPurchased: currentOrder.slots
                        },
                        isPaid: true,
                        extraSlots: increment(currentOrder.slots), // ðŸ‘ˆ Adds Monthly Slots
                        lastPaymentId: response.razorpay_payment_id
                    });

                    // Legacy Renewal Logic (Only for Monthly)
                    if (typeof expiredNursesList !== 'undefined' && expiredNursesList.length > 0) {
                        const days30 = 30 * 24 * 60 * 60 * 1000;
                        const renewalPromises = expiredNursesList.map(nurse => {
                            const nurseRef = doc(db, "users", currentUser.uid, "nurses", nurse.id);
                            return updateDoc(nurseRef, { validUntil: Date.now() + days30 });
                        });
                        await Promise.all(renewalPromises);
                        expiredNursesList = [];
                    }
                }

                // --- B. INTERN SALES TRACKING ---
                if (referrerCode && referrerCode !== "DIRECT") {
                    const q = query(collection(db, "users"), where("agencyName", "==", referrerCode));
                    const internSnap = await getDocs(q);

                    if (!internSnap.empty) {
                        internSnap.forEach(async (internDoc) => {
                            await updateDoc(doc(db, "users", internDoc.id), {
                                sales: increment(1),
                                totalRevenue: increment(currentOrder.totalPrice)
                            });
                        });
                    }
                }

                // --- C. SUCCESS UI ---
                alert(`âœ… Payment Successful! ${currentOrder.slots} ${currentOrder.type === 'daily' ? 'Daily Passes' : 'Monthly Slots'} added.`);
                document.getElementById('modal-payment-lock').style.display = 'none';

                // Refresh the Add Modal Credits Display immediately
                if (typeof window.updateCreditDisplay === 'function') {
                    window.updateCreditDisplay();
                }

                // Reload data
                if (currentUser) startDataSync(currentUser.uid);

            } catch (error) {
                console.error("Activation Error:", error);
                alert("Payment received but update failed. ID: " + response.razorpay_payment_id);
            }
        },
        "prefill": {
            "name": currentUser?.displayName || "",
            "email": currentUser?.email || "",
            "contact": currentUser?.phoneNumber || ""
        },
        "theme": {
            "color": "#ff9933"
        },
        "modal": {
            "ondismiss": function () {
                console.log('Payment cancelled');
            }
        }
    };

    const rzp1 = new Razorpay(options);
    rzp1.on('payment.failed', function (response) {
        alert("âŒ Payment Failed: " + response.error.description);
    });
    rzp1.open();
};
        // --- UPDATED ONBOARDING (Preserves Lead Logic + Auto-Payment) ---
        window.submitOnboarding = async () => {
            const agencyName = document.getElementById('inp-agency-name').value;
            let referralCode = document.getElementById('inp-referral-code').value;

            if (!agencyName) return alert("Enter Agency Name");

            // Normalize code to uppercase
            referralCode = referralCode ? referralCode.toUpperCase().trim() : "DIRECT";

            try {
                const btn = document.querySelector('#modal-onboarding .btn-primary');
                if (btn) btn.innerText = "Setting up...";

                // 1. Create/Update the Agency Profile
                await setDoc(doc(db, "users", currentUser.uid), {
                    agencyName: agencyName,
                    referralBy: referralCode,
                    email: currentUser.email,
                    createdAt: serverTimestamp(),
                    leadStatus: 'captured', // Mark so we don't count leads twice
                    nurseCount: 0,
                    extraSlots: 0
                }, { merge: true });

                // 2. INCREMENT INTERN LEAD COUNT (If code exists)
                if (referralCode !== "DIRECT") {
                    // Find the intern who owns this Agency Name/Code
                    const q = query(collection(db, "users"), where("agencyName", "==", referralCode));
                    const snapshot = await getDocs(q);

                    if (!snapshot.empty) {
                        snapshot.forEach(async (internDoc) => {
                            await updateDoc(doc(db, "users", internDoc.id), {
                                leads: increment(1) // ðŸŸ¢ +1 Lead instantly
                            });
                        });
                    }
                }

                // 3. Hide Modal & Refresh Admin Access
                document.getElementById('modal-onboarding').style.display = 'none';
                if (window.checkAdminAccess) window.checkAdminAccess(currentUser);

                // 4. ðŸ‘‡ TRIGGER PAYMENT SCREEN IMMEDIATELY ðŸ‘‡
                // Using 'true' ensures the user sees "Activate Your Account" 
                // without an unnecessary "Limit Reached" alert.
                setTimeout(() => {
                    if (typeof window.openModal === 'function') {
                        window.openModal(true);
                    }
                }, 500);

            } catch (e) {
                console.error("Onboarding Error:", e);
                alert("Error saving profile: " + e.message);
                const btn = document.querySelector('#modal-onboarding .btn-primary');
                if (btn) btn.innerText = "Continue";
            }
        };

        // --- FUNCTION: Close Payment Modal (Cancel/Skip) ---
        window.activatePayLater = () => {
            // 1. Hide the payment modal
            document.getElementById('modal-payment-lock').style.display = 'none';

            // 2. Ensure dashboard data is synced so the user can see their current staff
            if (currentUser) {
                startDataSync(currentUser.uid);
            }
        };

        // ==========================================
        // ðŸ‘‘ SUPER ADMIN LOGIC
        // ==========================================
        const SUPER_ADMIN_EMAIL = "supercare655@gmail.com";

        window.checkAdminAccess = (user) => {
            if (user.email === SUPER_ADMIN_EMAIL) {
                console.log("ðŸ‘‘ SUPER ADMIN");
                document.getElementById('nav-super-admin').style.display = 'flex';

                // Hide Payment/Onboarding Modals for Admin
                document.getElementById('modal-payment-lock').style.display = 'none';
                document.getElementById('modal-onboarding').style.display = 'none';

                // Hide normal nav items
                document.querySelectorAll('.nav-item:not(#nav-super-admin):not([onclick="logoutApp()"])')
                    .forEach(el => el.style.display = 'none');

                // Switch to Admin View
                switchTab('super-admin');
                loadAdminData();
            }
        }


        // --- UPDATED ADMIN LOADER (With Visual Slot Tracking & CSV Data Capture) ---
        function loadAdminData() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                const allTable = document.getElementById('admin-all-users');
                const leaderboardDiv = document.getElementById('admin-leaderboard');

                // âœ… CRITICAL CHANGE: Save data to global variable for CSV Export
                allAgencies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Clear existing data
                allTable.innerHTML = '';
                leaderboardDiv.innerHTML = '';

                // Optional: Clear the old 'pending table' if it exists in HTML
                const pendingTable = document.getElementById('admin-pending-table');
                if (pendingTable) pendingTable.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999; padding:20px;">Automated Payments Active (No Pending Actions)</td></tr>';

                let referralCounts = {};

                snapshot.docs.forEach(doc => {
                    const u = doc.data();

                    // --- 1. CALCULATE SLOTS (Used vs Paid) ---
                    const usedSlots = u.nurseCount || 0;
                    const paidSlots = u.extraSlots || 0;

                    // Calculate Percentage for the bar (cap at 100%)
                    let percentage = 0;
                    if (paidSlots > 0) percentage = Math.min((usedSlots / paidSlots) * 100, 100);

                    // Determine Bar Color (Green = Space Available, Orange = Full)
                    const barColor = usedSlots >= paidSlots ? '#e65100' : '#138808';

                    // Create the Display String
                    let slotDisplay = '';
                    if (u.plan === 'unlimited') {
                        slotDisplay = `<span style="color:#e65100; font-weight:bold;">ðŸ’Ž Unlimited</span>`;
                    } else {
                        slotDisplay = `
                <div style="font-size:0.85rem; font-weight:600; color:#333; margin-bottom:4px;">
                    ${usedSlots} / ${paidSlots} Slots Used
                </div>
                <div style="height:6px; width:100px; background:#e0e0e0; border-radius:3px; overflow:hidden;">
                    <div style="height:100%; width:${percentage}%; background:${barColor};"></div>
                </div>
            `;
                    }

                    // --- 2. LEADERBOARD AGGREGATION ---
                    if (u.referralBy && u.referralBy !== "DIRECT") {
                        if (!referralCounts[u.referralBy]) referralCounts[u.referralBy] = { total: 0, paid: 0 };
                        referralCounts[u.referralBy].total += 1;
                        if (u.isPaid) referralCounts[u.referralBy].paid += 1;
                    }

                    // --- 3. STATUS BADGE ---
                    let statusHtml = '<span style="color:#c62828; background:#ffebee; padding:4px 8px; border-radius:12px; font-size:0.7rem; font-weight:600;">LOCKED</span>';

                    if (u.isPaid) {
                        statusHtml = '<span style="color:#1b5e20; background:#e8f5e9; padding:4px 8px; border-radius:12px; font-size:0.7rem; font-weight:600;">PAID ACTIVE</span>';
                    }

                    // --- 4. RENDER ROW ---
                    allTable.innerHTML += `
        <tr style="border-bottom:1px solid #f0f0f0;">
            <td style="padding:15px 10px;">
                <div style="font-weight:bold; color:var(--navy); font-size:0.95rem;">${u.agencyName || 'Incomplete Profile'}</div>
                <div style="font-size:0.8rem; color:#666; margin-top:2px;">${u.email}</div>
            </td>
            <td style="padding:15px 10px;">
                ${slotDisplay}
            </td>
            <td style="padding:15px 10px; font-weight:500; color:#555;">
                ${u.referralBy || 'DIRECT'}
            </td>
            <td style="padding:15px 10px;">
                ${statusHtml}
            </td>
        </tr>`;
                });

                // --- 5. RENDER LEADERBOARD ---
                Object.keys(referralCounts).forEach(code => {
                    const data = referralCounts[code];
                    leaderboardDiv.innerHTML += `
        <div class="card stat-card" style="border-top: 4px solid ${data.paid > 0 ? '#138808' : '#999'}; padding:1rem;">
            <div style="font-size: 1.1rem; font-weight: bold; color:var(--navy);">${code}</div>
            <div style="display:flex; gap:10px; margin-top:12px;">
                <div style="flex:1; background:#f5f5f5; padding:8px; border-radius:8px; text-align:center;">
                    <div style="font-size:1.3rem; font-weight:700; color:#138808; line-height:1;">${data.paid}</div>
                    <div style="font-size:0.65rem; color:#666; font-weight:600; margin-top:4px;">SALES</div>
                </div>
                <div style="flex:1; background:#f5f5f5; padding:8px; border-radius:8px; text-align:center;">
                    <div style="font-size:1.3rem; font-weight:700; color:#333; line-height:1;">${data.total}</div>
                    <div style="font-size:0.65rem; color:#666; font-weight:600; margin-top:4px;">LEADS</div>
                </div>
            </div>
        </div>`;
                });
            });
        }


        window.exportToCSV = () => {
            // 1. Check if it is the Super Admin
            if (currentUser && currentUser.email === "supercare655@gmail.com") {

                if (!allAgencies || allAgencies.length === 0) {
                    alert("No agency data found to export.");
                    return;
                }

                // 2. Prepare Agency Data
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Agency Name,Email,Referral Code,Used Slots,Paid Slots,Status,Total Revenue (INR)\n";

                allAgencies.forEach(agency => {
                    const safeName = (agency.agencyName || "Unknown").replace(/,/g, " ");
                    const status = agency.isPaid ? "PAID ACTIVE" : "LOCKED";

                    // âœ… NEW MATH LOGIC:
                    // If they are paid, Revenue = Total Slots * 199. Otherwise 0.
                    const revenue = agency.isPaid ? (agency.extraSlots * 199) : 0;

                    const row = [
                        safeName,
                        agency.email,
                        agency.referralBy || "DIRECT",
                        agency.nurseCount || 0,
                        agency.extraSlots || 0,
                        status,
                        revenue // ðŸ‘ˆ Shows calculated amount (e.g., 1990)
                    ];
                    csvContent += row.join(",") + "\n";
                });

                // 3. Download File
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `SuperAdmin_Report_${new Date().toISOString().slice(0, 10)}.csv`);
                document.body.appendChild(link);
                link.click();
                link.remove();
                return;
            }

            // --- NORMAL USER EXPORT (Kept same as before) ---
            if (!allNurses || allNurses.length === 0) {
                alert("No staff data to export.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Name,Phone,Role,Daily Rate (INR),Status,Validity Expires\n";

            allNurses.forEach(nurse => {
                const now = Date.now();
                const days30 = 30 * 24 * 60 * 60 * 1000;
                const expiry = nurse.validUntil || (now + (7 * days30));
                const isExpired = expiry < now;

                const status = isExpired ? "Expired" : "Active";
                const expiryDate = new Date(expiry).toLocaleDateString();
                const safeName = nurse.name.replace(/,/g, " ");

                const row = [
                    safeName,
                    nurse.phone,
                    nurse.role,
                    nurse.rate,
                    status,
                    expiryDate
                ];
                csvContent += row.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `SilverCare_Staff_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            link.remove();
        };
        // ==========================================
        // ðŸ‘¤ PROFILE MODAL LOGIC (NEW)
        // ==========================================

        // ==========================================
        // ðŸ‘¤ PROFILE, TABS & CALENDAR LOGIC
        // ==========================================

        // 1. OPEN PROFILE
        window.openProfile = async (id) => {
            currentNurseId = id;
            const nurse = allNurses.find(n => n.id === id);
            if (!nurse) return;

            // Fill Info
            document.getElementById('p-name').innerText = nurse.name;
            document.getElementById('p-role').innerText = nurse.role;

            // Fill Edit Form
            document.getElementById('edit-id').value = nurse.id;
            document.getElementById('edit-name').value = nurse.name;
            document.getElementById('edit-phone').value = nurse.phone;
            document.getElementById('edit-rate').value = nurse.rate;
            document.getElementById('edit-role').value = nurse.role;

            // RESET Calendar to Today & Render
            currentCalDate = new Date();
            renderCalendar();

            // Load Docs
            loadDocuments(id);

            // Show Modal & Switch to first tab
            document.getElementById('profileModal').classList.add('active');
            window.switchProfileTab('attendance');
        };

        // 2. SWITCH TABS (Keep this!)
        window.switchProfileTab = (tab) => {
            // Reset buttons and content
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Activate clicked tab
            // Note: We search for the button that has the onclick handler for this specific tab
            const btn = Array.from(document.querySelectorAll('.tab-btn'))
                .find(b => b.getAttribute('onclick').includes(tab));

            if (btn) btn.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        };


        // CALENDAR LOGIC
        window.changeMonth = (offset) => {
            currentCalDate.setMonth(currentCalDate.getMonth() + offset);
            renderCalendar();
        };

        // NEW: Change Year
        window.changeYear = (offset) => {
            currentCalDate.setFullYear(currentCalDate.getFullYear() + offset);
            renderCalendar();
        };

        function renderCalendar() {
            const container = document.getElementById('cal-days-container');

            // Update Text
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('cal-month-text').innerText = monthNames[currentCalDate.getMonth()];
            document.getElementById('cal-year-text').innerText = currentCalDate.getFullYear();

            container.innerHTML = `
        <div class="cal-day-header">Sun</div><div class="cal-day-header">Mon</div>
        <div class="cal-day-header">Tue</div><div class="cal-day-header">Wed</div>
        <div class="cal-day-header">Thu</div><div class="cal-day-header">Fri</div>
        <div class="cal-day-header">Sat</div>
    `;

            const year = currentCalDate.getFullYear();
            const month = currentCalDate.getMonth();
            const firstDayIndex = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Get Presence Data
            const presentDays = allLogs
                .filter(l => l.nurseId === currentNurseId)
                .filter(l => {
                    const d = new Date(l.timestamp);
                    return d.getMonth() === month && d.getFullYear() === year;
                })
                .map(l => new Date(l.timestamp).getDate());

            const today = new Date();
            const isTodayMonth = today.getMonth() === month && today.getFullYear() === year;

            // Empty Slots
            for (let x = 0; x < firstDayIndex; x++) {
                const empty = document.createElement('div');
                empty.classList.add('cal-day', 'empty');
                container.appendChild(empty);
            }

            // Days
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('cal-day');
                dayEl.innerText = i;

                if (isTodayMonth && i === today.getDate()) dayEl.classList.add('today');

                if (presentDays.includes(i)) {
                    dayEl.classList.add('present');
                    dayEl.title = "Present";
                } else {
                    // Only mark absent if passed
                    let checkDate = new Date(year, month, i);
                    if (checkDate < new Date().setHours(0, 0, 0, 0)) {
                        dayEl.classList.add('absent');
                    }
                }
                container.appendChild(dayEl);
            }
        }
        // --- DOCUMENT LOCKER LOGIC ---
        async function loadDocuments(nurseId) {
            const list = document.getElementById('doc-list');
            list.innerHTML = '<p style="color:#999; text-align:center;">Loading...</p>';

            // Fetch Docs from Subcollection
            const q = query(collection(db, "users", currentUser.uid, "nurses", nurseId, "documents"), orderBy("uploadedAt", "desc"));
            const snapshot = await getDocs(q);

            list.innerHTML = '';
            if (snapshot.empty) {
                list.innerHTML = '<p style="color:#999; text-align:center; font-size:0.8rem; margin-top:10px;">No documents yet.</p>';
                return;
            }

            snapshot.forEach(docSnap => {
                const d = docSnap.data();
                list.innerHTML += `
        <div class="doc-item">
            <div class="doc-icon"><i class="fa-solid fa-file-contract"></i></div>
            <div style="flex:1; overflow:hidden;">
                <div style="font-weight:600; font-size:0.9rem;">${d.name}</div>
                <div style="font-size:0.7rem; color:#888;">${new Date(d.uploadedAt).toLocaleDateString()}</div>
            </div>
            <a href="${d.data}" download="${d.name}" style="color:var(--primary); margin-right:15px;"><i class="fa-solid fa-download"></i></a>
            <button onclick="window.deleteDoc('${docSnap.id}')" style="color:#ff4444; background:none; border:none; cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
        </div>`;
            });
        }

        // Upload Listener
        const uploadInput = document.getElementById('doc-upload');
        if (uploadInput) {
            uploadInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file || !currentNurseId) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const base64 = event.target.result;
                    await addDoc(collection(db, "users", currentUser.uid, "nurses", currentNurseId, "documents"), {
                        name: file.name,
                        data: base64,
                        uploadedAt: Date.now()
                    });
                    loadDocuments(currentNurseId); // Refresh UI
                };
                reader.readAsDataURL(file);
            });
        }

        window.deleteDoc = async (docId) => {
            if (confirm('Delete this document permanently?')) {
                await deleteDoc(doc(db, "users", currentUser.uid, "nurses", currentNurseId, "documents", docId));
                loadDocuments(currentNurseId);
            }
        };

        // --- EDIT PROFILE SUBMIT ---
        const editForm = document.getElementById('editNurseForm');
        if (editForm) {
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-id').value;

                await updateDoc(doc(db, "users", currentUser.uid, "nurses", id), {
                    name: document.getElementById('edit-name').value,
                    phone: document.getElementById('edit-phone').value,
                    rate: document.getElementById('edit-rate').value,
                    role: document.getElementById('edit-role').value
                });

                alert('Profile Updated Successfully!');
                // Update Modal Title instantly
                document.getElementById('p-name').innerText = document.getElementById('edit-name').value;
                document.getElementById('p-role').innerText = document.getElementById('edit-role').value;
            });
        }

        // ==========================================
        // ðŸ› ï¸ HELPER FUNCTIONS (Render, Camera, Etc)
        // ==========================================

        window.loginWithGoogle = () => {
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            signInWithPopup(auth, provider).catch(err => alert("Login Failed: " + err.message));
        };

        window.logoutApp = () => {
            signOut(auth).then(() => window.location.reload());
        };

        // Global State for Bulk Actions
        let isManageMode = false;
        let selectedNurses = new Set();

        // --- UPDATED VISUALS (Step 2: Show Days Left + Manage Mode + Replace) ---
        function renderStaffList() {
            const grid = document.getElementById('staff-grid');
            grid.innerHTML = '';

            const now = Date.now();
            const msPerDay = 24 * 60 * 60 * 1000;

            allNurses.forEach(nurse => {
                // Initials Logic
                const names = nurse.name.split(' ');
                const initials = names.length > 1 ? names[0][0] + names[1][0] : names[0][0];

                // ðŸ—“ï¸ MATH: Calculate Days Remaining
                // If 'validUntil' is missing (old data), give 7-day grace period
                const expiry = nurse.validUntil || (now + (7 * msPerDay));
                const daysLeft = Math.ceil((expiry - now) / msPerDay);

                // Color Logic for the Validity Text
                let statusColor = '#138808'; // Default Green (Safe)
                let statusText = `${daysLeft} Days Left`;

                if (daysLeft <= 0) {
                    statusColor = '#d32f2f'; // Red (Expired)
                    statusText = "EXPIRED";
                } else if (daysLeft <= 5) {
                    statusColor = '#ff9933'; // Orange (Warning)
                    statusText = `${daysLeft} Days (Renew Soon)`;
                }

                // CHECKBOX VISIBILITY LOGIC
                const checkDisplay = isManageMode ? 'flex' : 'none';
                const isChecked = selectedNurses.has(nurse.id) ? 'checked' : '';

                // Render the Card
                grid.innerHTML += `
        <div class="card nurse-card" style="display: flex; flex-direction: column; height: 100%; min-height: 280px; position: relative;">
            
            <div style="display: ${checkDisplay}; position: absolute; top: 10px; left: 10px; z-index: 10;">
                <input type="checkbox" style="width: 20px; height: 20px; accent-color: #d32f2f; cursor: pointer;" 
                    ${isChecked} onchange="toggleSelection('${nurse.id}')">
            </div>

            <div style="flex: 1;">
                <div style="position: absolute; top: 1rem; right: 1rem; display: flex; gap: 8px;">
                     <button onclick="openReplaceModal('${nurse.id}', '${nurse.name}', ${nurse.validUntil})" 
                        title="Replace Staff (Transfer Validity)"
                        style="background: #e3f2fd; color: #1565c0; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition:0.2s;">
                        <i class="fa-solid fa-arrow-right-arrow-left"></i>
                    </button>
                    
                    <button class="delete-btn" onclick="window.removeNurse('${nurse.id}')"
                        title="Delete Permanently"
                        style="position: static; opacity: 1; background: #ffebee; color: #c62828; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition:0.2s;">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>

                <div class="nurse-header" style="margin-top: 15px;">
                    <div class="nurse-avatar">${initials}</div>
                    <div class="nurse-info">
                        <h3>${nurse.name}</h3>
                        <p>${nurse.role}</p>
                    </div>
                </div>

                <div class="metrics-row">
                    <div class="metric">
                        <span class="metric-val">â‚¹${nurse.rate}</span>
                        <span class="metric-lbl">Daily Rate</span>
                    </div>
                    <div class="metric">
                        <span class="metric-val" style="color:${statusColor}; font-size:0.9rem;">
                            ${statusText}
                        </span>
                        <span class="metric-lbl">Validity</span>
                    </div>
                </div>
            </div>

            <button class="btn-profile" onclick="window.openProfile('${nurse.id}')" 
                style="margin-top: 20px; width: 100%; background: #e3f2fd; color: #1565c0; 
                       border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                <i class="fa-solid fa-address-card"></i> View Profile
            </button>
        </div>`;
            });
        }

        function populateLoginSelect() {
            const sel = document.getElementById('nurse-login-select');
            sel.innerHTML = '<option value="">-- Select Name --</option>';
            allNurses.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n.id;
                opt.innerText = n.name;
                sel.appendChild(opt);
            });
        }

        function renderDashboardLogs() {
            const grid = document.getElementById('dashboard-grid');
            grid.innerHTML = '';
            allLogs.slice(0, 3).forEach(log => {
                grid.innerHTML += createLogCard(log);
            });
        }

        function renderAllLogs() {
            const container = document.getElementById('logs-list-container');
            container.innerHTML = '';
            allLogs.forEach(log => {
                container.innerHTML += createLogCard(log);
            });
        }

        function createLogCard(log) {
            return `
            <div class="card" style="display:flex; gap:15px; align-items:center; padding:1rem;">
                <img src="${log.photo}" style="width:60px; height:60px; border-radius:50%; object-fit:cover; border:2px solid #eee;">
                <div>
                    <h4 style="color:var(--navy); margin-bottom:2px;">${log.nurseName}</h4>
                    <p style="font-size:0.8rem; color:#666;">${new Date(log.timestamp).toLocaleString()}</p>
                    <p style="font-size:0.8rem; color:var(--primary);"><i class="fa-solid fa-map-pin"></i> ${log.address || "GPS Only"}</p>
                </div>
            </div>`;
        }
        // Function to save the "Paid" status to Firebase
        window.togglePayout = async (nurseId, monthSuffix, isChecked) => {
            // Unique ID for this payment: "NurseID_MonthYear"
            const docId = `${nurseId}_${monthSuffix}`;
            const docRef = doc(db, "users", currentUser.uid, "payouts", docId);

            if (isChecked) {
                // Create the record
                await setDoc(docRef, {
                    paidAt: serverTimestamp(),
                    nurseId: nurseId,
                    month: monthSuffix
                });
            } else {
                // Delete the record (Uncheck)
                await deleteDoc(docRef);
            }
        };
        window.calculatePayroll = () => {
            const tbody = document.getElementById('payroll-table-body');
            const picker = document.getElementById('payroll-month-picker');

            tbody.innerHTML = '';
            let totalPayroll = 0;

            // 1. Get the target Month & Year from the picker
            let targetDate = picker.value ? new Date(picker.value + "-01") : new Date();

            // If picker was empty, set it to today
            if (!picker.value) {
                const yyyy = targetDate.getFullYear();
                const mm = String(targetDate.getMonth() + 1).padStart(2, '0');
                picker.value = `${yyyy}-${mm}`;
            }

            const tMonth = targetDate.getMonth();
            const tYear = targetDate.getFullYear();

            // Generate a unique key for this month (e.g., "2025-12")
            const monthKeySuffix = `${tYear}-${String(tMonth + 1).padStart(2, '0')}`;

            allNurses.forEach(nurse => {
                // 2. Count days worked in that specific month
                const daysWorked = allLogs.filter(l => {
                    const d = new Date(l.timestamp);
                    return l.nurseId === nurse.id && d.getMonth() === tMonth && d.getFullYear() === tYear;
                }).length;

                const salary = daysWorked * (parseInt(nurse.rate) || 0);
                totalPayroll += salary;

                // 3. CHECK STATUS: Is this nurse paid for this specific month?
                // We look for a key like: "nurseID_2025-12"
                const payoutId = `${nurse.id}_${monthKeySuffix}`;
                const isPaid = allPayouts.includes(payoutId);

                // 4. Render the Row with the Checkbox
                tbody.innerHTML += `
                    <tr>
                        <td><b>${nurse.name}</b></td>
                        <td>â‚¹${nurse.rate}</td>
                        <td>${daysWorked}</td>
                        <td style="color:var(--primary); font-weight:bold;">â‚¹${salary}</td>
                        <td style="text-align:center;">
                            <input type="checkbox" 
                                   class="paid-checkbox" 
                                   style="width: 20px; height: 20px; accent-color: #ff9933; cursor: pointer;"
                                   ${isPaid ? "checked" : ""} 
                                   onchange="togglePayout('${nurse.id}', '${monthKeySuffix}', this.checked)">
                        </td>
                    </tr>`;
            });
            document.getElementById('stat-payroll-total').innerText = 'â‚¹' + totalPayroll;
        };

        // --- CAMERA & LOCATION ---
        window.startCamera = async () => {
            try {
                const video = document.getElementById('video-feed');
                currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                video.srcObject = currentStream;
                getLocation();
            } catch (e) { alert("Camera Access Denied"); }
        };

        window.stopCamera = () => { if (currentStream) currentStream.getTracks().forEach(track => track.stop()); };

        window.getLocation = () => {
            const status = document.getElementById('location-status');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    status.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Finding Address...`;
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                        const data = await res.json();
                        window.currentLocation = { lat, lng, address: data.display_name.split(',').slice(0, 3).join(',') };
                        status.innerHTML = `<i class="fa-solid fa-check"></i> ${window.currentLocation.address}`;
                    } catch (e) { status.innerHTML = "GPS Recorded"; window.currentLocation = { lat, lng, address: "GPS Only" }; }
                });
            }
        };

        window.performCheckIn = async () => {
            if (!currentUser) return alert("Error: No User");
            const nurseId = document.getElementById('nurse-login-select').value;
            if (!nurseId) return alert("Select Name");

            const video = document.getElementById('video-feed');
            const canvas = document.getElementById('canvas-capture');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            await addDoc(collection(db, "users", currentUser.uid, "attendance"), {
                nurseId: nurseId,
                nurseName: allNurses.find(n => n.id === nurseId).name,
                timestamp: Date.now(),
                photo: canvas.toDataURL('image/jpeg', 0.5),
                address: window.currentLocation?.address || "Unknown"
            });
            alert("Check-in Success!");
            window.toggleMode();
        };

        // --- UPDATED FORM ACTIONS (Hybrid Model: Monthly vs Daily) ---
document.getElementById('addNurseForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    // 1. GET FORM VALUES
    // We look for the checked radio button to see which plan they chose
    const planType = document.querySelector('input[name="staffPlan"]:checked').value;
    const name = document.getElementById('nurseName').value;
    const phone = document.getElementById('nursePhone').value;
    const role = document.getElementById('nurseSpec').value;
    const rate = document.getElementById('nurseRate').value;

    // 2. CHECK CREDITS (Security Gate)
    // We calculate available monthly slots by subtracting used ones from total paid slots
    const extraSlots = currentUserData?.extraSlots || 0;
    const usedSlots = allNurses.filter(n => !n.type || n.type === 'monthly').length;
    const monthlyLeft = extraSlots - usedSlots;
    const dailyPasses = currentUserData?.dailyPasses || 0;

    // A. Block if no Monthly Slots
    if (planType === 'monthly' && monthlyLeft <= 0) {
        alert("âš ï¸ No Monthly Slots Available!\n\nPlease purchase more slots to add permanent staff.");
        if (window.openPaymentModal) window.openPaymentModal('monthly'); 
        return;
    }
    
    // B. Block if no Daily Passes
    if (planType === 'daily' && dailyPasses <= 0) {
        alert("âš ï¸ No Daily Passes Available!\n\nPlease purchase a Daily Pass (â‚¹10) to add temp staff.");
        if (window.openPaymentModal) window.openPaymentModal('daily');
        return;
    }

    // 3. CALCULATE EXPIRY DATE
    let expiryDate;
    if (planType === 'monthly') {
        // ðŸ—“ï¸ Monthly: Today + 30 Days
        expiryDate = Date.now() + (30 * 24 * 60 * 60 * 1000); 
    } else {
        // ðŸ—“ï¸ Daily: Today + 24 Hours
        expiryDate = Date.now() + (24 * 60 * 60 * 1000); 
    }

    try {
        // 4. ADD NURSE TO FIREBASE
        await addDoc(collection(db, "users", currentUser.uid, "nurses"), {
            name,
            phone,
            role,
            rate,
            timestamp: Date.now(),
            validUntil: expiryDate, // ðŸ‘ˆ Sets the correct time (30d or 24h)
            type: planType // ðŸ‘ˆ Tags them as 'monthly' or 'daily' so we can filter later
        });

        // 5. CONSUME THE CORRECT CREDIT
        if (planType === 'monthly') {
            // For Monthly, we increment the "Used Slot" counter
            await updateDoc(doc(db, "users", currentUser.uid), {
                nurseCount: increment(1)
            });
        } else {
            // For Daily, we directly REMOVE one pass
            await updateDoc(doc(db, "users", currentUser.uid), {
                dailyPasses: increment(-1)
            });
        }

        // 6. SUCCESS FEEDBACK
        alert(`âœ… Staff Added Successfully!\nValidity: ${planType === 'monthly' ? '30 Days' : '24 Hours'}`);
        window.closeModal();
        e.target.reset();

    } catch (err) {
        console.error("Error adding staff:", err);
        alert("Error saving data: " + err.message);
    }
});


        // --- 1. TOAST FUNCTION (Replaces alert) ---
        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            // Set Icon and Color
            const icon = type === 'success' ? '<i class="fa-solid fa-circle-check" style="color:#4caf50;"></i>' : '<i class="fa-solid fa-circle-xmark" style="color:#d32f2f;"></i>';
            const borderClass = type === 'success' ? '' : 'error';

            toast.className = `toast ${borderClass}`;
            toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div class="toast-msg">${message}</div>
    `;

            container.appendChild(toast);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        };

        // --- 2. CONFIRM MODAL LOGIC ---
        let confirmCallback = null;

        window.showConfirmDialog = (title, message, callback) => {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerHTML = message;

            confirmCallback = callback;
            document.getElementById('confirmModal').classList.add('active');
        };

        window.closeConfirmModal = () => {
            document.getElementById('confirmModal').classList.remove('active');
            confirmCallback = null;
        };

        // Bind the YES button
        document.getElementById('confirm-btn-yes').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            closeConfirmModal();
        });
// --- STRICT DELETE (No Refunds - "Buy Again" Model) ---
window.removeNurse = (id) => {
    // 1. Define the Warning Message
    const title = "Delete Staff?";
    const msg = `
        <strong style="color:#d32f2f;">Warning: Action cannot be undone.</strong><br>
        Deleting this staff member will remove them permanently.<br><br>
        <span style="font-size:0.85rem; background:#ffebee; padding:4px 8px; border-radius:4px; color:#c62828;">
           âš ï¸ You will <b>NOT</b> get the slot or pass back.
        </span>
    `;

    // 2. Trigger Custom Modal
    window.showConfirmDialog(title, msg, async () => {
        try {
            // A. Check the Nurse Type first
            const docRef = doc(db, "users", currentUser.uid, "nurses", id);
            const docSnap = await getDoc(docRef);
            
            if (!docSnap.exists()) {
                window.showToast("Error: Staff not found.", 'error');
                return;
            }
            
            const nurse = docSnap.data();
            const isMonthly = !nurse.type || nurse.type === 'monthly'; // Default to monthly

            // B. Delete the Document
            await deleteDoc(docRef);

            // C. Update Counters (BURN LOGIC)
            if (isMonthly) {
                // ðŸ”¥ Monthly: Burn the slot so they lose it (as per your request)
                await updateDoc(doc(db, "users", currentUser.uid), {
                    nurseCount: increment(-1), // Remove from active count
                    extraSlots: increment(-1)  // Remove from total limit (BURN)
                });
            } else {
                // ðŸŽ« Daily: Do NOTHING.
                // The pass was already subtracted when they added the nurse.
                // By not adding it back here, they effectively "lose" it and must buy again.
            }

            // D. Success Message
            window.showToast("Staff deleted. Validity consumed.");

        } catch (error) {
            console.error(error);
            window.showToast("Error deleting: " + error.message, 'error');
        }
    });
};

        // --- NAVIGATION ---
        let isNurseMode = false;
        window.toggleMode = () => {
            isNurseMode = !isNurseMode;
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active-view'));

            if (isNurseMode) {
                document.getElementById('view-nurse').classList.add('active-view');
                document.getElementById('mode-text').innerText = "Admin Dashboard";
                document.getElementById('admin-menu').style.display = 'none';
                window.startCamera();
            } else {
                document.getElementById('view-dashboard').classList.add('active-view');
                document.getElementById('mode-text').innerText = "Nurse App";
                document.getElementById('admin-menu').style.display = 'flex';
                window.stopCamera();
            }
        };

        window.switchTab = (tab) => {
            if (isNurseMode) return;
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const nav = document.getElementById(`nav-${tab}`);
            if (nav) nav.classList.add('active');

            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active-view'));
            const view = document.getElementById(`view-${tab}`);
            view.classList.add('active-view');

            // ðŸ‘‡ ADD THIS NEW BLOCK ðŸ‘‡
            // If opening Payroll, run calculation immediately to set default date
            if (tab === 'war-room') window.loadWarRoom();

            if (tab === 'payroll') {
                window.calculatePayroll();
            }
        };

        window.showLogin = () => {
            document.getElementById('public-landing').style.display = 'none';
            document.getElementById('login-overlay').style.display = 'flex';
        };


        // --- NEW FUNCTION: Show List of Present Nurses ---
        window.showPresentToday = () => {
            const today = new Date().toDateString();

            // 1. Get logs for today
            const todaysLogs = allLogs.filter(l => new Date(l.timestamp).toDateString() === today);

            // 2. Get unique names to avoid duplicates
            const names = [...new Set(todaysLogs.map(l => l.nurseName))];

            // 3. Show Alert with names
            if (names.length === 0) {
                alert("ðŸ“… No attendance marked today yet.");
            } else {
                alert(`âœ… Present Today (${names.length}):\n\nâ€¢ ` + names.join("\nâ€¢ "));
            }
        };
        // --- WAR ROOM LOGIC (Updated with Expiry Gatekeeper) ---
        let warRoomInterval = null;
        let unsubscribeWarRoom = null; // ðŸ‘ˆ Added to prevent memory leaks

        // Trigger this when switching to 'war-room' tab
        window.loadWarRoom = () => {
            // 1. GATEKEEPER CHECK: Don't show live data if staff are expired
            if (expiredNursesList.length > 0) {
                showRenewalModal(expiredNursesList);
                return;
            }

            // Stop any existing timer and listener to prevent duplicates
            if (warRoomInterval) clearInterval(warRoomInterval);
            if (unsubscribeWarRoom) unsubscribeWarRoom();

            // 2. QUERY: Listen to GLOBAL 'bookings' collection
            const q = query(
                collection(db, "bookings"),
                where("status", "in", ["assigned", "nurse_arrived", "in_progress"]),
                orderBy("timestamp", "desc")
            );

            unsubscribeWarRoom = onSnapshot(q, (snapshot) => {
                const grid = document.getElementById('war-room-grid');
                if (!grid) return;

                grid.innerHTML = '';

                if (snapshot.empty) {
                    grid.innerHTML = `
                <div class="empty-state">
                    <i class="fa-solid fa-mug-hot" style="font-size: 3rem; margin-bottom: 1rem; color:#ccc;"></i>
                    <h3>All Quiet</h3><p>No active nurses on the field right now.</p>
                </div>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const b = doc.data();
                    const status = b.status;

                    // TIMELINE STATES
                    const s1 = status === 'assigned' ? 'active' : 'done';
                    const s2 = status === 'nurse_arrived' ? 'active' : (status === 'in_progress' ? 'done' : '');
                    const s3 = status === 'in_progress' ? 'active' : '';

                    // TIMER LOGIC
                    let timerHtml = '<span style="color:#999; font-size:0.8rem;">Ready...</span>';
                    if (status === 'in_progress' && b.startedAt) {
                        timerHtml = `<div class="war-timer" data-start="${b.startedAt}">00h 00m 00s</div>`;
                    }

                    // MAP LINK
                    const mapLink = b.clientLocation
                        ? `https://www.google.com/maps?q=${b.clientLocation.lat},${b.clientLocation.lng}`
                        : '#';

                    grid.innerHTML += `
                <div class="war-card status-${status}">
                    <div class="war-header">
                        <div>
                            <h3 style="margin:0; color:var(--navy); font-size:1.1rem;">${b.assignedNurseName}</h3>
                            <span style="font-size:0.75rem; color:#666;">${b.assignedNursePhone}</span>
                        </div>
                        ${timerHtml}
                    </div>
                    <div class="war-body">
                        <div style="margin-bottom:15px;">
                            <div style="font-weight:600; font-size:0.85rem; margin-bottom:5px; color:#444;">Patient/Client:</div>
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                <a href="tel:${b.clientPhone}" class="client-pill">
                                    <i class="fa-solid fa-phone"></i> Call
                                </a>
                                <a href="${mapLink}" target="_blank" class="client-pill">
                                    <i class="fa-solid fa-location-arrow"></i> Map
                                </a>
                                <span class="client-pill" style="background:#f0f0f0; color:#333;">
                                    <i class="fa-solid fa-clock"></i> ${new Date(b.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                </span>
                            </div>
                        </div>
                        
                        <div style="background:#f9f9f9; padding:12px; border-radius:10px; border:1px solid #eee;">
                            <div class="war-step ${s1}"><i class="fa-solid fa-circle-check"></i> Dispatched</div>
                            <div class="war-step ${s2}"><i class="fa-solid fa-truck-fast"></i> At Location</div>
                            <div class="war-step ${s3}"><i class="fa-solid fa-heart-pulse"></i> <b>On Duty</b></div>
                        </div>
                    </div>
                </div>`;
                });

                // START LIVE CLOCK
                if (warRoomInterval) clearInterval(warRoomInterval);
                warRoomInterval = setInterval(updateWarTimers, 1000);
            });
        };

        function updateWarTimers() {
            document.querySelectorAll('.war-timer').forEach(el => {
                const start = parseInt(el.getAttribute('data-start'));
                if (!start) return;
                const diff = Date.now() - start;

                const hrs = Math.floor(diff / (1000 * 60 * 60));
                const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((diff % (1000 * 60)) / 1000);

                el.innerText = `${hrs}h ${mins}m ${secs}s`;
            });
        }
        // --- 1. MANAGE MODE TOGGLE ---
        window.toggleManageMode = () => {
            isManageMode = !isManageMode;
            selectedNurses.clear(); // Clear selections when toggling
            updateBulkUI();
            renderStaffList();
        };

        window.toggleSelection = (id) => {
            if (selectedNurses.has(id)) selectedNurses.delete(id);
            else selectedNurses.add(id);
            updateBulkUI();
        };

        function updateBulkUI() {
            const bar = document.getElementById('bulk-action-bar');
            const countSpan = document.getElementById('selected-count');

            if (isManageMode && selectedNurses.size > 0) {
                bar.style.display = 'flex';
                countSpan.innerText = selectedNurses.size;
            } else {
                bar.style.display = 'none';
            }
        }

        // --- 2. BULK DELETE LOGIC ---
        window.bulkDelete = async () => {
            if (!confirm(`Delete ${selectedNurses.size} staff members permanently?`)) return;

            try {
                const batchPromises = Array.from(selectedNurses).map(id =>
                    deleteDoc(doc(db, "users", currentUser.uid, "nurses", id))
                );

                await Promise.all(batchPromises);

                // Update Counter
                await updateDoc(doc(db, "users", currentUser.uid), {
                    nurseCount: increment(-selectedNurses.size)
                });

                alert("Selected staff deleted.");
                window.toggleManageMode(); // Exit manage mode

            } catch (e) {
                console.error(e);
                alert("Error deleting: " + e.message);
            }
        };

        // --- 3. REPLACE STAFF LOGIC (The Swap) ---
        window.openReplaceModal = (id, name, validUntil) => {
            // 1. Set the hidden ID
            const hiddenInput = document.getElementById('replace-old-id');
            if (hiddenInput) hiddenInput.value = id;

            // 2. Calculate Days Remaining
            const now = Date.now();
            const msPerDay = 24 * 60 * 60 * 1000;
            // Handle case where validUntil might be undefined (legacy data)
            const targetDate = validUntil || (now + (7 * msPerDay));
            const daysLeft = Math.ceil((targetDate - now) / msPerDay);

            // 3. Build the Message HTML
            const displayHtml = `
        You are replacing <b style="color:var(--navy);">${name}</b>.<br>
        <span style="display:inline-block; margin-top:8px; color:#1565c0; background:#e3f2fd; padding:4px 8px; border-radius:4px; font-weight:600; font-size:0.85rem;">
            <i class="fa-solid fa-clock-rotate-left"></i> The new staff member will inherit <u>${daysLeft} Days</u> of validity.
        </span>
    `;

            // 4. âœ… SAFE UPDATE: Targets the correct ID 'replace-message'
            const msgBox = document.getElementById('replace-message');
            if (msgBox) {
                msgBox.innerHTML = displayHtml;
                document.getElementById('replaceModal').classList.add('active');
            } else {
                console.error("Error: Could not find element #replace-message. Please check your HTML.");
            }
        };

       // --- SMART REPLACE (Preserves Plan Type) ---
document.getElementById('replaceNurseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const oldId = document.getElementById('replace-old-id').value;
    const btn = e.target.querySelector('button');
    btn.innerText = "Swapping...";

    try {
        // 1. Get Old Data (We need the Validity AND the Type)
        const oldDocRef = doc(db, "users", currentUser.uid, "nurses", oldId);
        const oldSnap = await getDoc(oldDocRef);
        
        if (!oldSnap.exists()) throw new Error("Original staff not found.");
        const oldData = oldSnap.data();

        // 2. Add New Nurse (Inherit Validity & Type)
        await addDoc(collection(db, "users", currentUser.uid, "nurses"), {
            name: document.getElementById('repName').value,
            phone: document.getElementById('repPhone').value,
            role: document.getElementById('repRole').value,
            rate: document.getElementById('repRate').value,
            timestamp: Date.now(),
            
            // ðŸ›‘ CRITICAL: Copy both fields!
            validUntil: oldData.validUntil, 
            type: oldData.type || 'monthly' // Defaults to monthly if missing
        });

        // 3. Delete Old Nurse
        await deleteDoc(oldDocRef);
        
        // No counter updates needed (One out, One in)

        alert("Staff Replaced Successfully!");
        document.getElementById('replaceModal').classList.remove('active');
        e.target.reset();

    } catch (error) {
        alert("Error: " + error.message);
    } finally {
        btn.innerHTML = '<i class="fa-solid fa-arrow-right-arrow-left"></i> Confirm Replacement';
    }
});
        // --- 4. REDIRECT HELPER ---
window.openPaymentModal = (preferredPlan) => {
    // Hide the add form
    document.getElementById('addModal').classList.remove('active');
    
    // Show the payment screen
    document.getElementById('modal-payment-lock').style.display = 'flex';
    
    // Auto-select the plan they need (Monthly or Daily)
    if (window.switchPlan) {
        window.switchPlan(preferredPlan);
    }
};
window.openPaymentFromForm = () => {
    // 1. Get current selection to know what they want to buy
    const planType = document.querySelector('input[name="staffPlan"]:checked').value;
    
    // 2. Hide Add Form
    document.getElementById('addModal').classList.remove('active');
    
    // 3. Open Payment Screen
    document.getElementById('modal-payment-lock').style.display = 'flex';
    
    // 4. Switch the store tab to match
    if(window.switchPlan) window.switchPlan(planType);
};
    </script>
</body>

</html>
